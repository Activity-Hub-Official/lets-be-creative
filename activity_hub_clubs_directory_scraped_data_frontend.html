<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Activity Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <!-- Tailwind (dev) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome 6 -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        fontFamily: { sans: ['Inter','ui-sans-serif','system-ui','Segoe UI','Arial'] },
        extend: {
          colors: {
            brand: {50:'#eef2ff',100:'#e0e7ff',200:'#c7d2fe',300:'#a5b4fc',400:'#818cf8',500:'#6366f1',600:'#4f46e5',700:'#4338ca',800:'#3730a3',900:'#312e81'}
          },
          boxShadow: { subtle: '0 1px 2px rgba(15,23,42,.06), 0 8px 24px rgba(15,23,42,.06)'},
          borderRadius: { xl:'0.875rem' }
        }
      }
    };
  </script>
  <style>
    :root{ color-scheme: light dark }
    html,body{ height:100% } body{ margin:0; overflow-x:hidden }
    img{ max-width:100%; height:auto; display:block }
    .no-scrollbar::-webkit-scrollbar{ display:none } .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none }
    .hscroll{ overflow-x:auto; -webkit-overflow-scrolling:touch; overscroll-behavior-x:contain }
    .cards-grid{ display:grid; gap:1.25rem; grid-template-columns:repeat(auto-fit,minmax(320px,1fr)) }
    .line-clamp-2{ display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden }

    /* Pills rail arrows */
    .pill-rail{ position:relative }
    .pill-nav{ position:absolute; top:50%; transform:translateY(-50%); width:36px; height:36px; border-radius:9999px; display:grid; place-items:center; z-index:10;
      background:rgba(255,255,255,.9); border:1px solid rgb(226 232 240); box-shadow:0 1px 2px rgba(15,23,42,.06), 0 8px 24px rgba(15,23,42,.06); backdrop-filter:saturate(1.1) blur(2px) }
    .pill-nav:hover{ background:#fff } .dark .pill-nav{ background:rgba(2,6,23,.9); border-color:rgb(51 65 85) } .dark .pill-nav:hover{ background:rgba(2,6,23,1) }

    /* Tabs */
    .tab-link{ display:inline-flex; align-items:center; gap:.5rem; height:40px; padding:0 .75rem; border-radius:.5rem; font-size:.9375rem; color:rgb(100 116 139) }
    .tab-link:hover{ background:rgba(15,23,42,.04) } .dark .tab-link:hover{ background:rgba(255,255,255,.05) }
    .tab-link[data-active="true"]{ color:rgb(15 23 42); font-weight:600; background:rgba(99,102,241,.12); outline:1px solid rgba(99,102,241,.35) }
    .dark .tab-link[data-active="true"]{ color:#fff; background:rgba(129,140,248,.16); outline-color:rgba(129,140,248,.45) }

    /* Sidebar */
    .side-link{ display:flex; align-items:center; gap:.6rem; width:100%; text-align:left; padding:.6rem .75rem; border-radius:.75rem; color:rgb(71 85 105) }
    .dark .side-link{ color:rgb(148 163 184) } .side-link:hover{ background:rgba(15,23,42,.04) } .dark .side-link:hover{ background:rgba(255,255,255,.05) }
    .side-link[data-active="true"]{ background:rgba(99,102,241,.12); color:rgb(49 46 129); outline:1px solid rgba(99,102,241,.35) }
    .dark .side-link[data-active="true"]{ color:#fff; background:rgba(129,140,248,.16); outline-color:rgba(129,140,248,.45) }

    /* Tokens */
    .token-pill{ display:inline-flex; align-items:center; gap:.4rem; height:24px; padding:0 .5rem; border-radius:.5rem; font-size:12px; background:rgba(99,102,241,.12); color:rgb(51,65,85); outline:1px solid rgba(99,102,241,.35) }
    .dark .token-pill{ color:#fff; background:rgba(129,140,248,.16); outline-color:rgba(129,140,248,.45) }
    .token-pill button{ width:18px; height:18px; display:grid; place-items:center; border-radius:.375rem }
    .token-pill button:hover{ background:rgba(15,23,42,.06) } .dark .token-pill button:hover{ background:rgba(255,255,255,.08) }

    /* Chips */
    .chip-btn{ display:inline-flex; align-items:center; gap:.4rem; height:28px; padding:0 .6rem; border-radius:.5rem; font-size:13px; border:1px solid rgb(226 232 240); color:rgb(71 85 105); background:#fff }
    .dark .chip-btn{ border-color:rgb(51 65 85); background:rgb(15 23 42); color:rgb(203 213 225) }
    .chip-btn:hover{ background:rgba(15,23,42,.04) } .dark .chip-btn:hover{ background:rgba(255,255,255,.05) }
    .chip-btn[data-selected="true"]{ color:rgb(49,46,129); background:rgba(99,102,241,.12); outline:1px solid rgba(99,102,241,.35) }
    .dark .chip-btn[data-selected="true"]{ color:#fff; background:rgba(129,140,248,.16); outline-color:rgba(129,140,248,.45) }

    /* Menus */
    .menu{ width:14rem; overflow:hidden; border-radius:.75rem; border:1px solid rgb(226 232 240); background:#fff; box-shadow:0 8px 24px rgba(15,23,42,.08) }
    .dark .menu{ border-color:rgb(51 65 85); background:rgb(15 23 42); box-shadow:0 8px 24px rgba(0,0,0,.35) }
    .menu .item{ display:flex; align-items:center; gap:.6rem; padding:.55rem .75rem; width:100%; text-align:left; font-size:.9375rem }
    .menu .item:hover{ background:rgba(15,23,42,.04) } .dark .menu .item:hover{ background:rgba(255,255,255,.06) }

    .dd-row{ display:flex; align-items:center; gap:.75rem; padding:.5rem .75rem; border-radius:.5rem; cursor:pointer }
    .dd-row:hover{ background:rgba(15,23,42,.04) } .dark .dd-row:hover{ background:rgba(255,255,255,.06) }
    .avatar-sm{ width:1.75rem; height:1.75rem; border-radius:.375rem; object-fit:cover } .avatar-fallback{ width:1.75rem; height:1.75rem; border-radius:.375rem; display:grid; place-items:center; font-size:.7rem }

    /* Share tiles */
    .share-scroller{ display:grid; grid-auto-flow:column; grid-auto-columns:120px; gap:1rem; align-items:start; justify-content:center; padding:.25rem .25rem .5rem }
    .share-tile{ position:relative; border-radius:14px; padding:.5rem .25rem .25rem; text-align:center; outline:none }
    .share-tile .overlay{ pointer-events:none; position:absolute; inset:0; border-radius:14px; opacity:0; transition:opacity .12s ease; background:rgba(15,23,42,.06); box-shadow:inset 0 0 0 1px rgba(100,116,139,.35) }
    .dark .share-tile .overlay{ background:rgba(255,255,255,.06); box-shadow:inset 0 0 0 1px rgba(51,65,85,.6) }
    .share-tile:hover .overlay,.share-tile:focus-visible .overlay{ opacity:1 }
    .circle{ width:4rem; height:4rem; border-radius:9999px; display:grid; place-items:center; font-size:1.1rem }
    .circle-img{ width:4rem; height:4rem; border-radius:9999px; object-fit:cover; border:1px solid rgba(100,116,139,.25) }

    .readmore-btn{ appearance:none; background:none; border:0; padding:0; margin-left:.25rem; color:rgb(79,70,229); font-weight:600; font-size:.95em; white-space:nowrap }
    .dark .readmore-btn{ color:rgb(165,180,252) }
    .readmore-btn:hover{ text-decoration:underline }
  </style>

<!-- Injected: Responsive Enhancements -->
<style id="ah-responsive-injected">
  /* Force single-column cards under 640px for common grid patterns */
  @media (max-width: 640px){
    /* Tailwind utilities override: ensure 1-up for typical grids */
    .cards-grid,
    .grid.grid-cols-2,
    .grid.sm\:grid-cols-2,
    .grid.md\:grid-cols-2,
    .grid.lg\:grid-cols-3 {
      grid-template-columns: 1fr !important;
    }
    /* Off-canvas sidebar */
    #sidebarPanel{
      position: fixed !important; left: 0; top: 0; bottom: 0;
      width: 100%; max-width: 100%;
      transform: translateX(-100%);
      transition: transform .25s ease;
      z-index: 50; background: transparent;
    }
    body.menu-open #sidebarPanel{ transform: translateX(0); }
    /* Backdrop fade-in */
    #menuBackdrop{ opacity: 0; transition: opacity .2s ease; }
    body.menu-open #menuBackdrop{ opacity: 1; pointer-events: auto; }
  }
  /* Avoid layout shift on images */
  img[loading="lazy"]{ content-visibility: auto; }

/* MOBILE-ONLY: hamburger & search buttons */
@media (min-width: 641px){
  #menuToggle, #mobileSearchOpen { display: none !important; }
}
@media (max-width: 640px){
  #menuToggle, #mobileSearchOpen { display: inline-flex !important; }
}

/* Full-page sidebar sheet look on mobile when open */
@media (max-width: 640px){
  #sidebarPanel{
    background: var(--sidebar-bg, #ffffff); 
    color: inherit;
    overflow-y: auto;
  }
  body.menu-open #sidebarPanel .sidebar-close{
    display: inline-flex !important;
  }
  #sidebarPanel .sidebar-close{
    position: absolute; top: .75rem; right: .75rem;
    width: 36px; height: 36px; border-radius: .5rem;
    border: 1px solid rgba(226,232,240,.8);
    align-items: center; justify-content: center;
    background: transparent;
    display: none; /* hidden until menu-open */
    z-index: 60;
  }
  #sidebarPanel .mobile-sheet-header{
    position: sticky; top: 0; z-index: 55;
    background: inherit;
    border-bottom: 1px solid rgba(226,232,240,.7);
    height: 48px; display: flex; align-items: center;
    padding: 0 .75rem; font-weight: 600; font-size: .9rem;
  }
}
</style>
</head>

<body class="bg-white text-slate-900 dark:bg-slate-950 dark:text-slate-100 min-h-screen">
  <!-- Header (banner + navbar) -->
  <div id="siteHeader" class="fixed inset-x-0 top-0 z-50">
    <!-- Solid banner -->
    <div id="betaBanner" class="bg-blue-600 text-white">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center gap-3 py-2">
          <p class="text-sm">
            <span class="font-semibold">You‚Äôre early ‚Äî thanks for being here!</span>
            We‚Äôre in open beta and shipping improvements every week.
            <a class="underline underline-offset-4 decoration-white/60 hover:decoration-white" href="#">Changelog</a> ¬∑
            <a class="underline underline-offset-4 decoration-white/60 hover:decoration-white" href="mailto:hello@example.com?subject=Activity%20Hub%20feedback">Share feedback</a>
          </p>
          <button id="betaDismiss" class="ml-auto h-8 w-8 inline-grid place-items-center rounded-lg hover:bg-white/15" aria-label="Dismiss"><i class="fa-solid fa-xmark"></i></button>
        </div>
      </div>
    </div>

    <!-- Translucent navbar -->
    <header id="navbar" class="border-b border-slate-200/70 dark:border-slate-800/70 backdrop-blur bg-white/80 dark:bg-slate-950/70">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-14 flex items-center gap-4">
        <!-- Brand -->
        <a href="./" class="flex items-center gap-3 group shrink-0" id="brandLink">
          <img id="brandLogo" src="https://i.imgur.com/7dO0mhL.png" alt="Activity Hub logo" class="w-9 h-9 rounded-md object-contain bg-white ring-1 ring-slate-200 dark:ring-slate-800"/>
          <div id="brandFallback" class="w-9 h-9 rounded-md bg-brand-600 text-white grid place-items-center font-semibold hidden">AH</div>
          <div class="text-base font-semibold tracking-tight group-hover:text-brand-600 transition-colors">Activity Hub</div>
        </a>

        <!-- Search -->
        <div class="flex-1 max-w-2xl">
          <div class="relative" id="searchWrap">
            <div id="searchBar" class="w-full h-9 rounded-lg border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 pl-2 pr-10 flex items-center gap-1">
              <div id="tokenRow" class="flex items-center gap-1"></div>
              <input id="searchInput" type="text" placeholder="Search clubs by name, theme, or industry" class="flex-1 h-full bg-transparent outline-none text-sm" autocomplete="off"/>
              <i id="searchIcon" class="fa-solid fa-magnifying-glass absolute right-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
            </div>
            <div id="searchDropdown" class="hidden absolute left-0 right-0 mt-2 z-50">
              <div class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 shadow-subtle overflow-hidden">
                <div id="searchDropdownInner" class="py-2"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Theme toggle -->
        <button id="toggleTheme" class="shrink-0 inline-flex items-center gap-2 h-9 px-3 rounded-lg border border-slate-200 dark:border-slate-800 text-sm hover:bg-slate-50 dark:hover:bg-slate-900" aria-label="Toggle theme"></button>
      </div>
    </header>
  </div>
  <div id="headerSpacer"></div>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Directory -->
    <section id="view-directory" class="space-y-6">
      <div class="grid md:grid-cols-12 gap-6">
        <!-- Sidebar -->
        <aside class="md:col-span-3">
          <div class="md:sticky" style="top: calc(var(--header-h) + 16px);">
            <div class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 p-3">
              <h2 class="px-2 pt-1 pb-2 text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Browse</h2>
              <nav id="sideNav" class="space-y-1">
                <button class="side-link" data-kind="organizations"><i class="fa-solid fa-building-columns"></i><span>Organizations</span></button>
                <button class="side-link" data-kind="businesses"><i class="fa-solid fa-store"></i><span>Businesses</span></button>
                <button class="side-link" data-kind="projects"><i class="fa-solid fa-diagram-project"></i><span>Projects</span></button>
                <div class="my-2 border-t border-slate-200 dark:border-slate-800"></div>
                <button id="getAppBtn" class="w-full inline-flex items-center justify-center gap-2 h-10 px-3 rounded-lg bg-brand-600 text-white hover:bg-brand-700">
                  <i class="fa-solid fa-mobile-screen-button"></i><span>Get the App</span>
                </button>
              </nav>
            </div>
          </div>
        </aside>

        <!-- Main -->
        <div class="md:col-span-9 space-y-6">
          <!-- Theme pills -->
          <div class="pill-rail -mx-1 px-1">
            <div id="pillScroller" class="hscroll no-scrollbar">
              <div id="themeChips" class="flex items-center gap-2 py-1"></div>
            </div>
            <button id="pillPrev" class="pill-nav hidden left-1" aria-label="Scroll left"><i class="fa-solid fa-chevron-left"></i></button>
            <button id="pillNext" class="pill-nav right-1" aria-label="Scroll right"><i class="fa-solid fa-chevron-right"></i></button>
          </div>

          <!-- Count + Sort -->
          <div class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white/90 dark:bg-slate-900/90 backdrop-blur px-3 py-2 flex items-center justify-between">
            <div class="text-sm text-slate-500 dark:text-slate-400"><span id="countLabel">0</span> results</div>
            <div class="relative">
              <button id="openSort" class="inline-flex items-center gap-2 h-11 px-3 rounded-xl border border-slate-200 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-900" aria-haspopup="menu" aria-expanded="false">
                <i id="sortIcon" class="fa-solid fa-wand-magic-sparkles"></i>
                <span id="sortLabel" class="hidden sm:inline">Sort: Relevance</span>
                <i class="fa-solid fa-chevron-down text-xs ml-1"></i>
              </button>
              <div id="sortMenu" class="menu absolute right-0 mt-2 hidden z-20">
                <button class="item sort-opt" data-sort="relevance"><i class="fa-solid fa-wand-magic-sparkles w-5 text-center"></i><span>Relevance</span><i class="fa-solid fa-check ml-auto hidden"></i></button>
                <button class="item sort-opt" data-sort="az"><i class="fa-solid fa-arrow-down-a-z w-5 text-center"></i><span>A ‚Üí Z</span><i class="fa-solid fa-check ml-auto hidden"></i></button>
                <button class="item sort-opt" data-sort="za"><i class="fa-solid fa-arrow-down-z-a w-5 text-center"></i><span>Z ‚Üí A</span><i class="fa-solid fa-check ml-auto hidden"></i></button>
                <button class="item sort-opt" data-sort="popular"><i class="fa-solid fa-fire w-5 text-center"></i><span>Popular</span><i class="fa-solid fa-check ml-auto hidden"></i></button>
                <button class="item sort-opt" data-sort="verified"><i class="fa-solid fa-circle-check w-5 text-center"></i><span>Verified first</span><i class="fa-solid fa-check ml-auto hidden"></i></button>
              </div>
            </div>
          </div>

          <div id="grid" class="cards-grid"></div>
          <p id="emptyState" class="hidden text-center py-16 text-slate-500 dark:text-slate-400">No items match your filters.</p>
          <p id="feedback" class="text-sm text-rose-600 dark:text-rose-400"></p>
        </div>
      </div>
    </section>

    <!-- Detail -->
    <section id="view-detail" class="hidden">
      <nav class="mb-6 text-sm">
        <a href="./" class="inline-flex items-center gap-1 text-brand-600 hover:underline" id="backToDirectory"><i class="fa-solid fa-arrow-left text-sm"></i> All clubs</a>
      </nav>

      <div class="grid md:grid-cols-3 gap-6">
        <div class="md:col-span-2 space-y-3">
          <!-- Header block -->
          <article class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 shadow-subtle">
            <div class="p-6 md:p-8">
              <div class="flex items-start gap-5">
                <img id="d_logo" class="w-20 h-20 rounded-xl object-cover ring-1 ring-slate-200 dark:ring-slate-800 hidden" alt="">
                <div id="d_plt" class="w-20 h-20 rounded-xl grid place-items-center text-white text-lg font-semibold ring-1 ring-slate-200 dark:ring-slate-800"></div>
                <div class="min-w-0 flex-1">
                  <div class="flex items-start justify-between gap-4">
                    <div class="min-w-0">
                      <h1 id="d_name" class="text-2xl font-semibold tracking-tight"></h1>
                      <div id="d_verified" class="mt-1 hidden"><span class="inline-flex items-center gap-1 text-sky-600 text-sm"><i class="fa-solid fa-circle-check"></i><span>Verified</span></span></div>
                      <div class="mt-2 flex flex-wrap gap-2">
                        <span id="d_theme" class="hidden inline-flex items-center text-[11px] px-2.5 py-1 rounded-full bg-slate-100 dark:bg-slate-800 border border-slate-200/60 dark:border-slate-700/60"></span>
                        <span id="d_industry" class="hidden inline-flex items-center text-[11px] px-2.5 py-1 rounded-full bg-slate-100 dark:bg-slate-800 border border-slate-200/60 dark:border-slate-700/60"></span>
                        <span id="d_members" class="hidden inline-flex items-center text-[11px] px-2.5 py-1 rounded-full bg-slate-100 dark:bg-slate-800 border border-slate-200/60 dark:border-slate-700/60"><i class="fa-solid fa-users text-[10px] mr-1"></i><span></span></span>
                      </div>
                    </div>
                    <button id="openShare" class="shrink-0 inline-flex items-center gap-2 h-9 px-3 rounded-lg border border-slate-200 dark:border-slate-800 text-sm hover:bg-slate-50 dark:hover:bg-slate-900"><i class="fa-solid fa-share-nodes"></i><span class="hidden sm:inline">Share</span></button>
                  </div>
                </div>
              </div>

              <div class="mt-6 pt-3 border-t border-slate-200 dark:border-slate-800">
                <div class="flex gap-2 flex-wrap" role="tablist">
                  <button class="tab-link" data-tab="overview" data-active="true" aria-selected="true"><i class="fa-solid fa-circle-info"></i><span>Overview</span></button>
                  <button class="tab-link" data-tab="events" data-active="false" aria-selected="false"><i class="fa-solid fa-calendar-days"></i><span>Events</span></button>
                  <button class="tab-link" data-tab="contact" data-active="false" aria-selected="false"><i class="fa-solid fa-envelope"></i><span>Contact</span></button>
                </div>
              </div>
            </div>
          </article>

          <!-- Content block -->
          <article class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 shadow-subtle">
            <div class="p-5 md:p-6">
              <section id="panel-overview">
                <h2 class="text-lg font-semibold mb-2">About us</h2>
                <p id="d_desc" class="text-[15px] leading-7 text-slate-700 dark:text-slate-300">
                  <span id="d_desc_text"></span><button id="d_desc_more" class="readmore-btn hidden" type="button" aria-expanded="false">Read more</button>
                </p>
              </section>
              <section id="panel-events" class="hidden">
                <h2 class="text-lg font-semibold mb-2">Events</h2>
                <p class="text-[15px] leading-7 text-slate-700 dark:text-slate-300">No events right now, but check back later‚Äîsomething exciting might be coming!</p>
              </section>
              <section id="panel-contact" class="hidden">
                <h2 class="text-lg font-semibold mb-3">Contact us</h2>
                <div id="d_emails" class="flex flex-wrap gap-2"></div>
                <h3 class="mt-5 font-medium">Forms</h3>
                <div id="d_forms" class="mt-2 flex flex-wrap gap-2"></div>
              </section>
            </div>
          </article>

          <!-- External Links block -->
          <article id="panel-links-card" class="hidden rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 shadow-subtle">
            <div class="p-5 md:p-6">
              <h2 class="text-lg font-semibold mb-2">External Links</h2>
              <div id="d_extlinks" class="flex flex-wrap gap-2"></div>
            </div>
          </article>
        </div>

        <!-- Recommendations -->
        <aside class="md:col-span-1">
          <div class="md:sticky md:top-24 space-y-3">
            <div class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 shadow-subtle p-4">
              <h2 id="recsTitle" class="text-base font-semibold mb-2">Orgs you may also like</h2>
              <div id="recsList" class="space-y-2"></div>
            </div>
          </div>
        </aside>
      </div>
    </section>
  </main>

  <!-- Share Modal -->
  <div id="shareModal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" data-close="share"></div>
    <div class="relative min-h-dvh grid place-items-center">
      <div class="w-full max-w-md px-4">
        <div class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 shadow-subtle p-6">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">Share</h3>
            <button id="shareClose" class="h-9 w-9 inline-grid place-items-center rounded-lg border border-slate-200 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800" aria-label="Close"><i class="fa-solid fa-xmark"></i></button>
          </div>
          <div class="mt-5 hscroll no-scrollbar">
            <div class="share-scroller" role="list">
              <button id="shareCopy" class="share-tile group" role="listitem" aria-label="Copy link">
                <span class="overlay"></span>
                <div class="circle mx-auto border border-slate-200 dark:border-slate-800"><i class="fa-solid fa-link"></i></div>
                <div class="mt-2 text-sm text-slate-700 dark:text-slate-300">Copy Link</div>
              </button>
              <a id="shareEmail" target="_blank" rel="noopener" class="share-tile group" role="listitem" aria-label="Share via Email">
                <span class="overlay"></span>
                <img alt="Email" src="https://i.imgur.com/cBOGtrb.png" class="circle-img mx-auto" loading="lazy"/>
                <div class="mt-2 text-sm text-slate-700 dark:text-slate-300">Email</div>
              </a>
              <a id="shareWhatsApp" target="_blank" rel="noopener" class="share-tile group" role="listitem" aria-label="Share on WhatsApp">
                <span class="overlay"></span>
                <img alt="WhatsApp" src="https://i.imgur.com/qOttODu.png" class="circle-img mx-auto" loading="lazy"/>
                <div class="mt-2 text-sm text-slate-700 dark:text-slate-300">WhatsApp</div>
              </a>
              <a id="shareLinkedIn" target="_blank" rel="noopener" class="share-tile group" role="listitem" aria-label="Share on LinkedIn">
                <span class="overlay"></span>
                <img alt="LinkedIn" src="https://i.imgur.com/PEw6T9z.png" class="circle-img mx-auto" loading="lazy"/>
                <div class="mt-2 text-sm text-slate-700 dark:text-slate-300">LinkedIn</div>
              </a>
              <a id="shareX" target="_blank" rel="noopener" class="share-tile group" role="listitem" aria-label="Share on X">
                <span class="overlay"></span>
                <img alt="X" src="https://i.imgur.com/PLQsGra.png" class="circle-img mx-auto" loading="lazy"/>
                <div class="mt-2 text-sm text-slate-700 dark:text-slate-300">X</div>
              </a>
            </div>
          </div>
          <div class="mt-4 text-center"><span id="shareCopied" class="text-sm text-emerald-600 hidden">Copied!</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters Modal -->
  <div id="filterModal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" data-close="filter"></div>
    <div class="relative mx-auto min-h-dvh grid place-items-center px-4">
      <div class="w-full max-w-lg">
        <div class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 shadow-subtle p-6">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">Filters</h3>
            <button id="filterClose" class="h-9 w-9 inline-grid place-items-center rounded-lg border border-slate-200 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800" aria-label="Close"><i class="fa-solid fa-xmark"></i></button>
          </div>
          <div class="mt-4">
            <label class="text-xs font-medium text-slate-500 dark:text-slate-400">Type</label>
            <div id="filterType" class="mt-2 flex flex-wrap gap-2">
              <button class="chip-btn" data-value="organizations">Orgs</button>
              <button class="chip-btn" data-value="businesses">Businesses</button>
              <button class="chip-btn" data-value="projects">Projects</button>
              <button class="chip-btn" data-value="global">Global</button>
            </div>
          </div>
          <div class="mt-4 grid sm:grid-cols-2 gap-4">
            <div>
              <label class="text-xs font-medium text-slate-500 dark:text-slate-400">Theme</label>
              <select id="filterTheme" class="mt-1 w-full h-11 rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 px-3"></select>
            </div>
            <div>
              <label class="text-xs font-medium text-slate-500 dark:text-slate-400">Industry</label>
              <select id="filterIndustry" class="mt-1 w-full h-11 rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 px-3">
                <option value="">All industries</option>
              </select>
            </div>
          </div>
          <div class="mt-6 flex items-center justify-between">
            <button id="filterClear" class="h-10 px-4 rounded-lg border border-slate-200 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800">Clear</button>
            <button id="filterApply" class="h-10 px-4 rounded-lg bg-brand-600 text-white hover:bg-brand-700">Apply</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Get the App Modal -->
  <div id="appModal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" data-close="app"></div>
    <div class="relative mx-auto min-h-dvh grid place-items-center px-4">
      <div class="w-full max-w-md">
        <div class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 shadow-subtle p-6">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">Mobile app ‚Äî almost ready</h3>
            <button id="appClose" class="h-9 w-9 inline-grid place-items-center rounded-lg border border-slate-200 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800" aria-label="Close"><i class="fa-solid fa-xmark"></i></button>
          </div>
          <p class="mt-3 text-sm text-slate-600 dark:text-slate-300">We‚Äôre putting the finishing touches on our iOS & Android app. Drop your email to be among the first to know when it launches.</p>
          <form id="appWaitlistForm" class="mt-4 space-y-3" novalidate>
            <div><label for="appEmail" class="sr-only">Email</label><input id="appEmail" type="email" required placeholder="you@example.com" class="w-full h-11 px-3 rounded-lg border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900"/></div>
            <button type="submit" id="appSubmit" class="w-full h-11 rounded-lg bg-brand-600 text-white hover:bg-brand-700 inline-flex items-center justify-center gap-2"><i class="fa-solid fa-bell"></i><span>Notify me</span></button>
            <p class="text-xs text-slate-500 dark:text-slate-400">No spam. We‚Äôll email you once ‚Äî when it‚Äôs live.</p>
          </form>
          <div id="appSuccess" class="hidden mt-4 text-emerald-600 text-sm">Thanks! You‚Äôre on the list. üéâ</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sample fallback -->
  <script id="sample-data" type="application/json">[
    {"name":"Actuarial Club","logo_url":"","description_preview":"The Actuarial Club aims to be a useful resource for actuarial science majors, hosting events, study groups and networking opportunities.","tagline":"Resource hub for aspiring actuaries","theme":"Professional Development","industry":"Finance","emails":"sjuactuarialclub@gmail.com","instagram":"https://www.instagram.com/sjuactuarial/","page_type":"Org","verified":"Yes","member_count":70},
    {"name":"Campus Coffee Co.","tagline":"Student-run pop-ups","theme":"Recreational","industry":"Food & Beverage","page_type":"Business","verified":"No"},
    {"name":"Green Dorm Dashboard","tagline":"Track energy usage","theme":"Academic","industry":"Sustainability","page_type":"project","verified":"No"}
  ]</script>

  <script>
  (function(){
    'use strict';

    // ---------- Config ----------
    var API_URL = "https://sheet2api.com/v1/ubMLioGAT8Gm/final-data";
    var DATA_URL = new URLSearchParams(location.search).get('src') || API_URL;

    var THEMES = ["Academic","Professional Development","Service / Volunteering","Recreational","Sports & Athletics","Religious / Spiritual","Cultural / Identity-Based","Arts & Media","Political / Activism"];
    var THEME_EMOJI = {"Academic":"üéì","Professional Development":"üíº","Service / Volunteering":"ü§ù","Recreational":"üéØ","Sports & Athletics":"üèÖ","Religious / Spiritual":"üïäÔ∏è","Cultural / Identity-Based":"üåç","Arts & Media":"üé®","Political / Activism":"üèõÔ∏è"};

    var RAW=[], VIEW=[], MAP=new Map(), CURRENT=null, ACTIVE_THEME="";
    var KIND = getKindFromParam() || 'organizations';
    var tokenKind = KIND, tokenTheme = "", tokenIndustry = "";
    var INDUSTRIES = [];

    var SORT_KEY='ah_sort_v1';
    var SORT = localStorage.getItem(SORT_KEY) || 'relevance';

    // ---------- Helpers ----------
    function $(s){ return document.querySelector(s); }
    function $all(s){ return Array.prototype.slice.call(document.querySelectorAll(s)); }
    function safe(s){ return (s==null?'':String(s)).trim(); }
    function slugify(s){ return safe(s).toLowerCase().replace(/&/g,' and ').replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,''); }
    function isValidHttpUrl(str){ try{ var u=new URL(str); return u.protocol==='http:'||u.protocol==='https:'; }catch(e){ return false; } }
    function extractUrls(str){ if(!str) return []; var m=String(str).match(/https?:\/\/[^\s|,]+/g); return m?Array.from(new Set(m)):[]; }
    function extractEmails(str){ if(!str) return []; var m=String(str).match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/ig); return m?Array.from(new Set(m)):[]; }
    function initials(name){ return safe(name).split(/\s+/).slice(0,3).map(function(p){return p[0];}).join('').toUpperCase(); }
    function escapeHtml(str){ return String(str==null?'':str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
    function hashCode(s){ var h=0; for(var i=0;i<s.length;i++){ h=(h<<5)-h + s.charCodeAt(i); h|=0; } return Math.abs(h); }
    function gradientForKey(key){ var h=hashCode(key||'seed')%360; var h2=(h+35)%360; return 'linear-gradient(135deg, hsl('+h+' 85% 52%), hsl('+h2+' 85% 46%))'; }
    function faBrand(type){ var map={instagram:'fa-instagram',twitter_x:'fa-x-twitter',facebook:'fa-facebook',tiktok:'fa-tiktok',youtube:'fa-youtube',linkedin:'fa-linkedin',discord:'fa-discord',groupme:'fa-user-group',linktree:'fa-link'}; return map[type]||'fa-link'; }
    var BRAND_SET = new Set(['fa-instagram','fa-x-twitter','fa-facebook','fa-tiktok','fa-youtube','fa-linkedin','fa-discord']);

    function normalizeKind(v){
      var s=safe(v).toLowerCase();
      if(/org/.test(s)) return 'organizations';
      if(/business|biz/.test(s)) return 'businesses';
      if(/project/.test(s)) return 'projects';
      return 'organizations';
    }
    var KIND_LABEL = { organizations:'Orgs', businesses:'Businesses', projects:'Projects' };

    function normalizeRow(row){
      var displayName = safe(row.org_name || row.name);
      var mc = safe(row.member_count);
      var n = {
        org_name: displayName,
        slug: slugify(displayName || ('id-'+Math.random().toString(36).slice(2))),
        logo_url: safe(row.logo_url),
        tagline: safe(row.tagline),
        theme: safe(row.theme),
        industry: safe(row.industry),
        school: safe(row.school),
        origin: safe(row.origin),
        kind: normalizeKind(row.page_type || row.type || 'org'),
        verified: /^y(es)?$/i.test(safe(row.verified)),
        member_count: mc ? (parseInt(mc,10) || null) : null,
        description: safe(row.description_preview),
        emails: extractEmails(row.emails),
        forms: extractUrls(row.forms),
        website: (extractUrls(row.website)[0] || safe(row.website)),
        instagram: extractUrls(row.instagram)[0]||"",
        twitter_x: extractUrls(row.twitter_x)[0]||"",
        facebook: extractUrls(row.facebook)[0]||"",
        tiktok: extractUrls(row.tiktok)[0]||"",
        youtube: extractUrls(row.youtube)[0]||"",
        linkedin: extractUrls(row.linkedin)[0]||"",
        discord: extractUrls(row.discord)[0]||"",
        groupme: extractUrls(row.groupme)[0]||"",
        linktree: extractUrls(row.linktree)[0]||""
      };
      n.hasLogo = !!n.logo_url;
      return n;
    }
    function normalizeAll(rows){
      var uniq=new Map();
      rows.forEach(function(r){
        var n=normalizeRow(r);
        if(!n.org_name) return;
        if(!uniq.has(n.slug)) uniq.set(n.slug,n);
      });
      return Array.from(uniq.values());
    }

    function chip(txt){ return '<span class="inline-flex items-center text-[11px] px-2.5 py-1 rounded-full bg-slate-100 dark:bg-slate-800 border border-slate-200/60 dark:border-slate-700/60">'+escapeHtml(txt)+'</span>'; }
    function verifiedBadgeSm(){ return '<span class="ml-1 align-middle text-sky-600" title="Verified"><i class="fa-solid fa-circle-check"></i></span>'; }

    // ---------- Theme pills ----------
    function buildThemeChips(){
      var wrap = $('#themeChips');
      function make(label){
        var value = label;
        var active = (ACTIVE_THEME===value);
        var emoji = value ? (THEME_EMOJI[value]||'üè∑Ô∏è') : '‚ú®';
        var text  = value || 'All';
        return '<button data-theme="'+escapeHtml(value)+'" class="inline-flex items-center gap-2 whitespace-nowrap h-9 px-3 rounded-lg border text-sm transition '+(active?'bg-slate-900 text-white border-slate-900 dark:bg-white dark:text-slate-900 dark:border-white':'border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 hover:bg-slate-50 dark:hover:bg-slate-800')+'" aria-pressed="'+(active?'true':'false')+'"><span>'+emoji+'</span><span>'+escapeHtml(text)+'</span></button>';
      }
      wrap.innerHTML = [make('')].concat(THEMES.map(make)).join('');
      $all('#themeChips button[data-theme]').forEach(function(btn){
        btn.addEventListener('click', function(){
          ACTIVE_THEME = btn.getAttribute('data-theme') || '';
          $('#filterTheme').value = ACTIVE_THEME;
          setThemeParam(ACTIVE_THEME);
          applyFilters();
          buildThemeChips();
          setTimeout(updatePillArrows, 0);
        });
      });
      setTimeout(updatePillArrows, 0);
    }
    function updatePillArrows(){
      var sc=$('#pillScroller'), prev=$('#pillPrev'), next=$('#pillNext');
      if(!sc){ return; }
      var max = sc.scrollWidth - sc.clientWidth;
      if(max<=2){ prev.classList.add('hidden'); next.classList.add('hidden'); return; }
      prev.classList.toggle('hidden', sc.scrollLeft<=2);
      next.classList.toggle('hidden', sc.scrollLeft>=max-2);
    }
    var pillsInitedOnce=false;
    function initPillScroller(){
      if(pillsInitedOnce){ updatePillArrows(); return; }
      pillsInitedOnce=true;
      var sc=$('#pillScroller'), prev=$('#pillPrev'), next=$('#pillNext');
      var STEP=320;
      prev.addEventListener('click',function(){ sc.scrollBy({left:-STEP,behavior:'smooth'}); });
      next.addEventListener('click',function(){ sc.scrollBy({left: STEP,behavior:'smooth'}); });
      sc.addEventListener('scroll',updatePillArrows,{passive:true}); window.addEventListener('resize',updatePillArrows);
      updatePillArrows();
    }

    // ---------- Cards ----------
    function card(org){
      var hasLogo = (org.logo_url && isValidHttpUrl(org.logo_url));
      var logoImg = hasLogo
        ? '<img class="w-14 h-14 rounded-xl object-cover ring-1 ring-slate-200 dark:ring-slate-800" src="'+escapeHtml(org.logo_url)+'" alt="'+escapeHtml(org.org_name)+' logo" onerror="this.style.display=\'none\'; this.nextElementSibling.classList.remove(\'hidden\');">'
        : '';
      var placeholder = '<div class="w-14 h-14 rounded-xl grid place-items-center shrink-0 ring-1 ring-slate-200 dark:ring-slate-800 '+(hasLogo?'hidden':'')+'" style="background:'+gradientForKey(org.slug)+';"><span class="text-sm font-semibold text-white">'+initials(org.org_name)+'</span></div>';
      var nameHtml = escapeHtml(org.org_name)+(org.verified ? ' '+verifiedBadgeSm() : '');
      var members = (org.member_count && isFinite(org.member_count))
        ? '<span class="inline-flex items-center text-[11px] px-2.5 py-1 rounded-full bg-slate-100 dark:bg-slate-800 border border-slate-200/60 dark:border-slate-700/60"><i class="fa-solid fa-users text-[10px] mr-1"></i>'+org.member_count+'</span>'
        : '';
      return '<a class="group block rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 p-4 shadow-subtle hover:shadow transition" href="?org='+org.slug+'" data-nav="'+org.slug+'"><div class="flex items-start gap-3">'+logoImg+placeholder+'<div class="min-w-0"><h3 class="text-[15px] font-semibold tracking-tight truncate group-hover:text-brand-600 transition-colors">'+nameHtml+'</h3>'+(org.tagline?'<p class="text-[13px] text-slate-500 dark:text-slate-400 mt-0.5 line-clamp-2">'+escapeHtml(org.tagline)+'</p>':'')+'<div class="mt-2 flex flex-wrap gap-2">'+(org.theme?chip(org.theme):'')+' '+(org.industry?chip(org.industry):'')+' '+members+'</div></div></div></a>';
    }
    function renderDirectory(list){
      var grid=$('#grid');
      if(!list.length){
        grid.innerHTML=''; $('#emptyState').classList.remove('hidden'); $('#countLabel').textContent='0'; return;
      }
      $('#emptyState').classList.add('hidden');
      grid.innerHTML=list.map(card).join('');
      $('#countLabel').textContent=String(list.length);
      $all('#grid [data-nav]').forEach(function(a){
        a.addEventListener('click',function(e){ e.preventDefault(); navigateToDetail(a.getAttribute('data-nav')); });
      });
    }

    function hydrateThemeSelect(){
      $('#filterTheme').innerHTML = '<option value="">All themes</option>'+THEMES.map(function(t){ return '<option value="'+escapeHtml(t)+'">'+escapeHtml(t)+'</option>'; }).join('');
    }
    function hydrateIndustrySelect(values){
      var opts = Array.from(new Set(values.filter(Boolean))).sort(function(a,b){ return a.localeCompare(b); });
      $('#filterIndustry').innerHTML = '<option value="">All industries</option>'+opts.map(function(v){ return '<option value="'+escapeHtml(v)+'">'+escapeHtml(v)+'</option>'; }).join('');
      INDUSTRIES = opts;
    }
    function setThemeParam(val){
      var url=new URL(location.href);
      if(val) url.searchParams.set('theme',slugify(val)); else url.searchParams.delete('theme');
      history.replaceState(history.state,'',url);
    }
    function findThemeBySlug(slug){ return THEMES.find(function(t){ return slugify(t)===slug; }) || ''; }
    function setKindParam(kind){
      var url=new URL(location.href);
      if(kind) url.searchParams.set('type',kind); else url.searchParams.delete('type');
      history.replaceState(history.state,'',url);
    }
    function getKindFromParam(){
      try{
        var k=new URL(location.href).searchParams.get('type');
        if(!k) return '';
        var one=k.toLowerCase();
        return (['organizations','businesses','projects'].indexOf(one)>-1?one:'');
      }catch(e){ return ''; }
    }

    // ---------- Sort ----------
    function renderSortButton(){
      var mapIcon = { relevance:'fa-wand-magic-sparkles', az:'fa-arrow-down-a-z', za:'fa-arrow-down-z-a', popular:'fa-fire', verified:'fa-circle-check' };
      $('#sortIcon').className = 'fa-solid '+(mapIcon[SORT]||'fa-wand-magic-sparkles');
      $('#sortLabel').textContent = 'Sort: ' + (SORT==='az'?'A ‚Üí Z':SORT==='za'?'Z ‚Üí A':SORT==='popular'?'Popular':SORT==='verified'?'Verified first':'Relevance');
      $all('#sortMenu .sort-opt').forEach(function(btn){
        var selected = btn.getAttribute('data-sort')===SORT;
        var check = btn.querySelector('.fa-check');
        if(check){ check.classList.toggle('hidden',!selected); }
      });
    }
    function setSort(v){
      SORT = v; localStorage.setItem(SORT_KEY,SORT);
      renderSortButton(); applyFilters(); closeSortMenu();
    }
    function scorePopular(o){
      var s=0; s+=(o.member_count||0)*2; s+=o.verified?50:0;
      var socials=['instagram','twitter_x','facebook','tiktok','youtube','linkedin','discord','groupme','linktree'];
      for(var i=0;i<socials.length;i++){ if(o[socials[i]]) s+=5; }
      return s;
    }
    function scoreRelevance(o,q){
      if(!q) return 0;
      var name=(o.org_name||'').toLowerCase(), theme=(o.theme||'').toLowerCase(), ind=(o.industry||'').toLowerCase();
      var s=0;
      if(name===q) s+=100;
      if(name.indexOf(q)===0) s+=40;
      if(name.indexOf(q)>-1) s+=20;
      if(theme.indexOf(q)>-1) s+=8;
      if(ind.indexOf(q)>-1) s+=6;
      if(o.verified) s+=2;
      s += Math.min((o.member_count||0),500)/250;
      return s;
    }
    function sortView(list){
      var q=$('#searchInput').value.trim().toLowerCase();
      var collator=new Intl.Collator(undefined,{sensitivity:'base'});
      var arr=list.slice();
      if(SORT==='az') arr.sort(function(a,b){ return collator.compare(a.org_name,b.org_name); });
      else if(SORT==='za') arr.sort(function(a,b){ return collator.compare(b.org_name,a.org_name); });
      else if(SORT==='verified') arr.sort(function(a,b){ return (b.verified - a.verified) || collator.compare(a.org_name,b.org_name); });
      else if(SORT==='popular') arr.sort(function(a,b){ return scorePopular(b)-scorePopular(a); });
      else { if(q){ arr.sort(function(a,b){ return scoreRelevance(b,q)-scoreRelevance(a,q); }); } else { arr.sort(function(a,b){ return collator.compare(a.org_name,b.org_name); }); } }
      return arr;
    }

    function emailChip(e){ return '<a href="mailto:'+escapeHtml(e)+'" class="inline-flex items-center gap-2 text-xs px-3 py-1.5 rounded-lg border border-slate-200 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-900"><i class="fa-solid fa-envelope"></i><span>'+escapeHtml(e)+'</span></a>'; }
    function formChip(u){ return '<a href="'+escapeHtml(u)+'" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 text-xs px-3 py-1.5 rounded-lg bg-brand-600 text-white hover:bg-brand-700"><i class="fa-solid fa-file-lines"></i><span>Form</span></a>'; }
    function socialLink(href,type,label){
      if(!href||!isValidHttpUrl(href)) return '';
      var names={instagram:'Instagram',twitter_x:'Twitter/X',facebook:'Facebook',tiktok:'TikTok',youtube:'YouTube',linkedin:'LinkedIn',discord:'Discord',groupme:'GroupMe',linktree:'Linktree',website:'Website'};
      var fa= type==='website' ? 'fa-globe' : faBrand(type);
      var prefix= type==='website' ? 'fa-solid' : (BRAND_SET.has(fa)?'fa-brands':'fa-solid');
      var title=(names[type]||label||'Link');
      return '<a href="'+escapeHtml(href)+'" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 text-xs px-3 py-1.5 rounded-lg border border-slate-200 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-900" aria-label="'+title+'"><i class="'+prefix+' '+fa+' fa-fw"></i><span class="hidden sm:inline">'+title+'</span></a>';
    }
    function socialRow(o){
      var arr=[];
      if(o.website) arr.push(socialLink(o.website,'website','Website'));
      arr.push(socialLink(o.instagram,'instagram','Instagram'));
      arr.push(socialLink(o.twitter_x,'twitter_x','Twitter/X'));
      arr.push(socialLink(o.facebook,'facebook','Facebook'));
      arr.push(socialLink(o.tiktok,'tiktok','TikTok'));
      arr.push(socialLink(o.youtube,'youtube','YouTube'));
      arr.push(socialLink(o.linkedin,'linkedin','LinkedIn'));
      arr.push(socialLink(o.discord,'discord','Discord'));
      arr.push(socialLink(o.groupme,'groupme','GroupMe'));
      arr.push(socialLink(o.linktree,'linktree','Linktree'));
      return arr.filter(Boolean).join('');
    }

    function recCardVertical(org){
      var hasLogo=(org.logo_url && isValidHttpUrl(org.logo_url));
      var logo= hasLogo
        ? '<img class="w-10 h-10 rounded-md object-cover ring-1 ring-slate-200 dark:ring-slate-800" src="'+escapeHtml(org.logo_url)+'" alt="'+escapeHtml(org.org_name)+' logo" onerror="this.style.display=\'none\'; this.nextElementSibling.classList.remove(\'hidden\');">'
        : '';
      var fallback = '<div class="w-10 h-10 rounded-md grid place-items-center shrink-0 ring-1 ring-slate-200 dark:ring-slate-800 '+(hasLogo?'hidden':'')+'" style="background:'+gradientForKey(org.slug)+';"><span class="text-[11px] font-semibold text-white">'+initials(org.org_name)+'</span></div>';
      var nameHtml = escapeHtml(org.org_name)+(org.verified ? ' '+verifiedBadgeSm() : '');
      return '<a class="group block rounded-lg border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 p-3 hover:shadow-subtle transition" href="?org='+org.slug+'" data-nav="'+org.slug+'"><div class="flex items-start gap-3">'+logo+fallback+'<div class="min-w-0"><div class="text-[13px] font-medium truncate group-hover:text-brand-600 transition-colors">'+nameHtml+'</div><div class="mt-1 flex flex-wrap gap-1">'+(org.theme?chip(org.theme):'')+' '+(org.industry?chip(org.industry):'')+'</div></div></div></a>';
    }
    function chooseRecommendations(current,k){
      var pool=RAW.filter(function(x){ return x.slug!==current.slug && x.kind===current.kind; });
      function score(o){
        var s=0;
        if(current.theme&&o.theme&&current.theme===o.theme) s+=3;
        if(current.industry&&o.industry&&current.industry===o.industry) s+=2;
        if(o.instagram||o.twitter_x||o.facebook||o.tiktok||o.youtube||o.linkedin||o.discord||o.groupme||o.linktree) s+=1;
        if(o.verified) s+=1;
        return s;
      }
      var ranked=pool.map(function(o){ return {o:o,s:score(o)}; }).sort(function(a,b){ return b.s-a.s; });
      var top=ranked.filter(function(x){ return x.s>0; }).slice(0,k).map(function(x){ return x.o; });
      if(top.length<k){
        var remain=pool.filter(function(x){ return top.indexOf(x)===-1; }).sort(function(a,b){ return a.org_name.localeCompare(b.org_name); });
        top=top.concat(remain.slice(0,k-top.length));
      }
      return top;
    }
    function renderRecommendations(current){
      var recs=chooseRecommendations(current,6);
      var list=$('#recsList');
      list.innerHTML=recs.map(recCardVertical).join('');
      $all('#recsList [data-nav]').forEach(function(a){
        a.addEventListener('click',function(e){ e.preventDefault(); navigateToDetail(a.getAttribute('data-nav')); });
      });
    }

    function activateTab(tab){
      $all('.tab-link').forEach(function(b){
        var active=b.getAttribute('data-tab')===tab;
        b.setAttribute('data-active', active?'true':'false');
        b.setAttribute('aria-selected', active?'true':'false');
      });
      var panels=[['overview','#panel-overview'],['events','#panel-events'],['contact','#panel-contact']];
      for(var i=0;i<panels.length;i++){
        var name=panels[i][0], sel=panels[i][1], el=$(sel);
        if(!el) continue;
        if(name===tab) el.classList.remove('hidden'); else el.classList.add('hidden');
      }
      var linksCard = $('#panel-links-card');
      if(linksCard){
        if(tab==='overview' && linksCard.getAttribute('data-has-links')==='true'){ linksCard.classList.remove('hidden'); }
        else { linksCard.classList.add('hidden'); }
      }
    }

    function setDescription(desc){
      var span=$('#d_desc_text'), btn=$('#d_desc_more');
      var limit=360;
      var full=(desc&&desc.trim())?desc.trim():'No description provided.';
      var needsMore = full.length>limit;
      function truncatedText(s){ var t=s.slice(0,limit); return t.replace(/\s+\S*$/,'')+'‚Ä¶'; }
      btn.setAttribute('data-expanded','false'); btn.setAttribute('aria-expanded','false');
      if(needsMore){
        span.textContent = truncatedText(full);
        btn.textContent = 'Read more';
        btn.classList.remove('hidden');
        btn.onclick=function(){
          var expanded = btn.getAttribute('data-expanded')==='true';
          if(expanded){
            span.textContent = truncatedText(full);
            btn.textContent = 'Read more';
            btn.setAttribute('data-expanded','false'); btn.setAttribute('aria-expanded','false');
          }else{
            span.textContent = full;
            btn.textContent = ' Show less';
            btn.setAttribute('data-expanded','true'); btn.setAttribute('aria-expanded','true');
          }
        };
      }else{
        span.textContent = full;
        btn.classList.add('hidden');
        btn.onclick=null;
      }
    }

    function renderDetail(slug){
      var org=MAP.get(slug); if(!org){ showDirectory(); return; }
      CURRENT=org; document.title=org.org_name+' ‚Äî Activity Hub';
      var recMap={ organizations:'Orgs you may also like', businesses:'Businesses you may also like', projects:'Projects you may also like' };
      var recsTitleEl=$('#recsTitle'); if(recsTitleEl){ recsTitleEl.textContent=recMap[org.kind]||'You may also like'; }

      var logo=$('#d_logo'), plt=$('#d_plt');
      if(org.logo_url && isValidHttpUrl(org.logo_url)){
        logo.src=org.logo_url; logo.alt=org.org_name+' logo'; logo.classList.remove('hidden'); plt.classList.add('hidden');
      }else{
        logo.classList.add('hidden'); plt.classList.remove('hidden'); plt.textContent=initials(org.org_name); plt.style.background=gradientForKey(org.slug);
      }

      $('#d_name').innerHTML = escapeHtml(org.org_name)+(org.verified?' '+verifiedBadgeSm():'');
      var dt=$('#d_theme'); dt.textContent=org.theme; dt.classList.toggle('hidden',!org.theme);
      var di=$('#d_industry'); di.textContent=org.industry; di.classList.toggle('hidden',!org.industry);
      var dm=$('#d_members');
      if(org.member_count){ dm.classList.remove('hidden'); dm.querySelector('span').textContent=org.member_count; } else { dm.classList.add('hidden'); }

      setDescription(org.description);

      var linksHtml=socialRow(org);
      var linksCard=$('#panel-links-card');
      var extList=$('#d_extlinks');
      if(linksHtml){ extList.innerHTML=linksHtml; linksCard.setAttribute('data-has-links','true'); }
      else { extList.innerHTML=''; linksCard.setAttribute('data-has-links','false'); }
      if($('.tab-link[data-tab="overview"]').getAttribute('data-active')==='true' && linksCard.getAttribute('data-has-links')==='true'){ linksCard.classList.remove('hidden'); } else { linksCard.classList.add('hidden'); }

      $('#d_forms').innerHTML=org.forms.slice(0,8).map(formChip).join('');
      $('#d_emails').innerHTML=org.emails.slice(0,8).map(emailChip).join('');

      $('#openShare').onclick=function(e){ e.preventDefault(); openShareModal(org); };

      $all('.tab-link').forEach(function(btn){ btn.onclick=function(){ activateTab(btn.getAttribute('data-tab')); }; });
      activateTab('overview');

      renderRecommendations(org);
      showDetail();
    }

    // ---------- Share modal ----------
    function openShareModal(org){
      var url=location.href, title=org.org_name+' ‚Äî Activity Hub';
      $('#shareWhatsApp').setAttribute('href','https://wa.me/?text='+encodeURIComponent(title+' '+url));
      $('#shareLinkedIn').setAttribute('href','https://www.linkedin.com/sharing/share-offsite/?url='+encodeURIComponent(url));
      $('#shareX').setAttribute('href','https://twitter.com/intent/tweet?text='+encodeURIComponent(title)+'&url='+encodeURIComponent(url));
      $('#shareEmail').setAttribute('href','mailto:?subject='+encodeURIComponent(title)+'&body='+encodeURIComponent(url));
      $('#shareCopied').classList.add('hidden');
      $('#shareModal').classList.remove('hidden');
      document.addEventListener('keydown', escShareOnce);
    }
    function closeShareModal(){ $('#shareModal').classList.add('hidden'); document.removeEventListener('keydown', escShareOnce); }
    function escShareOnce(e){ if(e.key==='Escape') closeShareModal(); }

    // ---------- Get App modal ----------
    function openAppModal(){ $('#appSuccess').classList.add('hidden'); $('#appWaitlistForm').classList.remove('hidden'); $('#appModal').classList.remove('hidden'); var em=$('#appEmail'); if(em) em.focus(); document.addEventListener('keydown', escAppOnce); }
    function closeAppModal(){ $('#appModal').classList.add('hidden'); document.removeEventListener('keydown', escAppOnce); }
    function escAppOnce(e){ if(e.key==='Escape') closeAppModal(); }
    function saveEmailToWaitlist(email){
      try{ var KEY='ah_app_waitlist_v1'; var arr=JSON.parse(localStorage.getItem(KEY)||'[]'); if(arr.indexOf(email)===-1) arr.push(email); localStorage.setItem(KEY,JSON.stringify(arr)); }catch(e){}
    }

    // ---------- Routing & data ----------
    function showDirectory(){ document.title='Activity Hub ‚Äî Clubs'; $('#view-directory').classList.remove('hidden'); $('#view-detail').classList.add('hidden'); CURRENT=null; }
    function showDetail(){ $('#view-directory').classList.add('hidden'); $('#view-detail').classList.remove('hidden'); }
    function navigateToDetail(slug){
      if(!MAP.has(slug)) return;
      var url=new URL(location.href); url.searchParams.set('org',slug); history.pushState({org:slug},'',url);
      renderDetail(slug);
    }
    function routeFromURL(){
      var url=new URL(location.href);
      var slug=url.searchParams.get('org');
      var themeSlug=url.searchParams.get('theme');
      var kindParam=getKindFromParam();

      if(kindParam){ KIND=kindParam; tokenKind=KIND; updateSideActive(); renderTokens(); }

      if(slug && MAP.has(slug)){ renderDetail(slug); return; }

      showDirectory();

      if(themeSlug){ var val=findThemeBySlug(themeSlug); $('#filterTheme').value=val; ACTIVE_THEME=val; setThemeParam(val); }

      renderDirectory(VIEW.length?VIEW:RAW);
      applyFilters(); updatePillArrows();
    }

    function fetchJson(url){ return fetch(url,{headers:{Accept:'application/json'}}).then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }); }

    function renderSkeletons(n){
      var grid=$('#grid'), arr=[], i;
      for(i=0;i<(n||9);i++){
        arr.push('<article class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 p-4 shadow-subtle animate-pulse"><div class="flex items-start gap-3"><div class="w-14 h-14 rounded-xl bg-slate-200 dark:bg-slate-800"></div><div class="flex-1 space-y-2"><div class="h-4 w-2/3 rounded bg-slate-200 dark:bg-slate-800"></div><div class="h-3 w-5/6 rounded bg-slate-200 dark:bg-slate-800"></div><div class="flex gap-2 pt-1"><div class="h-5 w-20 rounded-full bg-slate-200 dark:bg-slate-800"></div><div class="h-5 w-20 rounded-full bg-slate-200 dark:bg-slate-800"></div></div></div></div></article>');
      }
      grid.innerHTML = arr.join('');
    }

    function loadData(){
      renderSkeletons();
      fetchJson(DATA_URL).then(function(data){
        var rows=Array.isArray(data)?data:(data&&data.rows?data.rows:[]);
        RAW=normalizeAll(rows);
        if(!RAW.length) throw new Error('Empty dataset');
        MAP=new Map(RAW.map(function(x){ return [x.slug,x]; }));
        hydrateThemeSelect(); hydrateIndustrySelect(RAW.map(function(r){ return r.industry; }));
        VIEW=RAW.slice();
        routeFromURL(); buildThemeChips(); initPillScroller();
        if(!$('#searchDropdown').classList.contains('hidden')) renderSearchDropdown();
      }).catch(function(err){
        console.error('Data load failed, using sample:',err);
        RAW=normalizeAll(JSON.parse(document.getElementById('sample-data').textContent));
        MAP=new Map(RAW.map(function(x){ return [x.slug,x]; }));
        hydrateThemeSelect(); hydrateIndustrySelect(RAW.map(function(r){ return r.industry; }));
        VIEW=RAW.slice();
        routeFromURL(); buildThemeChips(); initPillScroller();
        $('#feedback').textContent='Live API failed ‚Äî showing sample data.';
        if(!$('#searchDropdown').classList.contains('hidden')) renderSearchDropdown();
      });
    }

    // ---------- Tokens / pills in search ----------
    function renderTokens(){
      var row=$('#tokenRow'), html='';
      if(tokenKind){ html+='<span class="token-pill" data-token="kind"><span>'+ (KIND_LABEL[tokenKind]||'Kind') +'</span><button class="rm" title="Remove"><i class="fa-solid fa-xmark text-xs"></i></button></span>'; }
      if(tokenTheme){ html+='<span class="token-pill" data-token="theme"><span>'+escapeHtml(tokenTheme)+'</span><button class="rm" title="Remove"><i class="fa-solid fa-xmark text-xs"></i></button></span>'; }
      if(tokenIndustry){ html+='<span class="token-pill" data-token="industry"><span>'+escapeHtml(tokenIndustry)+'</span><button class="rm" title="Remove"><i class="fa-solid fa-xmark text-xs"></i></button></span>'; }
      row.innerHTML=html;
      $all('#tokenRow .token-pill .rm').forEach(function(btn){
        btn.addEventListener('click', function(){
          var type = btn.closest('.token-pill').getAttribute('data-token');
          if(type==='kind'){ tokenKind=null; }
          if(type==='theme'){ tokenTheme=''; $('#filterTheme').value=''; ACTIVE_THEME=''; setThemeParam(''); buildThemeChips(); }
          if(type==='industry'){ tokenIndustry=''; $('#filterIndustry').value=''; }
          applyFilters(); renderTokens(); renderSearchDropdown();
        });
      });
    }
    function getEffectiveKindFilter(){
      var q=$('#searchInput').value.trim();
      var anyBarTokens = !!(tokenTheme || tokenIndustry);
      if(tokenKind) return tokenKind;
      if(q || anyBarTokens) return null;
      return KIND;
    }

    // ---------- Search dropdown ----------
    var RECENT_KEY='ah_recent_queries_v1';
    function getRecent(){ try{ return JSON.parse(localStorage.getItem(RECENT_KEY)||'[]'); }catch(e){ return []; } }
    function addRecent(q){
      var val=(q||'').trim(); if(!val) return;
      var arr=getRecent().filter(function(x){ return x.toLowerCase()!==val.toLowerCase(); });
      arr.unshift(val); if(arr.length>8) arr=arr.slice(0,8);
      localStorage.setItem(RECENT_KEY, JSON.stringify(arr));
    }
    function clearRecent(){ localStorage.removeItem(RECENT_KEY); }

    function bindClubClicks(scope){
      $all('.opt-club', scope).forEach(function(a){
        function act(){
          var slug=a.getAttribute('data-slug');
          var kind=a.getAttribute('data-kind');
          var org=MAP.get(slug);
          if(org) addRecent(org.org_name);
          if(kind && ['organizations','businesses','projects'].indexOf(kind)>-1){ KIND=kind; setKindParam(KIND); updateSideActive(); }
          closeSearchDropdown(); navigateToDetail(slug);
        }
        a.addEventListener('click', function(e){ e.preventDefault(); act(); });
        a.addEventListener('keydown', function(e){ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); act(); } });
      });
    }
    function clubRowItem(org){
      var hasLogo=(org.logo_url && isValidHttpUrl(org.logo_url));
      var logo = hasLogo
        ? '<img class="avatar-sm ring-1 ring-slate-200 dark:ring-slate-800" src="'+escapeHtml(org.logo_url)+'" alt="'+escapeHtml(org.org_name)+' logo" onerror="this.style.display=\'none\'; this.nextElementSibling.classList.remove(\'hidden\');">'
        : '';
      var fallback = '<div class="avatar-fallback text-white '+(hasLogo?'hidden':'')+'" style="background:'+gradientForKey(org.slug)+';">'+initials(org.org_name)+'</div>';
      var nameHtml = escapeHtml(org.org_name)+(org.verified?' '+verifiedBadgeSm():'');
      var sub = escapeHtml(org.theme||'')+((org.theme&&org.industry)?' ¬∑ ':'')+escapeHtml(org.industry||'');
      var badge = KIND_LABEL[org.kind]||'';
      return '<a class="dd-row opt-club" href="?org='+org.slug+'" data-slug="'+org.slug+'" data-kind="'+org.kind+'" role="option" tabindex="0" aria-label="'+escapeHtml(org.org_name)+'">'+logo+fallback+'<div class="min-w-0"><div class="text-sm font-medium truncate">'+nameHtml+'</div><div class="text-xs text-slate-500 dark:text-slate-400 truncate">'+sub+'</div></div><span class="ml-auto text-[11px] px-2 py-0.5 rounded bg-slate-100 dark:bg-slate-800 border border-slate-200/60 dark:border-slate-700/60">'+badge+'</span></a>';
    }
    function pickPopular(n){
      var kFilter=getEffectiveKindFilter();
      var pool=kFilter?RAW.filter(function(r){ return r.kind===kFilter; }):RAW;
      if(!pool.length) return [];
      var copy=pool.slice();
      for(var i=copy.length-1;i>0;i--){ var j=Math.floor(Math.random()*(i+1)); var tmp=copy[i]; copy[i]=copy[j]; copy[j]=tmp; }
      return copy.slice(0, n||6);
    }
    function renderSearchDropdown(){
      var dd=$('#searchDropdown'), inner=$('#searchDropdownInner'), q=$('#searchInput').value.trim().toLowerCase();
      if(q===''){
        var recent=getRecent(), popular=pickPopular(6), html='';
        if(recent.length){
          html+='<div class="px-3 pt-2 pb-1 flex items-center justify-between"><div class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Recent</div><button id="clearRecentBtn" class="text-xs text-slate-500 hover:text-slate-700 dark:hover:text-slate-200">Clear</button></div>';
          html+='<div class="px-2 pb-2 flex flex-wrap gap-2">'+recent.slice(0,3).map(function(r){ return '<button class="opt-recent inline-flex items-center gap-1.5 h-7 px-3 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-200 text-[13px]" data-q="'+escapeHtml(r)+'"><i class="fa-solid fa-clock-rotate-left"></i><span>'+escapeHtml(r)+'</span></button>'; }).join('')+'</div>';
        }
        html+='<div class="px-3 pt-2 pb-1 text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Popular</div>';
        html+='<div class="px-2 pb-2" role="group"><div class="divide-y divide-slate-200 dark:divide-slate-800 border-t border-b border-slate-200 dark:border-slate-800">'+popular.map(clubRowItem).join('')+'</div></div>';
        inner.innerHTML=html; dd.classList.remove('hidden');
        var clearBtn=$('#clearRecentBtn'); if(clearBtn){ clearBtn.onclick=function(){ clearRecent(); renderSearchDropdown(); }; }
        $all('.opt-recent', inner).forEach(function(b){
          b.onclick=function(){ var val=b.getAttribute('data-q')||''; $('#searchInput').value=val; addRecent(val); renderSearchDropdown(); }; // grid applies on Enter
        });
        bindClubClicks(inner);
      }else{
        var kFilter=tokenKind;
        var base=kFilter?RAW.filter(function(r){ return r.kind===kFilter; }):RAW;
        var results=base.filter(function(r){
          var nameMatch=r.org_name.toLowerCase().indexOf(q)>-1;
          var themeMatch=(r.theme||'').toLowerCase().indexOf(q)>-1;
          var indMatch=(r.industry||'').toLowerCase().indexOf(q)>-1;
          return nameMatch||themeMatch||indMatch;
        }).slice(0,10);
        var html2='<div class="px-3 pt-2 pb-1 text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Top matches</div>';
        html2+='<div class="px-2 pb-2 space-y-1" role="group">'+(results.length?results.map(clubRowItem).join(''):'<div class="px-3 py-2 text-sm text-slate-500 dark:text-slate-400">No matches.</div>')+'</div>';
        inner.innerHTML=html2; dd.classList.remove('hidden'); bindClubClicks(inner);
      }
    }
    function openSearchDropdown(){ $('#searchDropdown').classList.remove('hidden'); }
    function closeSearchDropdown(){ $('#searchDropdown').classList.add('hidden'); }
    function debounce(fn,delay){ var t; return function(){ var args=arguments; clearTimeout(t); t=setTimeout(function(){ fn.apply(null,args); },delay); }; }

    // ---------- Apply filters ----------
    function applyFilters(){
      var q=$('#searchInput').value.trim().toLowerCase();
      var themeToken=tokenTheme, industryToken=tokenIndustry;
      var modalTheme=$('#filterTheme').value, modalIndustry=$('#filterIndustry').value;
      var activeTheme=themeToken||modalTheme;
      var activeIndustry=industryToken||modalIndustry;
      var kindFilter=getEffectiveKindFilter();

      VIEW=RAW.filter(function(x){
        if(kindFilter && x.kind!==kindFilter) return false;
        if(q){
          var hay=(x.org_name+' '+(x.theme||'')+' '+(x.industry||'')).toLowerCase();
          if(hay.indexOf(q)===-1) return false;
        }
        if(activeTheme && x.theme!==activeTheme) return false;
        if(activeIndustry && x.industry!==activeIndustry) return false;
        return true;
      });
      VIEW = sortView(VIEW);
      renderDirectory(VIEW); buildThemeChips(); updateSideActive();
      $('#countLabel').textContent=String(VIEW.length);
    }

    // ---------- Sort menu ----------
    function openSortMenu(){ $('#sortMenu').classList.remove('hidden'); $('#openSort').setAttribute('aria-expanded','true'); }
    function closeSortMenu(){ $('#sortMenu').classList.add('hidden'); $('#openSort').setAttribute('aria-expanded','false'); }
    function initSortMenu(){
      var btn=$('#openSort'), menu=$('#sortMenu');
      btn.addEventListener('click',function(e){ e.stopPropagation(); if(menu.classList.contains('hidden')) openSortMenu(); else closeSortMenu(); });
      $all('#sortMenu .sort-opt').forEach(function(opt){ opt.addEventListener('click',function(){ setSort(opt.getAttribute('data-sort')); }); });
      document.addEventListener('click',function(e){ if(!menu.classList.contains('hidden') && !btn.contains(e.target) && !menu.contains(e.target)) closeSortMenu(); });
      document.addEventListener('keydown',function(e){ if(e.key==='Escape') closeSortMenu(); });
      renderSortButton();
    }

    // ---------- Sidebar ----------
    function updateSideActive(){ $all('#sideNav .side-link').forEach(function(b){ var active=(b.getAttribute('data-kind')===KIND); b.setAttribute('data-active', active?'true':'false'); }); }
    function initSidebar(){
      updateSideActive();
      $all('#sideNav .side-link').forEach(function(b){
        b.addEventListener('click', function(){
          var k=b.getAttribute('data-kind'); if(!k) return;
          if(KIND===k && tokenKind===k) return;
          KIND=k; tokenKind=k; setKindParam(KIND); renderTokens(); applyFilters(); renderSearchDropdown(); updateSideActive();
        });
      });
    }

    // ---------- Filters modal ----------
    function openFilterModal(){
      var typeVal=(tokenKind===null?'global':tokenKind);
      $all('#filterType .chip-btn').forEach(function(btn){ btn.setAttribute('data-selected', btn.getAttribute('data-value')===typeVal?'true':'false'); });
      $('#filterTheme').value = tokenTheme || ACTIVE_THEME || '';
      $('#filterIndustry').value = tokenIndustry || '';
      $('#filterModal').classList.remove('hidden');
    }
    function closeFilterModal(){ $('#filterModal').classList.add('hidden'); }

    // ---------- Layout helpers ----------
    function syncHeaderOffset(){
      var spacer=$('#headerSpacer'), header=$('#siteHeader');
      if(!spacer||!header) return;
      var h=header.getBoundingClientRect().height;
      spacer.style.height=h+'px';
      document.documentElement.style.setProperty('--header-h', h+'px');
    }
    function syncThemeButton(){
      var btn=$('#toggleTheme');
      var isDark=document.documentElement.classList.contains('dark');
      btn.innerHTML = isDark ? '<i class="fa-solid fa-sun"></i><span>Light</span>' : '<i class="fa-solid fa-moon"></i><span>Dark</span>';
    }

    // ---------- Boot ----------
    window.addEventListener('DOMContentLoaded', function(){
      // Brand logo fallback without optional chaining
      var brandLogo = document.getElementById('brandLogo');
      if(brandLogo){
        brandLogo.addEventListener('error', function(){
          brandLogo.style.display='none';
          var f=document.getElementById('brandFallback'); if(f){ f.classList.remove('hidden'); }
        });
      }

      var root=document.documentElement;
      var stored=localStorage.getItem('ah_theme')||'light';
      if(stored==='dark') root.classList.add('dark'); else root.classList.remove('dark');
      syncThemeButton();
      $('#toggleTheme').addEventListener('click', function(){
        root.classList.toggle('dark'); localStorage.setItem('ah_theme', root.classList.contains('dark')?'dark':'light'); syncThemeButton();
      });

      var BETA_KEY='ah_beta_banner_v1';
      if(localStorage.getItem(BETA_KEY)!=='1'){ $('#betaBanner').classList.remove('hidden'); }
      $('#betaDismiss').addEventListener('click', function(){ localStorage.setItem(BETA_KEY,'1'); $('#betaBanner').classList.add('hidden'); syncHeaderOffset(); });

      syncHeaderOffset(); window.addEventListener('resize', syncHeaderOffset);

      renderTokens();

      // Search interactions (grid updates only on Enter)
      var input=$('#searchInput'), wrap=$('#searchWrap'), icon=$('#searchIcon');

      function setIconMode(){
        var focused=(document.activeElement===input);
        if(focused){
          icon.classList.remove('fa-magnifying-glass'); icon.classList.add('fa-filter');
          icon.setAttribute('data-mode','filter'); icon.setAttribute('title','Open filters');
        }else{
          icon.classList.remove('fa-filter'); icon.classList.add('fa-magnifying-glass');
          icon.removeAttribute('data-mode'); icon.removeAttribute('title');
        }
      }

      input.addEventListener('focus', function(){ setIconMode(); renderSearchDropdown(); openSearchDropdown(); });
      input.addEventListener('keydown', function(e){
        if(e.key==='Backspace' && input.selectionStart===0 && input.selectionEnd===0 && input.value===''){
          var pills=Array.prototype.slice.call($('#tokenRow').children);
          if(pills.length){
            var last=pills[pills.length-1].getAttribute('data-token');
            if(last==='industry'){ tokenIndustry=''; $('#filterIndustry').value=''; }
            else if(last==='theme'){ tokenTheme=''; $('#filterTheme').value=''; ACTIVE_THEME=''; setThemeParam(''); buildThemeChips(); }
            else if(last==='kind'){ tokenKind=null; }
            renderTokens(); renderSearchDropdown(); // grid will update on Enter
            e.preventDefault();
          }
        }else if(e.key==='Enter'){
          var first=$('#searchDropdownInner .opt-club');
          var q=input.value.trim();
          if(first){
            var slug=first.getAttribute('data-slug');
            var kind=first.getAttribute('data-kind');
            var org=MAP.get(slug);
            if(org) addRecent(org.org_name);
            if(kind && ['organizations','businesses','projects'].indexOf(kind)>-1){ KIND=kind; setKindParam(KIND); updateSideActive(); }
            closeSearchDropdown(); navigateToDetail(slug);
          }else{
            if(q){ addRecent(q); }
            closeSearchDropdown(); applyFilters();
          }
        }else if(e.key==='Escape'){ closeSearchDropdown(); }
      });
      input.addEventListener('input', debounce(function(){ renderSearchDropdown(); }, 120));

      icon.addEventListener('mousedown', function(e){
        if(icon.getAttribute('data-mode')==='filter'){ e.preventDefault(); openFilterModal(); closeSearchDropdown(); }
      });

      document.addEventListener('click', function(e){ if(!wrap.contains(e.target)){ closeSearchDropdown(); setIconMode(); } });
      input.addEventListener('blur', function(){ setTimeout(setIconMode,80); });

      // Filters modal wiring
      var filtOverlay=document.querySelector('[data-close="filter"]'); if(filtOverlay){ filtOverlay.addEventListener('click', closeFilterModal); }
      var filtClose=$('#filterClose'); if(filtClose){ filtClose.addEventListener('click', closeFilterModal); }
      $all('#filterType .chip-btn').forEach(function(btn){ btn.addEventListener('click', function(){ $all('#filterType .chip-btn').forEach(function(b){ b.setAttribute('data-selected','false'); }); btn.setAttribute('data-selected','true'); }); });
      var filtClear=$('#filterClear'); if(filtClear){ filtClear.addEventListener('click', function(){ tokenKind=null; tokenTheme=''; tokenIndustry=''; $('#filterTheme').value=''; $('#filterIndustry').value=''; ACTIVE_THEME=''; setThemeParam(''); renderTokens(); buildThemeChips(); /* do not apply yet */ }); }
      var filtApply=$('#filterApply'); if(filtApply){ filtApply.addEventListener('click', function(){
        var typeBtn=$('#filterType .chip-btn[data-selected="true"]'); var typeVal=typeBtn?typeBtn.getAttribute('data-value'):null;
        if(typeVal==='global'){ tokenKind=null; } else if(typeVal){ tokenKind=typeVal; }
        tokenTheme=$('#filterTheme').value||''; tokenIndustry=$('#filterIndustry').value||'';
        ACTIVE_THEME=tokenTheme||''; setThemeParam(ACTIVE_THEME);
        renderTokens(); buildThemeChips(); applyFilters(); renderSearchDropdown(); closeFilterModal();
      }); }

      // Brand root click
      var brandLink=document.getElementById('brandLink');
      if(brandLink){ brandLink.addEventListener('click', function(e){ e.preventDefault(); var url=new URL(location.href); url.searchParams.delete('org'); history.pushState({},'',url); showDirectory(); renderDirectory(VIEW.length?VIEW:RAW); }); }
      var backDir=$('#backToDirectory');
      if(backDir){ backDir.addEventListener('click', function(e){ e.preventDefault(); var url=new URL(location.href); url.searchParams.delete('org'); history.pushState({},'',url); showDirectory(); renderDirectory(VIEW.length?VIEW:RAW); }); }
      window.addEventListener('popstate', routeFromURL);

      // Share modal
      var shareClose=$('#shareClose'); if(shareClose){ shareClose.addEventListener('click', closeShareModal); }
      var shareOverlay=document.querySelector('[data-close="share"]'); if(shareOverlay){ shareOverlay.addEventListener('click', closeShareModal); }
      var shareCopyBtn=$('#shareCopy'); if(shareCopyBtn){ shareCopyBtn.addEventListener('click', function(){ var toCopy=location.href; if(navigator.clipboard && navigator.clipboard.writeText){ navigator.clipboard.writeText(toCopy).then(function(){ var msg=$('#shareCopied'); msg.classList.remove('hidden'); setTimeout(function(){ msg.classList.add('hidden'); }, 1200); }); } }); }

      // Get App modal
      var getAppBtn=$('#getAppBtn'); if(getAppBtn){ getAppBtn.addEventListener('click', function(e){ e.preventDefault(); openAppModal(); }); }
      var appClose=$('#appClose'); if(appClose){ appClose.addEventListener('click', closeAppModal); }
      var appOverlay=document.querySelector('[data-close="app"]'); if(appOverlay){ appOverlay.addEventListener('click', closeAppModal); }
      var appForm=$('#appWaitlistForm'); if(appForm){ appForm.addEventListener('submit', function(e){ e.preventDefault(); var emailEl=$('#appEmail'); var email=(emailEl.value||'').trim(); var ok=/^\S+@\S+\.\S+$/.test(email); if(!ok){ emailEl.focus(); emailEl.classList.add('ring-2','ring-rose-500'); setTimeout(function(){ emailEl.classList.remove('ring-2','ring-rose-500'); },900); return; } saveEmailToWaitlist(email); appForm.classList.add('hidden'); $('#appSuccess').classList.remove('hidden'); }); }

      initSortMenu(); initSidebar(); loadData();
    });

  })();
  </script>

<!-- Injected: Mobile Backdrop and Search Overlay -->
<div id="menuBackdrop" class="fixed inset-0 bg-slate-900/50 pointer-events-none z-[49] sm:hidden" style="opacity:0;"></div>

<div id="mobileSearchOverlay" class="fixed inset-0 z-[60] hidden sm:hidden">
  <div class="absolute inset-0" style="background: rgba(2,6,23,.5)"></div>
  <div class="relative z-10 h-full w-full bg-white dark:bg-slate-950 flex flex-col">
    <div class="h-14 flex items-center justify-between px-3" style="border-bottom:1px solid rgba(226,232,240,.7)">
      <div class="text-sm font-medium">Search</div>
      <button id="mobileSearchClose" type="button" aria-label="Close search"
        class="inline-flex items-center justify-center w-9 h-9 rounded-lg"
        style="border:1px solid rgba(226,232,240,.7)">
        <span aria-hidden="true">‚úï</span>
      </button>
    </div>
    <div id="mobileSearchMount" class="p-3"></div>
    <div class="flex-1 overflow-y-auto"></div>
  </div>
</div>

<script id="ah-responsive-glue">
(function(){
  const $ = (s,sc)=> (sc||document).querySelector(s);
  const $$ = (s,sc)=> Array.from((sc||document).querySelectorAll(s));

  // 1) Identify a sidebar-like element and ensure it has #sidebarPanel
  (function ensureSidebarId(){
    if (document.getElementById('sidebarPanel')) return;
    const candidates = $$('aside, [data-sidebar], #sidebar, .sidebar');
    if (candidates.length) candidates[0].id = 'sidebarPanel';
  })();

  // 2) Add a backdrop if missing (should exist from injected markup)
  if (!$('#menuBackdrop')){
    const div = document.createElement('div');
    div.id = 'menuBackdrop';
    div.className = 'fixed inset-0 bg-slate-900/50 pointer-events-none z-[49] sm:hidden';
    div.style.opacity = '0';
    document.body.appendChild(div);
  }

  // 3) Find navbar container & add mobile hamburger and search buttons (only on small screens)
  (function ensureMobileButtons(){
    const nav = $('#siteHeader, header, nav, #navbar') || document.body;
    // Only add once
    if ($('#menuToggle')) return;
    const mkBtn = (id, label, icon) => {
      const b = document.createElement('button');
      b.id = id; b.type='button';
      b.setAttribute('aria-label', label);
      b.style.cssText = 'margin-left:.5rem; width:36px; height:36px; border-radius:8px; border:1px solid rgba(226,232,240,.8); background:transparent;';
      b.innerHTML = icon;
      return b;
    };
    const ham = mkBtn('menuToggle','Open menu','<span aria-hidden="true">‚ò∞</span>');
    const mag = mkBtn('mobileSearchOpen','Open search','<span aria-hidden="true">üîç</span>');

    // Try to place near brand link or within nav row
    const brand = $('#brandLink') || nav.firstElementChild;
    if (brand && brand.parentElement){
      brand.parentElement.insertBefore(ham, brand.nextSibling);
      brand.parentElement.insertBefore(mag, ham.nextSibling);
    }else{
      nav.appendChild(ham); nav.appendChild(mag);
    }
  })();

  // 4) Reuse search UI: try to find a search wrapper/input & dropdown
  const searchWrap = $('#searchWrap') || (function(){
    // fallback: build a small wrapper around the first text input that looks like search
    const input = $('input[type="search"], input[placeholder*="earch" i]');
    if (!input) return null;
    const wrap = document.createElement('div'); wrap.id='searchWrap'; wrap.style.position='relative';
    input.parentElement.insertBefore(wrap, input); wrap.appendChild(input);
    return wrap;
  })();

  // 5) Mobile search overlay wiring
  let originalParent=null, originalNext=null;
  function ensureOverlay(){
    if ($('#mobileSearchOverlay')) return true;
    // If missing (shouldn't), create a minimal one
    const overlay = document.createElement('div'); overlay.id='mobileSearchOverlay';
    overlay.className='fixed inset-0 z-[60] hidden sm:hidden';
    overlay.innerHTML = '<div class="absolute inset-0" style="background:rgba(2,6,23,.5)"></div><div class="relative z-10 h-full w-full bg-white dark:bg-slate-950"><div class="h-14 flex items-center justify-end px-3" style="border-bottom:1px solid rgba(226,232,240,.7)"><button id="mobileSearchClose" type="button" aria-label="Close search">‚úï</button></div><div id="mobileSearchMount" class="p-3"></div></div>';
    document.body.appendChild(overlay);
    return true;
  }
  ensureOverlay();

  function openMobileSearch(){
    if (!searchWrap) return;
    originalParent = searchWrap.parentElement;
    originalNext = searchWrap.nextSibling;
    const mount = $('#mobileSearchMount');
    if (mount){ mount.appendChild(searchWrap); }
    $('#mobileSearchOverlay')?.classList.remove('hidden');
    const si = $('#searchInput') || $('input[type="search"], input[placeholder*="earch" i]', searchWrap);
    si && si.focus();
  }
  function closeMobileSearch(){
    if (!searchWrap || !originalParent) return;
    $('#mobileSearchOverlay')?.classList.add('hidden');
    if (originalNext){ originalParent.insertBefore(searchWrap, originalNext); }
    else { originalParent.appendChild(searchWrap); }
  }

  // 6) Sidebar open/close
  function openMenu(){ document.body.classList.add('menu-open'); }
  function closeMenu(){ document.body.classList.remove('menu-open'); }
  $('#menuToggle')?.addEventListener('click', openMenu);
  $('#menuBackdrop')?.addEventListener('click', closeMenu);

  // 7) Search open/close buttons
  $('#mobileSearchOpen')?.addEventListener('click', openMobileSearch);
  $('#mobileSearchClose')?.addEventListener('click', closeMobileSearch);

  // 8) ESC closes both
  document.addEventListener('keydown', (e)=>{
    if (e.key === 'Escape'){ closeMenu(); closeMobileSearch(); }
  });

  // 9) Make a best-effort to mark likely sidebar as sticky on desktop
  (function tuneSidebarSticky(){
    const sp = $('#sidebarPanel');
    if (!sp) return;
    if (getComputedStyle(sp).position === 'static'){
      sp.style.position = 'relative';
    }
  })();

  // 10) Lazy-load images if not already
  $$('img').forEach(img=>{
    if (!img.hasAttribute('loading')) img.setAttribute('loading','lazy');
    if (!img.hasAttribute('decoding')) img.setAttribute('decoding','async');
  });
})();

  // --- Mobile full-page sidebar: add a header + X button on first open ---
  function ensureSidebarChrome(){
    const sp = $('#sidebarPanel');
    if(!sp) return;
    if(!sp.querySelector('.mobile-sheet-header')){
      const header = document.createElement('div');
      header.className = 'mobile-sheet-header';
      header.textContent = 'Browse';
      sp.prepend(header);
    }
    if(!sp.querySelector('.sidebar-close')){
      const btn = document.createElement('button');
      btn.className = 'sidebar-close'; btn.type='button'; btn.setAttribute('aria-label','Close menu');
      btn.innerHTML = '<span aria-hidden="true">‚úï</span>';
      btn.addEventListener('click', closeMenu);
      sp.appendChild(btn);
    }
  }
  const mqMobile = window.matchMedia('(max-width: 640px)');
  const sp = document.getElementById('sidebarPanel');

  const prevAttrs = { role:null, ariaModal:null };
  function openMenu(){ 
    document.body.classList.add('menu-open'); 
    if(mqMobile.matches){
      ensureSidebarChrome();
      // dialog semantics on mobile
      if(sp){
        prevAttrs.role = sp.getAttribute('role');
        prevAttrs.ariaModal = sp.getAttribute('aria-modal');
        sp.setAttribute('role','dialog');
        sp.setAttribute('aria-modal','true');
      }
    }
  }
  function closeMenu(){ 
    document.body.classList.remove('menu-open'); 
    if(sp && mqMobile.matches){
      if(prevAttrs.role===null) sp.removeAttribute('role'); else sp.setAttribute('role', prevAttrs.role);
      if(prevAttrs.ariaModal===null) sp.removeAttribute('aria-modal'); else sp.setAttribute('aria-modal', prevAttrs.ariaModal);
    }
  }
</script>
</body>
</html>
