<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Activity Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <!-- Tailwind (dev) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome 6 -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        fontFamily: { sans: ['Inter','ui-sans-serif','system-ui','Segoe UI','Arial'] },
        extend: {
          colors: {
            brand: {50:'#eef2ff',100:'#e0e7ff',200:'#c7d2fe',300:'#a5b4fc',400:'#818cf8',500:'#6366f1',600:'#4f46e5',700:'#4338ca',800:'#3730a3',900:'#312e81'}
          },
          boxShadow: { subtle: '0 1px 2px rgba(15,23,42,.06), 0 8px 24px rgba(15,23,42,.06)'},
          borderRadius: { xl:'0.875rem' }
        }
      }
    };
  </script>
  <style>
    :root{ color-scheme: light dark }
    html,body{ height:100% } body{ margin:0; overflow-x:hidden }
    img{ max-width:100%; height:auto; display:block }
    .no-scrollbar::-webkit-scrollbar{ display:none } .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none }
    .hscroll{ overflow-x:auto; -webkit-overflow-scrolling:touch; overscroll-behavior-x:contain }
    .cards-grid{ display:grid; gap:1.25rem; grid-template-columns:repeat(auto-fit,minmax(320px,1fr)) }
    .line-clamp-2{ display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden }

    /* Pills rail arrows */
    .pill-rail{ position:relative }
    .pill-nav{ position:absolute; top:50%; transform:translateY(-50%); width:36px; height:36px; border-radius:9999px; display:grid; place-items:center; z-index:10;
      background:rgba(255,255,255,.9); border:1px solid rgb(226 232 240); box-shadow:0 1px 2px rgba(15,23,42,.06), 0 8px 24px rgba(15,23,42,.06); backdrop-filter:saturate(1.1) blur(2px) }
    .pill-nav:hover{ background:#fff } .dark .pill-nav{ background:rgba(2,6,23,.9); border-color:rgb(51 65 85) } .dark .pill-nav:hover{ background:rgba(2,6,23,1) }

    /* Tabs */
    .tab-link{ display:inline-flex; align-items:center; gap:.5rem; height:40px; padding:0 .75rem; border-radius:.5rem; font-size:.9375rem; color:rgb(100 116 139) }
    .tab-link:hover{ background:rgba(15,23,42,.04) } .dark .tab-link:hover{ background:rgba(255,255,255,.05) }
    .tab-link[data-active="true"]{ color:rgb(15 23 42); font-weight:600; background:rgba(99,102,241,.12); outline:1px solid rgba(99,102,241,.35) }
    .dark .tab-link[data-active="true"]{ color:#fff; background:rgba(129,140,248,.16); outline-color:rgba(129,140,248,.45) }

    /* Sidebar */
    .side-link{ display:flex; align-items:center; gap:.6rem; width:100%; text-align:left; padding:.6rem .75rem; border-radius:.75rem; color:rgb(71 85 105) }
    .dark .side-link{ color:rgb(148 163 184) } .side-link:hover{ background:rgba(15,23,42,.04) } .dark .side-link:hover{ background:rgba(255,255,255,.05) }
    .side-link[data-active="true"]{ background:rgba(99,102,241,.12); color:rgb(49 46 129); outline:1px solid rgba(99,102,241,.35) }
    .dark .side-link[data-active="true"]{ color:#fff; background:rgba(129,140,248,.16); outline-color:rgba(129,140,248,.45) }

    /* Tokens */
    .token-pill{ display:inline-flex; align-items:center; gap:.4rem; height:24px; padding:0 .5rem; border-radius:.5rem; font-size:12px; background:rgba(99,102,241,.12); color:rgb(51,65,85); outline:1px solid rgba(99,102,241,.35) }
    .dark .token-pill{ color:#fff; background:rgba(129,140,248,.16); outline-color:rgba(129,140,248,.45) }
    .token-pill button{ width:18px; height:18px; display:grid; place-items:center; border-radius:.375rem }
    .token-pill button:hover{ background:rgba(15,23,42,.06) } .dark .token-pill button:hover{ background:rgba(255,255,255,.08) }

    /* Chips */
    .chip-btn{ display:inline-flex; align-items:center; gap:.4rem; height:28px; padding:0 .6rem; border-radius:.5rem; font-size:13px; border:1px solid rgb(226 232 240); color:rgb(71 85 105); background:#fff }
    .dark .chip-btn{ border-color:rgb(51 65 85); background:rgb(15 23 42); color:rgb(203 213 225) }
    .chip-btn:hover{ background:rgba(15,23,42,.04) } .dark .chip-btn:hover{ background:rgba(255,255,255,.05) }
    .chip-btn[data-selected="true"]{ color:rgb(49,46,129); background:rgba(99,102,241,.12); outline:1px solid rgba(99,102,241,.35) }
    .dark .chip-btn[data-selected="true"]{ color:#fff; background:rgba(129,140,248,.16); outline-color:rgba(129,140,248,.45) }

    /* Menus */
    .menu{ width:14rem; overflow:hidden; border-radius:.75rem; border:1px solid rgb(226 232 240); background:#fff; box-shadow:0 8px 24px rgba(15,23,42,.08) }
    .dark .menu{ border-color:rgb(51 65 85); background:rgb(15 23 42); box-shadow:0 8px 24px rgba(0,0,0,.35) }
    .menu .item{ display:flex; align-items:center; gap:.6rem; padding:.55rem .75rem; width:100%; text-align:left; font-size:.9375rem }
    .menu .item:hover{ background:rgba(15,23,42,.04) } .dark .menu .item:hover{ background:rgba(255,255,255,.06) }

    .dd-row{ display:flex; align-items:center; gap:.75rem; padding:.5rem .75rem; border-radius:.5rem; cursor:pointer }
    .dd-row:hover{ background:rgba(15,23,42,.04) } .dark .dd-row:hover{ background:rgba(255,255,255,.06) }
    .avatar-sm{ width:1.75rem; height:1.75rem; border-radius:.375rem; object-fit:cover } .avatar-fallback{ width:1.75rem; height:1.75rem; border-radius:.375rem; display:grid; place-items:center; font-size:.7rem }

    /* Share tiles */
    .share-scroller{ display:grid; grid-auto-flow:column; grid-auto-columns:120px; gap:1rem; align-items:start; justify-content:center; padding:.25rem .25rem .5rem }
    .share-tile{ position:relative; border-radius:14px; padding:.5rem .25rem .25rem; text-align:center; outline:none }
    .share-tile .overlay{ pointer-events:none; position:absolute; inset:0; border-radius:14px; opacity:0; transition:opacity .12s ease; background:rgba(15,23,42,.06); box-shadow:inset 0 0 0 1px rgba(100,116,139,.35) }
    .dark .share-tile .overlay{ background:rgba(255,255,255,.06); box-shadow:inset 0 0 0 1px rgba(51,65,85,.6) }
    .share-tile:hover .overlay,.share-tile:focus-visible .overlay{ opacity:1 }
    .circle{ width:4rem; height:4rem; border-radius:9999px; display:grid; place-items:center; font-size:1.1rem }
    .circle-img{ width:4rem; height:4rem; border-radius:9999px; object-fit:cover; border:1px solid rgba(100,116,139,.25) }

    .readmore-btn{ appearance:none; background:none; border:0; padding:0; margin-left:.25rem; color:rgb(79,70,229); font-weight:600; font-size:.95em; white-space:nowrap }
    .dark .readmore-btn{ color:rgb(165,180,252) }
    .readmore-btn:hover{ text-decoration:underline }
  </style>

<style id="sideNavActiveStyles">
#sideNav .side-link { opacity: 0.85; }
#sideNav .side-link[data-active="true"] { opacity: 1; font-weight: 600; }
</style>

<style id="eventCardModeStyles">
#grid .event-card{
  display:flex; align-items:center; justify-content:space-between; gap:.75rem;
  border:1px solid rgba(203,213,225,.8);
  background:#fff; padding:.75rem; border-radius:.75rem;
  box-shadow:0 1px 2px rgba(0,0,0,.04);
}
@media (prefers-color-scheme: dark){
  #grid .event-card{ background:#0b1220; border-color:rgba(51,65,85,.8); }
}
#grid .event-left{ display:flex; align-items:flex-start; gap:.75rem; min-width:0; }
#grid .event-org{ font-weight:600; color:#0f172a; }
#grid .event-time{ font-size:.875rem; color:#334155; margin-top:.125rem;}
#grid .event-recur{ font-size:.75rem; color:#475569; margin-top:.25rem;}
#grid .event-tags{ font-size:.75rem; color:#475569; margin-top:.25rem; display:flex; gap:.375rem; flex-wrap:wrap;}
@media (prefers-color-scheme: dark){
  #grid .event-org{ color:#e2e8f0; }
  #grid .event-time, #grid .event-recur, #grid .event-tags{ color:#cbd5e1; }
}
#grid .event-right details summary{ list-style:none; cursor:pointer; }
#grid .event-right a{ display:block; font-size:.875rem; padding:.375rem .5rem; border-radius:.5rem; }
#grid.non-clickable [data-nav]{ pointer-events:none; cursor:default; }
</style>

<style id="ah-events-css">
  .ah-event-card{display:flex;justify-content:space-between;align-items:stretch;gap:12px;padding:14px;border-radius:14px;border:1px solid rgba(100,116,139,.25);background:rgba(148,163,184,.08)}
  .dark .ah-event-card{background:rgba(148,163,184,.08);border-color:rgba(100,116,139,.35)}
  .ah-event-left{display:flex;gap:12px;min-width:0}
  .ah-event-logo{width:40px;height:40px;border-radius:10px;object-fit:cover;border:1px solid rgba(100,116,139,.35);background:rgba(0,0,0,.05)}
  .ah-event-title{font-weight:600;line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .ah-event-subtle{font-size:.9rem;opacity:.85}
  #grid.non-clickable .ah-event-card{cursor:default}
</style>

<style id="ah-skip-skeleton-css">
  /* Hide any skeleton/loader while we intentionally navigate to a detail page */
  body.ah-skip-skeleton #skeleton,
  body.ah-skip-skeleton .ah-skeleton,
  body.ah-skip-skeleton .skeleton,
  body.ah-skip-skeleton .skeleton-loader,
  body.ah-skip-skeleton [data-skeleton],
  body.ah-skip-skeleton [data-state="loading"] .skeleton,
  body.ah-skip-skeleton [data-state="loading"] .ah-skeleton {
    display: none !important;
  }
</style>

</head>

<body class="bg-white text-slate-900 dark:bg-slate-950 dark:text-slate-100 min-h-screen">
  <!-- Header (banner + navbar) -->
  <div id="siteHeader" class="fixed inset-x-0 top-0 z-50">
    <!-- Solid banner -->
    <div id="betaBanner" class="bg-blue-600 text-white">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center gap-3 py-2">
          <p class="text-sm">
            <span class="font-semibold">You‚Äôre early ‚Äî thanks for being here!</span>
            We‚Äôre in open beta and shipping improvements every week.
            <a class="underline underline-offset-4 decoration-white/60 hover:decoration-white" href="#">Changelog</a> ¬∑
            <a class="underline underline-offset-4 decoration-white/60 hover:decoration-white" href="mailto:hello@example.com?subject=Activity%20Hub%20feedback">Share feedback</a>
          </p>
          <button id="betaDismiss" class="ml-auto h-8 w-8 inline-grid place-items-center rounded-lg hover:bg-white/15" aria-label="Dismiss"><i class="fa-solid fa-xmark"></i></button>
        </div>
      </div>
    </div>

    <!-- Translucent navbar -->
    <header id="navbar" class="border-b border-slate-200/70 dark:border-slate-800/70 backdrop-blur bg-white/80 dark:bg-slate-950/70">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-14 flex items-center gap-4">
        <!-- Brand -->
        <a href="./" class="flex items-center gap-3 group shrink-0" id="brandLink">
          <img id="brandLogo" src="https://i.imgur.com/7dO0mhL.png" alt="Activity Hub logo" class="w-9 h-9 rounded-md object-contain bg-white ring-1 ring-slate-200 dark:ring-slate-800"/>
          <div id="brandFallback" class="w-9 h-9 rounded-md bg-brand-600 text-white grid place-items-center font-semibold hidden">AH</div>
          <div class="text-base font-semibold tracking-tight group-hover:text-brand-600 transition-colors">Activity Hub</div>
        </a>

        <!-- Search -->
        <div class="flex-1 max-w-2xl">
          <div class="relative" id="searchWrap">
            <div id="searchBar" class="w-full h-9 rounded-lg border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 pl-2 pr-10 flex items-center gap-1">
              <div id="tokenRow" class="flex items-center gap-1"></div>
              <input id="searchInput" type="text" placeholder="Search clubs by name, theme, or industry" class="flex-1 h-full bg-transparent outline-none text-sm" autocomplete="off"/>
              <i id="searchIcon" class="fa-solid fa-magnifying-glass absolute right-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
            </div>
            <div id="searchDropdown" class="hidden absolute left-0 right-0 mt-2 z-50">
              <div class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 shadow-subtle overflow-hidden">
                <div id="searchDropdownInner" class="py-2"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Theme toggle -->
        <button id="toggleTheme" class="shrink-0 inline-flex items-center gap-2 h-9 px-3 rounded-lg border border-slate-200 dark:border-slate-800 text-sm hover:bg-slate-50 dark:hover:bg-slate-900" aria-label="Toggle theme"></button>
      </div>
    </header>
  </div>
  <div id="headerSpacer"></div>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Directory -->
    <section id="view-directory" class="space-y-6">
      <div class="grid md:grid-cols-12 gap-6">
        <!-- Sidebar -->
        <aside class="md:col-span-3">
          <div class="md:sticky" style="top: calc(var(--header-h) + 16px);">
            <div class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 p-3">
              <h2 class="px-2 pt-1 pb-2 text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Browse</h2>
              <nav id="sideNav" class="space-y-1">
                <button class="side-link" data-kind="organizations"><i class="fa-solid fa-building-columns"></i><span>Organizations</span></button>
                <button class="side-link" data-kind="businesses"><i class="fa-solid fa-store"></i><span>Businesses</span></button>
                <button class="side-link" data-kind="projects"><i class="fa-solid fa-diagram-project"></i><span>Projects</span></button>
<button class="side-link side-link-duplicate" data-kind="organizations" aria-label="Events"><i class="fa-solid fa-calendar-days" class="fa-regular fa-calendar-days"></i><span>Events</span></button>

                <div class="my-2 border-t border-slate-200 dark:border-slate-800"></div>
                <button id="getAppBtn" class="w-full inline-flex items-center justify-center gap-2 h-10 px-3 rounded-lg bg-brand-600 text-white hover:bg-brand-700">
                  <i class="fa-solid fa-mobile-screen-button"></i><span>Get the App</span>
                </button>
              </nav>
            </div>
          </div>
        </aside>

        <!-- Main -->
        <div class="md:col-span-9 space-y-6">
          <!-- Theme pills -->
          <div class="pill-rail -mx-1 px-1">
            <div id="pillScroller" class="hscroll no-scrollbar">
              <div id="themeChips" class="flex items-center gap-2 py-1"></div>
            </div>
            <button id="pillPrev" class="pill-nav hidden left-1" aria-label="Scroll left"><i class="fa-solid fa-chevron-left"></i></button>
            <button id="pillNext" class="pill-nav right-1" aria-label="Scroll right"><i class="fa-solid fa-chevron-right"></i></button>
          </div>

          <!-- Count + Sort -->
          <div class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white/90 dark:bg-slate-900/90 backdrop-blur px-3 py-2 flex items-center justify-between">
            <div class="text-sm text-slate-500 dark:text-slate-400"><span id="countLabel">0</span> results</div>
            <div class="relative">
              <button id="openSort" class="inline-flex items-center gap-2 h-11 px-3 rounded-xl border border-slate-200 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-900" aria-haspopup="menu" aria-expanded="false">
                <i id="sortIcon" class="fa-solid fa-wand-magic-sparkles"></i>
                <span id="sortLabel" class="hidden sm:inline">Sort: Relevance</span>
                <i class="fa-solid fa-chevron-down text-xs ml-1"></i>
              </button>
              <div id="sortMenu" class="menu absolute right-0 mt-2 hidden z-20">
                <button class="item sort-opt" data-sort="relevance"><i class="fa-solid fa-wand-magic-sparkles w-5 text-center"></i><span>Relevance</span><i class="fa-solid fa-check ml-auto hidden"></i></button>
                <button class="item sort-opt" data-sort="az"><i class="fa-solid fa-arrow-down-a-z w-5 text-center"></i><span>A ‚Üí Z</span><i class="fa-solid fa-check ml-auto hidden"></i></button>
                <button class="item sort-opt" data-sort="za"><i class="fa-solid fa-arrow-down-z-a w-5 text-center"></i><span>Z ‚Üí A</span><i class="fa-solid fa-check ml-auto hidden"></i></button>
                <button class="item sort-opt" data-sort="popular"><i class="fa-solid fa-fire w-5 text-center"></i><span>Popular</span><i class="fa-solid fa-check ml-auto hidden"></i></button>
                <button class="item sort-opt" data-sort="verified"><i class="fa-solid fa-circle-check w-5 text-center"></i><span>Verified first</span><i class="fa-solid fa-check ml-auto hidden"></i></button>
              </div>
            </div>
          </div>

          <div id="grid" class="cards-grid"></div>
          <p id="emptyState" class="hidden text-center py-16 text-slate-500 dark:text-slate-400">No items match your filters.</p>
          <p id="feedback" class="text-sm text-rose-600 dark:text-rose-400"></p>
        </div>
      </div>
    </section>

    <!-- Detail -->
    <section id="view-detail" class="hidden">
      <nav class="mb-6 text-sm">
        <a href="./" class="inline-flex items-center gap-1 text-brand-600 hover:underline" id="backToDirectory"><i class="fa-solid fa-arrow-left text-sm"></i> All clubs</a>
      </nav>

      <div class="grid md:grid-cols-3 gap-6">
        <div class="md:col-span-2 space-y-3">
          <!-- Header block -->
          <article class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 shadow-subtle">
            <div class="p-6 md:p-8">
              <div class="flex items-start gap-5">
                <img id="d_logo" class="w-20 h-20 rounded-xl object-cover ring-1 ring-slate-200 dark:ring-slate-800 hidden" alt="">
                <div id="d_plt" class="w-20 h-20 rounded-xl grid place-items-center text-white text-lg font-semibold ring-1 ring-slate-200 dark:ring-slate-800"></div>
                <div class="min-w-0 flex-1">
                  <div class="flex items-start justify-between gap-4">
                    <div class="min-w-0">
                      <h1 id="d_name" class="text-2xl font-semibold tracking-tight"></h1>
                      <div id="d_verified" class="mt-1 hidden"><span class="inline-flex items-center gap-1 text-sky-600 text-sm"><i class="fa-solid fa-circle-check"></i><span>Verified</span></span></div>
                      <div class="mt-2 flex flex-wrap gap-2">
                        <span id="d_theme" class="hidden inline-flex items-center text-[11px] px-2.5 py-1 rounded-full bg-slate-100 dark:bg-slate-800 border border-slate-200/60 dark:border-slate-700/60"></span>
                        <span id="d_industry" class="hidden inline-flex items-center text-[11px] px-2.5 py-1 rounded-full bg-slate-100 dark:bg-slate-800 border border-slate-200/60 dark:border-slate-700/60"></span>
                        <span id="d_members" class="hidden inline-flex items-center text-[11px] px-2.5 py-1 rounded-full bg-slate-100 dark:bg-slate-800 border border-slate-200/60 dark:border-slate-700/60"><i class="fa-solid fa-users text-[10px] mr-1"></i><span></span></span>
                      </div>
                    </div>
                    <button id="openShare" class="shrink-0 inline-flex items-center gap-2 h-9 px-3 rounded-lg border border-slate-200 dark:border-slate-800 text-sm hover:bg-slate-50 dark:hover:bg-slate-900"><i class="fa-solid fa-share-nodes"></i><span class="hidden sm:inline">Share</span></button>
                  </div>
                </div>
              </div>

              <div class="mt-6 pt-3 border-t border-slate-200 dark:border-slate-800">
                <div class="flex gap-2 flex-wrap" role="tablist">
                  <button class="tab-link" data-tab="overview" data-active="true" aria-selected="true"><i class="fa-solid fa-circle-info"></i><span>Overview</span></button>
                  <button class="tab-link" data-tab="events" data-active="false" aria-selected="false"><i class="fa-solid fa-calendar-days"></i><span>Events</span></button>
                  <button class="tab-link" data-tab="contact" data-active="false" aria-selected="false"><i class="fa-solid fa-envelope"></i><span>Contact</span></button>
                </div>
              </div>
            </div>
          </article>

          <!-- Content block -->
          <article class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 shadow-subtle">
            <div class="p-5 md:p-6">
              <section id="panel-overview">
                <h2 class="text-lg font-semibold mb-2">About us</h2>
                <p id="d_desc" class="text-[15px] leading-7 text-slate-700 dark:text-slate-300">
                  <span id="d_desc_text"></span><button id="d_desc_more" class="readmore-btn hidden" type="button" aria-expanded="false">Read more</button>
                </p>
              </section>
              <section id="panel-events" class="hidden">
  <h2 class="text-lg font-semibold mb-3">Events</h2>

  <!-- Heads Up notice -->
  <div class="mb-3 rounded-xl border border-sky-200 bg-sky-50 text-slate-900 dark:border-sky-700/60 dark:bg-sky-900/20 dark:text-slate-100 p-3 flex gap-3" role="note">
    <i class="fa-solid fa-circle-info mt-0.5" aria-hidden="true"></i>
    <p class="text-sm">
      <span class="font-semibold">Heads Up ‚Äî</span>
      These events are automatically generated from St. John‚Äôs public scheduling data and may not always reflect a club‚Äôs most current plans.
      Clubs will soon be able to manage their own pages directly on Activity Hub, which will make listings more accurate over time.
      In the meantime, we recommend checking the organization‚Äôs social media or contacting them directly if an email is provided.
    </p>
  </div>

  

  <div class="mt-2 space-y-3 js-events-list" data-role="events-list" aria-live="polite"></div>
  <template id="tpl-empty">
    <div class="text-sm text-slate-600 dark:text-slate-400 italic flex items-center gap-2">
      <i class="fa-regular fa-calendar-xmark"></i>
      <span>No upcoming weekly meetings remaining in this semester.</span>
    </div>
  </template>
</section>
              <section id="panel-contact" class="hidden">
                <h2 class="text-lg font-semibold mb-3">Contact us</h2>
                <div id="d_emails" class="flex flex-wrap gap-2"></div>
                <h3 class="mt-5 font-medium">Forms</h3>
                <div id="d_forms" class="mt-2 flex flex-wrap gap-2"></div>
              </section>
            </div>
          </article>

          <!-- External Links block -->
          <article id="panel-links-card" class="hidden rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 shadow-subtle">
            <div class="p-5 md:p-6">
              <h2 class="text-lg font-semibold mb-2">External Links</h2>
              <div id="d_extlinks" class="flex flex-wrap gap-2"></div>
            </div>
          </article>
        </div>

        <!-- Recommendations -->
        <aside class="md:col-span-1">
          <div class="md:sticky md:top-24 space-y-3">
            <div class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 shadow-subtle p-4">
              <h2 id="recsTitle" class="text-base font-semibold mb-2">Orgs you may also like</h2>
              <div id="recsList" class="space-y-2"></div>
            </div>
          </div>
        </aside>
      </div>
    </section>
  </main>

  <!-- Share Modal -->
  <div id="shareModal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" data-close="share"></div>
    <div class="relative min-h-dvh grid place-items-center">
      <div class="w-full max-w-md px-4">
        <div class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 shadow-subtle p-6">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">Share</h3>
            <button id="shareClose" class="h-9 w-9 inline-grid place-items-center rounded-lg border border-slate-200 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800" aria-label="Close"><i class="fa-solid fa-xmark"></i></button>
          </div>
          <div class="mt-5 hscroll no-scrollbar">
            <div class="share-scroller" role="list">
              <button id="shareCopy" class="share-tile group" role="listitem" aria-label="Copy link">
                <span class="overlay"></span>
                <div class="circle mx-auto border border-slate-200 dark:border-slate-800"><i class="fa-solid fa-link"></i></div>
                <div class="mt-2 text-sm text-slate-700 dark:text-slate-300">Copy Link</div>
              </button>
              <a id="shareEmail" target="_blank" rel="noopener" class="share-tile group" role="listitem" aria-label="Share via Email">
                <span class="overlay"></span>
                <img alt="Email" src="https://i.imgur.com/cBOGtrb.png" class="circle-img mx-auto" loading="lazy"/>
                <div class="mt-2 text-sm text-slate-700 dark:text-slate-300">Email</div>
              </a>
              <a id="shareWhatsApp" target="_blank" rel="noopener" class="share-tile group" role="listitem" aria-label="Share on WhatsApp">
                <span class="overlay"></span>
                <img alt="WhatsApp" src="https://i.imgur.com/qOttODu.png" class="circle-img mx-auto" loading="lazy"/>
                <div class="mt-2 text-sm text-slate-700 dark:text-slate-300">WhatsApp</div>
              </a>
              <a id="shareLinkedIn" target="_blank" rel="noopener" class="share-tile group" role="listitem" aria-label="Share on LinkedIn">
                <span class="overlay"></span>
                <img alt="LinkedIn" src="https://i.imgur.com/PEw6T9z.png" class="circle-img mx-auto" loading="lazy"/>
                <div class="mt-2 text-sm text-slate-700 dark:text-slate-300">LinkedIn</div>
              </a>
              <a id="shareX" target="_blank" rel="noopener" class="share-tile group" role="listitem" aria-label="Share on X">
                <span class="overlay"></span>
                <img alt="X" src="https://i.imgur.com/PLQsGra.png" class="circle-img mx-auto" loading="lazy"/>
                <div class="mt-2 text-sm text-slate-700 dark:text-slate-300">X</div>
              </a>
            </div>
          </div>
          <div class="mt-4 text-center"><span id="shareCopied" class="text-sm text-emerald-600 hidden">Copied!</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters Modal -->
  <div id="filterModal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" data-close="filter"></div>
    <div class="relative mx-auto min-h-dvh grid place-items-center px-4">
      <div class="w-full max-w-lg">
        <div class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 shadow-subtle p-6">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">Filters</h3>
            <button id="filterClose" class="h-9 w-9 inline-grid place-items-center rounded-lg border border-slate-200 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800" aria-label="Close"><i class="fa-solid fa-xmark"></i></button>
          </div>
          <div class="mt-4">
            <label class="text-xs font-medium text-slate-500 dark:text-slate-400">Type</label>
            <div id="filterType" class="mt-2 flex flex-wrap gap-2">
              <button class="chip-btn" data-value="organizations">Orgs</button>
              <button class="chip-btn" data-value="businesses">Businesses</button>
              <button class="chip-btn" data-value="projects">Projects</button>
              <button class="chip-btn" data-value="global">Global</button>
            </div>
          </div>
          <div class="mt-4 grid sm:grid-cols-2 gap-4">
            <div>
              <label class="text-xs font-medium text-slate-500 dark:text-slate-400">Theme</label>
              <select id="filterTheme" class="mt-1 w-full h-11 rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 px-3"></select>
            </div>
            <div>
              <label class="text-xs font-medium text-slate-500 dark:text-slate-400">Industry</label>
              <select id="filterIndustry" class="mt-1 w-full h-11 rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 px-3">
                <option value="">All industries</option>
              </select>
            </div>
          </div>
          <div class="mt-6 flex items-center justify-between">
            <button id="filterClear" class="h-10 px-4 rounded-lg border border-slate-200 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800">Clear</button>
            <button id="filterApply" class="h-10 px-4 rounded-lg bg-brand-600 text-white hover:bg-brand-700">Apply</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Get the App Modal -->
  <div id="appModal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" data-close="app"></div>
    <div class="relative mx-auto min-h-dvh grid place-items-center px-4">
      <div class="w-full max-w-md">
        <div class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 shadow-subtle p-6">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">Mobile app ‚Äî almost ready</h3>
            <button id="appClose" class="h-9 w-9 inline-grid place-items-center rounded-lg border border-slate-200 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800" aria-label="Close"><i class="fa-solid fa-xmark"></i></button>
          </div>
          <p class="mt-3 text-sm text-slate-600 dark:text-slate-300">We‚Äôre putting the finishing touches on our iOS & Android app. Drop your email to be among the first to know when it launches.</p>
          <form id="appWaitlistForm" class="mt-4 space-y-3" novalidate>
            <div><label for="appEmail" class="sr-only">Email</label><input id="appEmail" type="email" required placeholder="you@example.com" class="w-full h-11 px-3 rounded-lg border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900"/></div>
            <button type="submit" id="appSubmit" class="w-full h-11 rounded-lg bg-brand-600 text-white hover:bg-brand-700 inline-flex items-center justify-center gap-2"><i class="fa-solid fa-bell"></i><span>Notify me</span></button>
            <p class="text-xs text-slate-500 dark:text-slate-400">No spam. We‚Äôll email you once ‚Äî when it‚Äôs live.</p>
          </form>
          <div id="appSuccess" class="hidden mt-4 text-emerald-600 text-sm">Thanks! You‚Äôre on the list. üéâ</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sample fallback -->
  <script id="sample-data" type="application/json">[
    {"name":"Actuarial Club","logo_url":"","description_preview":"The Actuarial Club aims to be a useful resource for actuarial science majors, hosting events, study groups and networking opportunities.","tagline":"Resource hub for aspiring actuaries","theme":"Professional Development","industry":"Finance","emails":"sjuactuarialclub@gmail.com","instagram":"https://www.instagram.com/sjuactuarial/","page_type":"Org","verified":"Yes","member_count":70},
    {"name":"Campus Coffee Co.","tagline":"Student-run pop-ups","theme":"Recreational","industry":"Food & Beverage","page_type":"Business","verified":"No"},
    {"name":"Green Dorm Dashboard","tagline":"Track energy usage","theme":"Academic","industry":"Sustainability","page_type":"project","verified":"No"}
  ]</script>

  <script>
  (function(){
    'use strict';

    // ---------- Config ----------
    var API_URL = "https://sheet2api.com/v1/ubMLioGAT8Gm/final-data";
    var DATA_URL = new URLSearchParams(location.search).get('src') || API_URL;

    var THEMES = ["Academic","Professional Development","Service / Volunteering","Recreational","Sports & Athletics","Religious / Spiritual","Cultural / Identity-Based","Arts & Media","Political / Activism"];
    var THEME_EMOJI = {"Academic":"üéì","Professional Development":"üíº","Service / Volunteering":"ü§ù","Recreational":"üéØ","Sports & Athletics":"üèÖ","Religious / Spiritual":"üïäÔ∏è","Cultural / Identity-Based":"üåç","Arts & Media":"üé®","Political / Activism":"üèõÔ∏è"};

    var RAW=[], VIEW=[], MAP=new Map(), CURRENT=null, ACTIVE_THEME="";
    var KIND = getKindFromParam() || 'organizations';
    var tokenKind = KIND, tokenTheme = "", tokenIndustry = "";
    var INDUSTRIES = [];

    var SORT_KEY='ah_sort_v1';
    var SORT = localStorage.getItem(SORT_KEY) || 'relevance';

    // ---------- Helpers ----------
    function $(s){ return document.querySelector(s); }
    function $all(s){ return Array.prototype.slice.call(document.querySelectorAll(s)); }
    function safe(s){ return (s==null?'':String(s)).trim(); }
    function slugify(s){ return safe(s).toLowerCase().replace(/&/g,' and ').replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,''); }
    function isValidHttpUrl(str){ try{ var u=new URL(str); return u.protocol==='http:'||u.protocol==='https:'; }catch(e){ return false; } }
    function extractUrls(str){ if(!str) return []; var m=String(str).match(/https?:\/\/[^\s|,]+/g); return m?Array.from(new Set(m)):[]; }
    function extractEmails(str){ if(!str) return []; var m=String(str).match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/ig); return m?Array.from(new Set(m)):[]; }
    function initials(name){ return safe(name).split(/\s+/).slice(0,3).map(function(p){return p[0];}).join('').toUpperCase(); }
    function escapeHtml(str){ return String(str==null?'':str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
    function hashCode(s){ var h=0; for(var i=0;i<s.length;i++){ h=(h<<5)-h + s.charCodeAt(i); h|=0; } return Math.abs(h); }
    function gradientForKey(key){ var h=hashCode(key||'seed')%360; var h2=(h+35)%360; return 'linear-gradient(135deg, hsl('+h+' 85% 52%), hsl('+h2+' 85% 46%))'; }
    function faBrand(type){ var map={instagram:'fa-instagram',twitter_x:'fa-x-twitter',facebook:'fa-facebook',tiktok:'fa-tiktok',youtube:'fa-youtube',linkedin:'fa-linkedin',discord:'fa-discord',groupme:'fa-user-group',linktree:'fa-link'}; return map[type]||'fa-link'; }
    var BRAND_SET = new Set(['fa-instagram','fa-x-twitter','fa-facebook','fa-tiktok','fa-youtube','fa-linkedin','fa-discord']);

    function normalizeKind(v){
      var s=safe(v).toLowerCase();
      if(/org/.test(s)) return 'organizations';
      if(/business|biz/.test(s)) return 'businesses';
      if(/project/.test(s)) return 'projects';
      return 'organizations';
    }
    var KIND_LABEL = { organizations:'Orgs', businesses:'Businesses', projects:'Projects' };

    function normalizeRow(row){
      var displayName = safe(row.org_name || row.name);
      var mc = safe(row.member_count);
      var n = {
        org_name: displayName,
        slug: slugify(displayName || ('id-'+Math.random().toString(36).slice(2))),
        logo_url: safe(row.logo_url),
        tagline: safe(row.tagline),
        theme: safe(row.theme),
        industry: safe(row.industry),
        school: safe(row.school),
        origin: safe(row.origin),
        kind: normalizeKind(row.page_type || row.type || 'org'),
        verified: /^y(es)?$/i.test(safe(row.verified)),
        member_count: mc ? (parseInt(mc,10) || null) : null,
        description: safe(row.description_preview),
        emails: extractEmails(row.emails),
        forms: extractUrls(row.forms),
        website: (extractUrls(row.website)[0] || safe(row.website)),
        instagram: extractUrls(row.instagram)[0]||"",
        twitter_x: extractUrls(row.twitter_x)[0]||"",
        facebook: extractUrls(row.facebook)[0]||"",
        tiktok: extractUrls(row.tiktok)[0]||"",
        youtube: extractUrls(row.youtube)[0]||"",
        linkedin: extractUrls(row.linkedin)[0]||"",
        discord: extractUrls(row.discord)[0]||"",
        groupme: extractUrls(row.groupme)[0]||"",
        linktree: extractUrls(row.linktree)[0]||""
      };
      n.hasLogo = !!n.logo_url;
      return n;
    }
    function normalizeAll(rows){
      var uniq=new Map();
      rows.forEach(function(r){
        var n=normalizeRow(r);
        if(!n.org_name) return;
        if(!uniq.has(n.slug)) uniq.set(n.slug,n);
      });
      return Array.from(uniq.values());
    }

    function chip(txt){ return '<span class="inline-flex items-center text-[11px] px-2.5 py-1 rounded-full bg-slate-100 dark:bg-slate-800 border border-slate-200/60 dark:border-slate-700/60">'+escapeHtml(txt)+'</span>'; }
    function verifiedBadgeSm(){ return '<span class="ml-1 align-middle text-sky-600" title="Verified"><i class="fa-solid fa-circle-check"></i></span>'; }

    // ---------- Theme pills ----------
    function buildThemeChips(){
      var wrap = $('#themeChips');
      function make(label){
        var value = label;
        var active = (ACTIVE_THEME===value);
        var emoji = value ? (THEME_EMOJI[value]||'üè∑Ô∏è') : '‚ú®';
        var text  = value || 'All';
        return '<button data-theme="'+escapeHtml(value)+'" class="inline-flex items-center gap-2 whitespace-nowrap h-9 px-3 rounded-lg border text-sm transition '+(active?'bg-slate-900 text-white border-slate-900 dark:bg-white dark:text-slate-900 dark:border-white':'border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 hover:bg-slate-50 dark:hover:bg-slate-800')+'" aria-pressed="'+(active?'true':'false')+'"><span>'+emoji+'</span><span>'+escapeHtml(text)+'</span></button>';
      }
      wrap.innerHTML = [make('')].concat(THEMES.map(make)).join('');
      $all('#themeChips button[data-theme]').forEach(function(btn){
        btn.addEventListener('click', function(){
          ACTIVE_THEME = btn.getAttribute('data-theme') || '';
          $('#filterTheme').value = ACTIVE_THEME;
          setThemeParam(ACTIVE_THEME);
          applyFilters();
          buildThemeChips();
          setTimeout(updatePillArrows, 0);
        });
      });
      setTimeout(updatePillArrows, 0);
    }
    function updatePillArrows(){
      var sc=$('#pillScroller'), prev=$('#pillPrev'), next=$('#pillNext');
      if(!sc){ return; }
      var max = sc.scrollWidth - sc.clientWidth;
      if(max<=2){ prev.classList.add('hidden'); next.classList.add('hidden'); return; }
      prev.classList.toggle('hidden', sc.scrollLeft<=2);
      next.classList.toggle('hidden', sc.scrollLeft>=max-2);
    }
    var pillsInitedOnce=false;
    function initPillScroller(){
      if(pillsInitedOnce){ updatePillArrows(); return; }
      pillsInitedOnce=true;
      var sc=$('#pillScroller'), prev=$('#pillPrev'), next=$('#pillNext');
      var STEP=320;
      prev.addEventListener('click',function(){ sc.scrollBy({left:-STEP,behavior:'smooth'}); });
      next.addEventListener('click',function(){ sc.scrollBy({left: STEP,behavior:'smooth'}); });
      sc.addEventListener('scroll',updatePillArrows,{passive:true}); window.addEventListener('resize',updatePillArrows);
      updatePillArrows();
    }

    // ---------- Cards ----------
    function card(org){
      var hasLogo = (org.logo_url && isValidHttpUrl(org.logo_url));
      var logoImg = hasLogo
        ? '<img class="w-14 h-14 rounded-xl object-cover ring-1 ring-slate-200 dark:ring-slate-800" src="'+escapeHtml(org.logo_url)+'" alt="'+escapeHtml(org.org_name)+' logo" onerror="this.style.display=\'none\'; this.nextElementSibling.classList.remove(\'hidden\');">'
        : '';
      var placeholder = '<div class="w-14 h-14 rounded-xl grid place-items-center shrink-0 ring-1 ring-slate-200 dark:ring-slate-800 '+(hasLogo?'hidden':'')+'" style="background:'+gradientForKey(org.slug)+';"><span class="text-sm font-semibold text-white">'+initials(org.org_name)+'</span></div>';
      var nameHtml = escapeHtml(org.org_name)+(org.verified ? ' '+verifiedBadgeSm() : '');
      var members = (org.member_count && isFinite(org.member_count))
        ? '<span class="inline-flex items-center text-[11px] px-2.5 py-1 rounded-full bg-slate-100 dark:bg-slate-800 border border-slate-200/60 dark:border-slate-700/60"><i class="fa-solid fa-users text-[10px] mr-1"></i>'+org.member_count+'</span>'
        : '';
      return '<a class="group block rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 p-4 shadow-subtle hover:shadow transition" href="?org='+org.slug+'" data-nav="'+org.slug+'"><div class="flex items-start gap-3">'+logoImg+placeholder+'<div class="min-w-0"><h3 class="text-[15px] font-semibold tracking-tight truncate group-hover:text-brand-600 transition-colors">'+nameHtml+'</h3>'+(org.tagline?'<p class="text-[13px] text-slate-500 dark:text-slate-400 mt-0.5 line-clamp-2">'+escapeHtml(org.tagline)+'</p>':'')+'<div class="mt-2 flex flex-wrap gap-2">'+(org.theme?chip(org.theme):'')+' '+(org.industry?chip(org.industry):'')+' '+members+'</div></div></div></a>';
    }
    function renderDirectory(list){
  try{ window.__LAST_DIRECTORY_LIST = Array.isArray(list) ? list.slice() : []; }catch(e){}

      var grid=$('#grid');
      if(!list.length){
        grid.innerHTML=''; $('#emptyState').classList.remove('hidden'); $('#countLabel').textContent='0'; return;
      }
      $('#emptyState').classList.add('hidden');
      grid.innerHTML = (window.EVENT_LIST_MODE ? list.map(eventCardFromOrg) : list.map(card)).join('');
      $('#countLabel').textContent=String(list.length);
      
  var nonClickable = !!window.NON_CLICK_LISTINGS;
  if (grid && grid.classList) grid.classList.toggle('non-clickable', nonClickable);

  if (!nonClickable) {
  // Intercept listing clicks to SPA-navigate without full reload (prevents skeleton flash)
  $all('#grid [data-nav]').forEach(function(a){
    a.addEventListener('click', function(e){
      e.preventDefault();
      var slug = a.getAttribute('data-nav');
      if (slug) { navigateToDetail(slug); }
    }, { once: false });
  });
}
}

    function hydrateThemeSelect(){
      $('#filterTheme').innerHTML = '<option value="">All themes</option>'+THEMES.map(function(t){ return '<option value="'+escapeHtml(t)+'">'+escapeHtml(t)+'</option>'; }).join('');
    }
    function hydrateIndustrySelect(values){
      var opts = Array.from(new Set(values.filter(Boolean))).sort(function(a,b){ return a.localeCompare(b); });
      $('#filterIndustry').innerHTML = '<option value="">All industries</option>'+opts.map(function(v){ return '<option value="'+escapeHtml(v)+'">'+escapeHtml(v)+'</option>'; }).join('');
      INDUSTRIES = opts;
    }
    function setThemeParam(val){
      var url=new URL(location.href);
      if(val) url.searchParams.set('theme',slugify(val)); else url.searchParams.delete('theme');
      history.replaceState(history.state,'',url);
    }
    function findThemeBySlug(slug){ return THEMES.find(function(t){ return slugify(t)===slug; }) || ''; }
    function setKindParam(kind){
      var url=new URL(location.href);
      if(kind) url.searchParams.set('type',kind); else url.searchParams.delete('type');
      history.replaceState(history.state,'',url);
    }
    function getKindFromParam(){
      try{
        var k=new URL(location.href).searchParams.get('type');
        if(!k) return '';
        var one=k.toLowerCase();
        return (['organizations','businesses','projects'].indexOf(one)>-1?one:'');
      }catch(e){ return ''; }
    }

    // ---------- Sort ----------
    function renderSortButton(){
      var mapIcon = { relevance:'fa-wand-magic-sparkles', az:'fa-arrow-down-a-z', za:'fa-arrow-down-z-a', popular:'fa-fire', verified:'fa-circle-check' };
      $('#sortIcon').className = 'fa-solid '+(mapIcon[SORT]||'fa-wand-magic-sparkles');
      $('#sortLabel').textContent = 'Sort: ' + (SORT==='az'?'A ‚Üí Z':SORT==='za'?'Z ‚Üí A':SORT==='popular'?'Popular':SORT==='verified'?'Verified first':'Relevance');
      $all('#sortMenu .sort-opt').forEach(function(btn){
        var selected = btn.getAttribute('data-sort')===SORT;
        var check = btn.querySelector('.fa-check');
        if(check){ check.classList.toggle('hidden',!selected); }
      });
    }
    function setSort(v){
      SORT = v; localStorage.setItem(SORT_KEY,SORT);
      renderSortButton(); applyFilters(); closeSortMenu();
    }
    function scorePopular(o){
      var s=0; s+=(o.member_count||0)*2; s+=o.verified?50:0;
      var socials=['instagram','twitter_x','facebook','tiktok','youtube','linkedin','discord','groupme','linktree'];
      for(var i=0;i<socials.length;i++){ if(o[socials[i]]) s+=5; }
      return s;
    }
    function scoreRelevance(o,q){
      if(!q) return 0;
      var name=(o.org_name||'').toLowerCase(), theme=(o.theme||'').toLowerCase(), ind=(o.industry||'').toLowerCase();
      var s=0;
      if(name===q) s+=100;
      if(name.indexOf(q)===0) s+=40;
      if(name.indexOf(q)>-1) s+=20;
      if(theme.indexOf(q)>-1) s+=8;
      if(ind.indexOf(q)>-1) s+=6;
      if(o.verified) s+=2;
      s += Math.min((o.member_count||0),500)/250;
      return s;
    }
    function sortView(list){
      var q=$('#searchInput').value.trim().toLowerCase();
      var collator=new Intl.Collator(undefined,{sensitivity:'base'});
      var arr=list.slice();
      if(SORT==='az') arr.sort(function(a,b){ return collator.compare(a.org_name,b.org_name); });
      else if(SORT==='za') arr.sort(function(a,b){ return collator.compare(b.org_name,a.org_name); });
      else if(SORT==='verified') arr.sort(function(a,b){ return (b.verified - a.verified) || collator.compare(a.org_name,b.org_name); });
      else if(SORT==='popular') arr.sort(function(a,b){ return scorePopular(b)-scorePopular(a); });
      else { if(q){ arr.sort(function(a,b){ return scoreRelevance(b,q)-scoreRelevance(a,q); }); } else { arr.sort(function(a,b){ return collator.compare(a.org_name,b.org_name); }); } }
      return arr;
    }

    function emailChip(e){ return '<a href="mailto:'+escapeHtml(e)+'" class="inline-flex items-center gap-2 text-xs px-3 py-1.5 rounded-lg border border-slate-200 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-900"><i class="fa-solid fa-envelope"></i><span>'+escapeHtml(e)+'</span></a>'; }
    function formChip(u){ return '<a href="'+escapeHtml(u)+'" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 text-xs px-3 py-1.5 rounded-lg bg-brand-600 text-white hover:bg-brand-700"><i class="fa-solid fa-file-lines"></i><span>Form</span></a>'; }
    function socialLink(href,type,label){
      if(!href||!isValidHttpUrl(href)) return '';
      var names={instagram:'Instagram',twitter_x:'Twitter/X',facebook:'Facebook',tiktok:'TikTok',youtube:'YouTube',linkedin:'LinkedIn',discord:'Discord',groupme:'GroupMe',linktree:'Linktree',website:'Website'};
      var fa= type==='website' ? 'fa-globe' : faBrand(type);
      var prefix= type==='website' ? 'fa-solid' : (BRAND_SET.has(fa)?'fa-brands':'fa-solid');
      var title=(names[type]||label||'Link');
      return '<a href="'+escapeHtml(href)+'" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 text-xs px-3 py-1.5 rounded-lg border border-slate-200 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-900" aria-label="'+title+'"><i class="'+prefix+' '+fa+' fa-fw"></i><span class="hidden sm:inline">'+title+'</span></a>';
    }
    function socialRow(o){
      var arr=[];
      if(o.website) arr.push(socialLink(o.website,'website','Website'));
      arr.push(socialLink(o.instagram,'instagram','Instagram'));
      arr.push(socialLink(o.twitter_x,'twitter_x','Twitter/X'));
      arr.push(socialLink(o.facebook,'facebook','Facebook'));
      arr.push(socialLink(o.tiktok,'tiktok','TikTok'));
      arr.push(socialLink(o.youtube,'youtube','YouTube'));
      arr.push(socialLink(o.linkedin,'linkedin','LinkedIn'));
      arr.push(socialLink(o.discord,'discord','Discord'));
      arr.push(socialLink(o.groupme,'groupme','GroupMe'));
      arr.push(socialLink(o.linktree,'linktree','Linktree'));
      return arr.filter(Boolean).join('');
    }

    function recCardVertical(org){
      var hasLogo=(org.logo_url && isValidHttpUrl(org.logo_url));
      var logo= hasLogo
        ? '<img class="w-10 h-10 rounded-md object-cover ring-1 ring-slate-200 dark:ring-slate-800" src="'+escapeHtml(org.logo_url)+'" alt="'+escapeHtml(org.org_name)+' logo" onerror="this.style.display=\'none\'; this.nextElementSibling.classList.remove(\'hidden\');">'
        : '';
      var fallback = '<div class="w-10 h-10 rounded-md grid place-items-center shrink-0 ring-1 ring-slate-200 dark:ring-slate-800 '+(hasLogo?'hidden':'')+'" style="background:'+gradientForKey(org.slug)+';"><span class="text-[11px] font-semibold text-white">'+initials(org.org_name)+'</span></div>';
      var nameHtml = escapeHtml(org.org_name)+(org.verified ? ' '+verifiedBadgeSm() : '');
      return '<a class="group block rounded-lg border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 p-3 hover:shadow-subtle transition" href="?org='+org.slug+'" data-nav="'+org.slug+'"><div class="flex items-start gap-3">'+logo+fallback+'<div class="min-w-0"><div class="text-[13px] font-medium truncate group-hover:text-brand-600 transition-colors">'+nameHtml+'</div><div class="mt-1 flex flex-wrap gap-1">'+(org.theme?chip(org.theme):'')+' '+(org.industry?chip(org.industry):'')+'</div></div></div></a>';
    }
    function chooseRecommendations(current,k){
      var pool=RAW.filter(function(x){ return x.slug!==current.slug && x.kind===current.kind; });
      function score(o){
        var s=0;
        if(current.theme&&o.theme&&current.theme===o.theme) s+=3;
        if(current.industry&&o.industry&&current.industry===o.industry) s+=2;
        if(o.instagram||o.twitter_x||o.facebook||o.tiktok||o.youtube||o.linkedin||o.discord||o.groupme||o.linktree) s+=1;
        if(o.verified) s+=1;
        return s;
      }
      var ranked=pool.map(function(o){ return {o:o,s:score(o)}; }).sort(function(a,b){ return b.s-a.s; });
      var top=ranked.filter(function(x){ return x.s>0; }).slice(0,k).map(function(x){ return x.o; });
      if(top.length<k){
        var remain=pool.filter(function(x){ return top.indexOf(x)===-1; }).sort(function(a,b){ return a.org_name.localeCompare(b.org_name); });
        top=top.concat(remain.slice(0,k-top.length));
      }
      return top;
    }
    function renderRecommendations(current){
      var recs=chooseRecommendations(current,6);
      var list=$('#recsList');
      list.innerHTML=recs.map(recCardVertical).join('');
      $all('#recsList [data-nav]').forEach(function(a){
        a.addEventListener('click',function(e){ e.preventDefault(); navigateToDetail(a.getAttribute('data-nav')); });
      });
    }

    function activateTab(tab){
      $all('.tab-link').forEach(function(b){
        var active=b.getAttribute('data-tab')===tab;
        b.setAttribute('data-active', active?'true':'false');
        b.setAttribute('aria-selected', active?'true':'false');
      });
      var panels=[['overview','#panel-overview'],['events','#panel-events'],['contact','#panel-contact']];
      for(var i=0;i<panels.length;i++){
        var name=panels[i][0], sel=panels[i][1], el=$(sel);
        if(!el) continue;
        if(name===tab) el.classList.remove('hidden'); else el.classList.add('hidden');
      }
      var linksCard = $('#panel-links-card');
      if(linksCard){
        if(tab==='overview' && linksCard.getAttribute('data-has-links')==='true'){ linksCard.classList.remove('hidden'); }
        else { linksCard.classList.add('hidden'); }
      }
    }

    function setDescription(desc){
      var span=$('#d_desc_text'), btn=$('#d_desc_more');
      var limit=360;
      var full=(desc&&desc.trim())?desc.trim():'No description provided.';
      var needsMore = full.length>limit;
      function truncatedText(s){ var t=s.slice(0,limit); return t.replace(/\s+\S*$/,'')+'‚Ä¶'; }
      btn.setAttribute('data-expanded','false'); btn.setAttribute('aria-expanded','false');
      if(needsMore){
        span.textContent = truncatedText(full);
        btn.textContent = 'Read more';
        btn.classList.remove('hidden');
        btn.onclick=function(){
          var expanded = btn.getAttribute('data-expanded')==='true';
          if(expanded){
            span.textContent = truncatedText(full);
            btn.textContent = 'Read more';
            btn.setAttribute('data-expanded','false'); btn.setAttribute('aria-expanded','false');
          }else{
            span.textContent = full;
            btn.textContent = ' Show less';
            btn.setAttribute('data-expanded','true'); btn.setAttribute('aria-expanded','true');
          }
        };
      }else{
        span.textContent = full;
        btn.classList.add('hidden');
        btn.onclick=null;
      }
    }

    /* ==== Weekly Meetings Generator (Mon/Thu @ 1:50 PM) ==== */
/* Configurable Fall end date: override via ?fallEnd=YYYY-MM-DD (America/New_York) */
(function(){
  var params=new URLSearchParams(location.search);
  var FALL_END_PARAM=params.get('fallEnd'); // e.g., 2025-12-17
  var FALL_END_DATE=FALL_END_PARAM? FALL_END_PARAM : '2025-12-17';

  var MONDAY=1, THURSDAY=4;

  var MONTH_ABBR=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  var WEEKDAY_ABBR=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

  function pad(n){ return (n<10?'0':'')+n; }

  function weekday(y,m,d){ return new Date(Date.UTC(y,m-1,d)).getUTCDay(); }

  function nextNYDates(fromY,fromM,fromD,toY,toM,toD){
    var res=[];
    var cur=new Date(Date.UTC(fromY,fromM-1,fromD));
    var end=new Date(Date.UTC(toY,toM-1,toD));
    while(cur<=end){
      var y=cur.getUTCFullYear(), m=cur.getUTCMonth()+1, d=cur.getUTCDate();
      var w=cur.getUTCDay();
      if(w===MONDAY||w===THURSDAY){ res.push({y:y,m:m,d:d}); }
      cur.setUTCDate(cur.getUTCDate()+1);
    }
    return res;
  }

  function nyTodayParts(){
    var now=new Date();
    var parts=new Intl.DateTimeFormat('en-US',{
      timeZone:'America/New_York',
      year:'numeric',month:'2-digit',day:'2-digit'
    }).formatToParts(now).reduce(function(a,p){ a[p.type]=p.value; return a; },{});
    return { y:+parts.year, m:+parts.month, d:+parts.day };
  }

  function partsFromISODate(iso){
    var a=iso.split('-'); return { y:+a[0], m:+a[1], d:+a[2] };
  }

  function formatNYDisplay(y,m,d){
    // "Thu, Sep 18 ‚Ä¢ 1:50 PM" (no year)
    var wd=WEEKDAY_ABBR[weekday(y,m,d)];
    return wd+', '+MONTH_ABBR[m-1]+' '+d+' ‚Ä¢ '+'1:50 PM';
  }

  function calDate(y,m,d){ return ''+y+pad(m)+pad(d); } // YYYYMMDD

  function orgLogoHtml(org){
    var src = org.logo_url || org.logo || (Array.isArray(org.logos)&&org.logos.length? org.logos[0] : '');
    if(src && /^https?:\/\//i.test(src)){
      return '<img src="'+escapeHtml(src)+'" alt="'+escapeHtml(org.org_name||org.name||'Logo')+'" class="h-9 w-9 rounded-lg object-cover ring-1 ring-slate-200 dark:ring-slate-700" loading="lazy" width="36" height="36">';
    }
    var nm = org.org_name||org.name||'Org';
    var bg = gradientForKey(org.slug||nm);
    var init = initials(nm);
    return '<span class="h-9 w-9 rounded-lg text-white text-xs font-semibold grid place-items-center" style="background:'+bg+'">'+escapeHtml(init)+'</span>';
  }

  function emailLine(org){
    var email = (Array.isArray(org.emails)&&org.emails[0]) || org.email || '';
    if(!email) return '';
    var safe=escapeHtml(email);
    return '<div class="text-sm text-slate-700 dark:text-slate-300 mt-2">Contact <a class="underline hover:no-underline" href="mailto:'+safe+'">'+safe+'</a> for more info.</div>';
  }

  function googleCalLink(y,m,d,org){
    var start=calDate(y,m,d)+'T135000';
    var end=calDate(y,m,d)+'T145000';
    var base='https://calendar.google.com/calendar/render?action=TEMPLATE';
    var text=encodeURIComponent('Weekly Meeting ‚Äî '+(org.org_name||org.name||'Organization'));
    var details=encodeURIComponent('Weekly meeting for '+(org.org_name||org.name||'Organization')+' at 1:50 PM.');
    return base+'&text='+text+'&dates='+start+'/'+end+'&ctz=America/New_York&details='+details;
  }

  function icsDataUri(y,m,d,org){
    var dt=calDate(y,m,d);
    var summary='Weekly Meeting ‚Äî '+(org.org_name||org.name||'Organization');
    var desc='Weekly meeting for '+(org.org_name||org.name||'Organization')+' at 1:50 PM.';
    var uid = (org.slug||org.org_name||org.name||'org')+'-'+dt+'-1350@activityhub';
    var ics=[
      'BEGIN:VCALENDAR',
      'VERSION:2.0',
      'PRODID:-//Activity Hub//Weekly Meetings//EN',
      'CALSCALE:GREGORIAN',
      'BEGIN:VEVENT',
      'UID:'+uid,
      'DTSTAMP:'+dt+'T000000Z',
      'DTSTART;TZID=America/New_York:'+dt+'T135000',
      'DTEND;TZID=America/New_York:'+dt+'T145000',
      'SUMMARY:'+summary.replace(/\\n/g,' '),
      'DESCRIPTION:'+desc.replace(/\\n/g,' '),
      'END:VEVENT',
      'END:VCALENDAR'
    ].join('\\r\\n');
    return 'data:text/calendar;charset=utf-8,'+encodeURIComponent(ics);
  }

  window.renderWeeklyMeetingsForOrg = function(org){
    var cont = document.querySelector("[data-role='events-list']") || document.getElementById('panel-events');
    if(!cont) return;
    cont.innerHTML='';

    // date range in NY
    var startParts = nyTodayParts();
    var endParts = partsFromISODate(FALL_END_DATE);

    // range labels (keep year here for clarity)
    var rs=document.getElementById('range-start');
    var re=document.getElementById('range-end');
    var MONTH_ABBR=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    var startLabel = MONTH_ABBR[startParts.m-1]+' '+startParts.d+', '+startParts.y;
    var endLabel = MONTH_ABBR[endParts.m-1]+' '+endParts.d+', '+endParts.y;
    if(rs) rs.textContent=startLabel;
    if(re) re.textContent=endLabel;

    var dates = nextNYDates(startParts.y,startParts.m,startParts.d,endParts.y,endParts.m,endParts.d);
    if(!dates.length){
      var tpl=document.getElementById('tpl-empty');
      if(tpl) cont.appendChild(tpl.content.cloneNode(true));
      return;
    }

    var frag=document.createDocumentFragment();
    dates.forEach(function(p){
      var row=document.createElement('div');
      row.className='flex items-center justify-between gap-3 rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 p-3 shadow-sm';

      var left = document.createElement('div');
      left.className='flex items-start gap-3';
      left.innerHTML = [
        '<div class="mt-0.5 shrink-0">', orgLogoHtml(org), '</div>',
        '<div class="min-w-0">',
          '<div class="font-medium text-slate-900 dark:text-slate-100">',
            'Weekly Meeting ‚Äî ', escapeHtml(org.org_name||org.name||'Organization'),
          '</div>',
          '<div class="text-sm text-slate-700 dark:text-slate-300 mt-0.5">',
            formatNYDisplay(p.y,p.m,p.d),
          '</div>',
          '<div class="text-xs text-slate-600 dark:text-slate-400 mt-1">',
            'Recurs weekly on Mondays & Thursdays through the end of the Fall semester.',
          '</div>',
          emailLine(org),
        '</div>'
      ].join('');

      var right = document.createElement('div');
      right.className='shrink-0';
      var gLink = googleCalLink(p.y,p.m,p.d,org);
      var ics = icsDataUri(p.y,p.m,p.d,org);
      right.innerHTML = '<details class="relative select-none">'+
        '<summary class="list-none marker:hidden cursor-pointer inline-flex items-center gap-2 rounded-lg border border-slate-300 dark:border-slate-700 px-3 py-1.5 text-sm hover:bg-slate-50 dark:hover:bg-slate-800">'+
          '<i class="fa-regular fa-calendar-plus" aria-hidden="true"></i>'+
          '<span>Add to Calendar</span>'+
        '</summary>'+
        '<div class="absolute right-0 mt-2 w-44 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 shadow-lg p-1">'+
          '<a class="block px-2.5 py-2 rounded text-sm hover:bg-slate-50 dark:hover:bg-slate-800" target="_blank" rel="noopener" href="'+gLink+'">Google Calendar</a>'+
          '<a class="block px-2.5 py-2 rounded text-sm hover:bg-slate-50 dark:hover:bg-slate-800" download="weekly-meeting.ics" href="'+ics+'">Download .ics</a>'+
        '</div>'+
      '</details>';

      row.appendChild(left);
      row.appendChild(right);
      frag.appendChild(row);
    });

    cont.appendChild(frag);
  };

  try{ window.__bindCardClicksSafely(); }catch(e){}
})();

function renderDetail(slug){
      var org=MAP.get(slug); if(!org){ showDirectory(); return; }
      CURRENT=org; document.title=org.org_name+' ‚Äî Activity Hub';
      var recMap={ organizations:'Orgs you may also like', businesses:'Businesses you may also like', projects:'Projects you may also like' };
      var recsTitleEl=$('#recsTitle'); if(recsTitleEl){ recsTitleEl.textContent=recMap[org.kind]||'You may also like'; }

      var logo=$('#d_logo'), plt=$('#d_plt');
      if(org.logo_url && isValidHttpUrl(org.logo_url)){
        logo.src=org.logo_url; logo.alt=org.org_name+' logo'; logo.classList.remove('hidden'); plt.classList.add('hidden');
      }else{
        logo.classList.add('hidden'); plt.classList.remove('hidden'); plt.textContent=initials(org.org_name); plt.style.background=gradientForKey(org.slug);
      }

      $('#d_name').innerHTML = escapeHtml(org.org_name)+(org.verified?' '+verifiedBadgeSm():'');
      var dt=$('#d_theme'); dt.textContent=org.theme; dt.classList.toggle('hidden',!org.theme);
      var di=$('#d_industry'); di.textContent=org.industry; di.classList.toggle('hidden',!org.industry);
      var dm=$('#d_members');
      if(org.member_count){ dm.classList.remove('hidden'); dm.querySelector('span').textContent=org.member_count; } else { dm.classList.add('hidden'); }

      setDescription(org.description);

      var linksHtml=socialRow(org);
      var linksCard=$('#panel-links-card');
      var extList=$('#d_extlinks');
      if(linksHtml){ extList.innerHTML=linksHtml; linksCard.setAttribute('data-has-links','true'); }
      else { extList.innerHTML=''; linksCard.setAttribute('data-has-links','false'); }
      if($('.tab-link[data-tab="overview"]').getAttribute('data-active')==='true' && linksCard.getAttribute('data-has-links')==='true'){ linksCard.classList.remove('hidden'); } else { linksCard.classList.add('hidden'); }

      $('#d_forms').innerHTML=org.forms.slice(0,8).map(formChip).join('');
      $('#d_emails').innerHTML=org.emails.slice(0,8).map(emailChip).join('');

  try{ renderWeeklyMeetingsForOrg(org); }catch(e){ console.warn('Events generation failed', e); }

      $('#openShare').onclick=function(e){ e.preventDefault(); openShareModal(org); };

      $all('.tab-link').forEach(function(btn){ btn.onclick=function(){ activateTab(btn.getAttribute('data-tab')); }; });
      activateTab('overview');

      renderRecommendations(org);
      showDetail();
    }

    // ---------- Share modal ----------
    function openShareModal(org){
      var url=location.href, title=org.org_name+' ‚Äî Activity Hub';
      $('#shareWhatsApp').setAttribute('href','https://wa.me/?text='+encodeURIComponent(title+' '+url));
      $('#shareLinkedIn').setAttribute('href','https://www.linkedin.com/sharing/share-offsite/?url='+encodeURIComponent(url));
      $('#shareX').setAttribute('href','https://twitter.com/intent/tweet?text='+encodeURIComponent(title)+'&url='+encodeURIComponent(url));
      $('#shareEmail').setAttribute('href','mailto:?subject='+encodeURIComponent(title)+'&body='+encodeURIComponent(url));
      $('#shareCopied').classList.add('hidden');
      $('#shareModal').classList.remove('hidden');
      document.addEventListener('keydown', escShareOnce);
    }
    function closeShareModal(){ $('#shareModal').classList.add('hidden'); document.removeEventListener('keydown', escShareOnce); }
    function escShareOnce(e){ if(e.key==='Escape') closeShareModal(); }

    // ---------- Get App modal ----------
    function openAppModal(){ $('#appSuccess').classList.add('hidden'); $('#appWaitlistForm').classList.remove('hidden'); $('#appModal').classList.remove('hidden'); var em=$('#appEmail'); if(em) em.focus(); document.addEventListener('keydown', escAppOnce); }
    function closeAppModal(){ $('#appModal').classList.add('hidden'); document.removeEventListener('keydown', escAppOnce); }
    function escAppOnce(e){ if(e.key==='Escape') closeAppModal(); }
    function saveEmailToWaitlist(email){
      try{ var KEY='ah_app_waitlist_v1'; var arr=JSON.parse(localStorage.getItem(KEY)||'[]'); if(arr.indexOf(email)===-1) arr.push(email); localStorage.setItem(KEY,JSON.stringify(arr)); }catch(e){}
    }

    // ---------- Routing & data ----------
    function showDirectory(){ document.title='Activity Hub ‚Äî Clubs'; $('#view-directory').classList.remove('hidden'); $('#view-detail').classList.add('hidden'); CURRENT=null; }
    function showDetail(){ $('#view-directory').classList.add('hidden'); $('#view-detail').classList.remove('hidden'); }
    function navigateToDetail(slug){
      if(!MAP.has(slug)) return;
      var url=new URL(location.href); url.searchParams.set('org',slug); history.pushState({org:slug},'',url);
      renderDetail(slug);
    }
    function routeFromURL(){
      var url=new URL(location.href);
      var slug=url.searchParams.get('org');
      var themeSlug=url.searchParams.get('theme');
      var kindParam=getKindFromParam();

      if(kindParam){ KIND=kindParam; tokenKind=KIND; updateSideActive(); renderTokens(); }

      if(slug && MAP.has(slug)){ renderDetail(slug); return; }

      showDirectory();

      if(themeSlug){ var val=findThemeBySlug(themeSlug); $('#filterTheme').value=val; ACTIVE_THEME=val; setThemeParam(val); }

      renderDirectory(VIEW.length?VIEW:RAW);
      applyFilters(); updatePillArrows();
    }

    function fetchJson(url){ return fetch(url,{headers:{Accept:'application/json'}}).then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }); }

    function renderSkeletons(n){
      var grid=$('#grid'), arr=[], i;
      for(i=0;i<(n||9);i++){
        arr.push('<article class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 p-4 shadow-subtle animate-pulse"><div class="flex items-start gap-3"><div class="w-14 h-14 rounded-xl bg-slate-200 dark:bg-slate-800"></div><div class="flex-1 space-y-2"><div class="h-4 w-2/3 rounded bg-slate-200 dark:bg-slate-800"></div><div class="h-3 w-5/6 rounded bg-slate-200 dark:bg-slate-800"></div><div class="flex gap-2 pt-1"><div class="h-5 w-20 rounded-full bg-slate-200 dark:bg-slate-800"></div><div class="h-5 w-20 rounded-full bg-slate-200 dark:bg-slate-800"></div></div></div></div></article>');
      }
      grid.innerHTML = arr.join('');
    }

    function loadData(){
      renderSkeletons();
      fetchJson(DATA_URL).then(function(data){
        var rows=Array.isArray(data)?data:(data&&data.rows?data.rows:[]);
        RAW=normalizeAll(rows);
        if(!RAW.length) throw new Error('Empty dataset');
        MAP=new Map(RAW.map(function(x){ return [x.slug,x]; }));
        hydrateThemeSelect(); hydrateIndustrySelect(RAW.map(function(r){ return r.industry; }));
        VIEW=RAW.slice();
        routeFromURL(); buildThemeChips(); initPillScroller();
        if(!$('#searchDropdown').classList.contains('hidden')) renderSearchDropdown();
      }).catch(function(err){
        console.error('Data load failed, using sample:',err);
        RAW=normalizeAll(JSON.parse(document.getElementById('sample-data').textContent));
        MAP=new Map(RAW.map(function(x){ return [x.slug,x]; }));
        hydrateThemeSelect(); hydrateIndustrySelect(RAW.map(function(r){ return r.industry; }));
        VIEW=RAW.slice();
        routeFromURL(); buildThemeChips(); initPillScroller();
        $('#feedback').textContent='Live API failed ‚Äî showing sample data.';
        if(!$('#searchDropdown').classList.contains('hidden')) renderSearchDropdown();
      });
    }

    // ---------- Tokens / pills in search ----------
    function renderTokens(){
      var row=$('#tokenRow'), html='';
      if(tokenKind){ html+='<span class="token-pill" data-token="kind"><span>'+ (KIND_LABEL[tokenKind]||'Kind') +'</span><button class="rm" title="Remove"><i class="fa-solid fa-xmark text-xs"></i></button></span>'; }
      if(tokenTheme){ html+='<span class="token-pill" data-token="theme"><span>'+escapeHtml(tokenTheme)+'</span><button class="rm" title="Remove"><i class="fa-solid fa-xmark text-xs"></i></button></span>'; }
      if(tokenIndustry){ html+='<span class="token-pill" data-token="industry"><span>'+escapeHtml(tokenIndustry)+'</span><button class="rm" title="Remove"><i class="fa-solid fa-xmark text-xs"></i></button></span>'; }
      row.innerHTML=html;
      $all('#tokenRow .token-pill .rm').forEach(function(btn){
        btn.addEventListener('click', function(){
          var type = btn.closest('.token-pill').getAttribute('data-token');
          if(type==='kind'){ tokenKind=null; }
          if(type==='theme'){ tokenTheme=''; $('#filterTheme').value=''; ACTIVE_THEME=''; setThemeParam(''); buildThemeChips(); }
          if(type==='industry'){ tokenIndustry=''; $('#filterIndustry').value=''; }
          applyFilters(); renderTokens(); renderSearchDropdown();
        });
      });
    }
    function getEffectiveKindFilter(){
      var q=$('#searchInput').value.trim();
      var anyBarTokens = !!(tokenTheme || tokenIndustry);
      if(tokenKind) return tokenKind;
      if(q || anyBarTokens) return null;
      return KIND;
    }

    // ---------- Search dropdown ----------
    var RECENT_KEY='ah_recent_queries_v1';
    function getRecent(){ try{ return JSON.parse(localStorage.getItem(RECENT_KEY)||'[]'); }catch(e){ return []; } }
    function addRecent(q){
      var val=(q||'').trim(); if(!val) return;
      var arr=getRecent().filter(function(x){ return x.toLowerCase()!==val.toLowerCase(); });
      arr.unshift(val); if(arr.length>8) arr=arr.slice(0,8);
      localStorage.setItem(RECENT_KEY, JSON.stringify(arr));
    }
    function clearRecent(){ localStorage.removeItem(RECENT_KEY); }

    function bindClubClicks(scope){
      $all('.opt-club', scope).forEach(function(a){
        function act(){
          var slug=a.getAttribute('data-slug');
          var kind=a.getAttribute('data-kind');
          var org=MAP.get(slug);
          if(org) addRecent(org.org_name);
          if(kind && ['organizations','businesses','projects'].indexOf(kind)>-1){ KIND=kind; setKindParam(KIND); updateSideActive(); }
          closeSearchDropdown(); navigateToDetail(slug);
        }
        a.addEventListener('click', function(e){ e.preventDefault(); act(); });
        a.addEventListener('keydown', function(e){ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); act(); } });
      });
    }
    function clubRowItem(org){
      var hasLogo=(org.logo_url && isValidHttpUrl(org.logo_url));
      var logo = hasLogo
        ? '<img class="avatar-sm ring-1 ring-slate-200 dark:ring-slate-800" src="'+escapeHtml(org.logo_url)+'" alt="'+escapeHtml(org.org_name)+' logo" onerror="this.style.display=\'none\'; this.nextElementSibling.classList.remove(\'hidden\');">'
        : '';
      var fallback = '<div class="avatar-fallback text-white '+(hasLogo?'hidden':'')+'" style="background:'+gradientForKey(org.slug)+';">'+initials(org.org_name)+'</div>';
      var nameHtml = escapeHtml(org.org_name)+(org.verified?' '+verifiedBadgeSm():'');
      var sub = escapeHtml(org.theme||'')+((org.theme&&org.industry)?' ¬∑ ':'')+escapeHtml(org.industry||'');
      var badge = KIND_LABEL[org.kind]||'';
      return '<a class="dd-row opt-club" href="?org='+org.slug+'" data-slug="'+org.slug+'" data-kind="'+org.kind+'" role="option" tabindex="0" aria-label="'+escapeHtml(org.org_name)+'">'+logo+fallback+'<div class="min-w-0"><div class="text-sm font-medium truncate">'+nameHtml+'</div><div class="text-xs text-slate-500 dark:text-slate-400 truncate">'+sub+'</div></div><span class="ml-auto text-[11px] px-2 py-0.5 rounded bg-slate-100 dark:bg-slate-800 border border-slate-200/60 dark:border-slate-700/60">'+badge+'</span></a>';
    }
    function pickPopular(n){
      var kFilter=getEffectiveKindFilter();
      var pool=kFilter?RAW.filter(function(r){ return r.kind===kFilter; }):RAW;
      if(!pool.length) return [];
      var copy=pool.slice();
      for(var i=copy.length-1;i>0;i--){ var j=Math.floor(Math.random()*(i+1)); var tmp=copy[i]; copy[i]=copy[j]; copy[j]=tmp; }
      return copy.slice(0, n||6);
    }
    function renderSearchDropdown(){
      var dd=$('#searchDropdown'), inner=$('#searchDropdownInner'), q=$('#searchInput').value.trim().toLowerCase();
      if(q===''){
        var recent=getRecent(), popular=pickPopular(6), html='';
        if(recent.length){
          html+='<div class="px-3 pt-2 pb-1 flex items-center justify-between"><div class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Recent</div><button id="clearRecentBtn" class="text-xs text-slate-500 hover:text-slate-700 dark:hover:text-slate-200">Clear</button></div>';
          html+='<div class="px-2 pb-2 flex flex-wrap gap-2">'+recent.slice(0,3).map(function(r){ return '<button class="opt-recent inline-flex items-center gap-1.5 h-7 px-3 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-200 text-[13px]" data-q="'+escapeHtml(r)+'"><i class="fa-solid fa-clock-rotate-left"></i><span>'+escapeHtml(r)+'</span></button>'; }).join('')+'</div>';
        }
        html+='<div class="px-3 pt-2 pb-1 text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Popular</div>';
        html+='<div class="px-2 pb-2" role="group"><div class="divide-y divide-slate-200 dark:divide-slate-800 border-t border-b border-slate-200 dark:border-slate-800">'+popular.map(clubRowItem).join('')+'</div></div>';
        inner.innerHTML=html; dd.classList.remove('hidden');
        var clearBtn=$('#clearRecentBtn'); if(clearBtn){ clearBtn.onclick=function(){ clearRecent(); renderSearchDropdown(); }; }
        $all('.opt-recent', inner).forEach(function(b){
          b.onclick=function(){ var val=b.getAttribute('data-q')||''; $('#searchInput').value=val; addRecent(val); renderSearchDropdown(); }; // grid applies on Enter
        });
        bindClubClicks(inner);
      }else{
        var kFilter=tokenKind;
        var base=kFilter?RAW.filter(function(r){ return r.kind===kFilter; }):RAW;
        var results=base.filter(function(r){
          var nameMatch=r.org_name.toLowerCase().indexOf(q)>-1;
          var themeMatch=(r.theme||'').toLowerCase().indexOf(q)>-1;
          var indMatch=(r.industry||'').toLowerCase().indexOf(q)>-1;
          return nameMatch||themeMatch||indMatch;
        }).slice(0,10);
        var html2='<div class="px-3 pt-2 pb-1 text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Top matches</div>';
        html2+='<div class="px-2 pb-2 space-y-1" role="group">'+(results.length?results.map(clubRowItem).join(''):'<div class="px-3 py-2 text-sm text-slate-500 dark:text-slate-400">No matches.</div>')+'</div>';
        inner.innerHTML=html2; dd.classList.remove('hidden'); bindClubClicks(inner);
      }
    }
    function openSearchDropdown(){ $('#searchDropdown').classList.remove('hidden'); }
    function closeSearchDropdown(){ $('#searchDropdown').classList.add('hidden'); }
    function debounce(fn,delay){ var t; return function(){ var args=arguments; clearTimeout(t); t=setTimeout(function(){ fn.apply(null,args); },delay); }; }

    // ---------- Apply filters ----------
    function applyFilters(){
      var q=$('#searchInput').value.trim().toLowerCase();
      var themeToken=tokenTheme, industryToken=tokenIndustry;
      var modalTheme=$('#filterTheme').value, modalIndustry=$('#filterIndustry').value;
      var activeTheme=themeToken||modalTheme;
      var activeIndustry=industryToken||modalIndustry;
      var kindFilter=getEffectiveKindFilter();

      VIEW=RAW.filter(function(x){
        if(kindFilter && x.kind!==kindFilter) return false;
        if(q){
          var hay=(x.org_name+' '+(x.theme||'')+' '+(x.industry||'')).toLowerCase();
          if(hay.indexOf(q)===-1) return false;
        }
        if(activeTheme && x.theme!==activeTheme) return false;
        if(activeIndustry && x.industry!==activeIndustry) return false;
        return true;
      });
      VIEW = sortView(VIEW);
      renderDirectory(VIEW); buildThemeChips(); updateSideActive();
      $('#countLabel').textContent=String(VIEW.length);
    }

    // ---------- Sort menu ----------
    function openSortMenu(){ $('#sortMenu').classList.remove('hidden'); $('#openSort').setAttribute('aria-expanded','true'); }
    function closeSortMenu(){ $('#sortMenu').classList.add('hidden'); $('#openSort').setAttribute('aria-expanded','false'); }
    function initSortMenu(){
      var btn=$('#openSort'), menu=$('#sortMenu');
      btn.addEventListener('click',function(e){ e.stopPropagation(); if(menu.classList.contains('hidden')) openSortMenu(); else closeSortMenu(); });
      $all('#sortMenu .sort-opt').forEach(function(opt){ opt.addEventListener('click',function(){ setSort(opt.getAttribute('data-sort')); }); });
      document.addEventListener('click',function(e){ if(!menu.classList.contains('hidden') && !btn.contains(e.target) && !menu.contains(e.target)) closeSortMenu(); });
      document.addEventListener('keydown',function(e){ if(e.key==='Escape') closeSortMenu(); });
      renderSortButton();
    }

    // ---------- Sidebar ----------
    function updateSideActive(){
  try{
    var dup = document.querySelector('#sideNav .side-link-duplicate'); // Events (dupe org)
    var org = document.querySelector('#sideNav .side-link[data-kind="organizations"]:not(.side-link-duplicate)');
    var biz = document.querySelector('#sideNav .side-link[data-kind="businesses"]');
    var proj = document.querySelector('#sideNav .side-link[data-kind="projects"]');

    document.querySelectorAll('#sideNav .side-link').forEach(function(b){ if(b) b.setAttribute('data-active','false'); });

    if (window.KIND === 'businesses' && biz) biz.setAttribute('data-active','true');
    if (window.KIND === 'projects' && proj) proj.setAttribute('data-active','true');

    if (window.KIND === 'organizations'){
      if (window.EVENT_LIST_MODE && dup) dup.setAttribute('data-active','true');
      else if (!window.EVENT_LIST_MODE && org) org.setAttribute('data-active','true');
    }
  }catch(e){ /* noop */ }
}
    function initSidebar(){
      updateSideActive();
      $all('#sideNav .side-link').forEach(function(b){
        b.addEventListener('click', function(){
          var k=b.getAttribute('data-kind'); if(!k) return;
          if(KIND===k && tokenKind===k) return;
          KIND=k; tokenKind=k; setKindParam(KIND); renderTokens(); applyFilters(); renderSearchDropdown(); updateSideActive();
        });
      });
    }

    // ---------- Filters modal ----------
    function openFilterModal(){
      var typeVal=(tokenKind===null?'global':tokenKind);
      $all('#filterType .chip-btn').forEach(function(btn){ btn.setAttribute('data-selected', btn.getAttribute('data-value')===typeVal?'true':'false'); });
      $('#filterTheme').value = tokenTheme || ACTIVE_THEME || '';
      $('#filterIndustry').value = tokenIndustry || '';
      $('#filterModal').classList.remove('hidden');
    }
    function closeFilterModal(){ $('#filterModal').classList.add('hidden'); }

    // ---------- Layout helpers ----------
    function syncHeaderOffset(){
      var spacer=$('#headerSpacer'), header=$('#siteHeader');
      if(!spacer||!header) return;
      var h=header.getBoundingClientRect().height;
      spacer.style.height=h+'px';
      document.documentElement.style.setProperty('--header-h', h+'px');
    }
    function syncThemeButton(){
      var btn=$('#toggleTheme');
      var isDark=document.documentElement.classList.contains('dark');
      btn.innerHTML = isDark ? '<i class="fa-solid fa-sun"></i><span>Light</span>' : '<i class="fa-solid fa-moon"></i><span>Dark</span>';
    }

    // ---------- Boot ----------
    window.addEventListener('DOMContentLoaded', function(){
  if (typeof window.EVENT_LIST_MODE==='undefined') window.EVENT_LIST_MODE=false;
  if (typeof window.NON_CLICK_LISTINGS==='undefined') window.NON_CLICK_LISTINGS=false;
  window.EVENT_LIST_MODE = !!window.EVENT_LIST_MODE;
  window.NON_CLICK_LISTINGS = !!window.NON_CLICK_LISTINGS;
  try{ updateSideActive(); }catch(e){}

      // Brand logo fallback without optional chaining
      var brandLogo = document.getElementById('brandLogo');
      if(brandLogo){
        brandLogo.addEventListener('error', function(){
          brandLogo.style.display='none';
          var f=document.getElementById('brandFallback'); if(f){ f.classList.remove('hidden'); }
        });
      }

      var root=document.documentElement;
      var stored=localStorage.getItem('ah_theme')||'light';
      if(stored==='dark') root.classList.add('dark'); else root.classList.remove('dark');
      syncThemeButton();
      $('#toggleTheme').addEventListener('click', function(){
        root.classList.toggle('dark'); localStorage.setItem('ah_theme', root.classList.contains('dark')?'dark':'light'); syncThemeButton();
      });

      var BETA_KEY='ah_beta_banner_v1';
      if(localStorage.getItem(BETA_KEY)!=='1'){ $('#betaBanner').classList.remove('hidden'); }
      $('#betaDismiss').addEventListener('click', function(){ localStorage.setItem(BETA_KEY,'1'); $('#betaBanner').classList.add('hidden'); syncHeaderOffset(); });

      syncHeaderOffset(); window.addEventListener('resize', syncHeaderOffset);

      renderTokens();

      // Search interactions (grid updates only on Enter)
      var input=$('#searchInput'), wrap=$('#searchWrap'), icon=$('#searchIcon');

      function setIconMode(){
        var focused=(document.activeElement===input);
        if(focused){
          icon.classList.remove('fa-magnifying-glass'); icon.classList.add('fa-filter');
          icon.setAttribute('data-mode','filter'); icon.setAttribute('title','Open filters');
        }else{
          icon.classList.remove('fa-filter'); icon.classList.add('fa-magnifying-glass');
          icon.removeAttribute('data-mode'); icon.removeAttribute('title');
        }
      }

      input.addEventListener('focus', function(){ setIconMode(); renderSearchDropdown(); openSearchDropdown(); });
      input.addEventListener('keydown', function(e){
        if(e.key==='Backspace' && input.selectionStart===0 && input.selectionEnd===0 && input.value===''){
          var pills=Array.prototype.slice.call($('#tokenRow').children);
          if(pills.length){
            var last=pills[pills.length-1].getAttribute('data-token');
            if(last==='industry'){ tokenIndustry=''; $('#filterIndustry').value=''; }
            else if(last==='theme'){ tokenTheme=''; $('#filterTheme').value=''; ACTIVE_THEME=''; setThemeParam(''); buildThemeChips(); }
            else if(last==='kind'){ tokenKind=null; }
            renderTokens(); renderSearchDropdown(); // grid will update on Enter
            e.preventDefault();
          }
        }else if(e.key==='Enter'){
          var first=$('#searchDropdownInner .opt-club');
          var q=input.value.trim();
          if(first){
            var slug=first.getAttribute('data-slug');
            var kind=first.getAttribute('data-kind');
            var org=MAP.get(slug);
            if(org) addRecent(org.org_name);
            if(kind && ['organizations','businesses','projects'].indexOf(kind)>-1){ KIND=kind; setKindParam(KIND); updateSideActive(); }
            closeSearchDropdown(); navigateToDetail(slug);
          }else{
            if(q){ addRecent(q); }
            closeSearchDropdown(); applyFilters();
          }
        }else if(e.key==='Escape'){ closeSearchDropdown(); }
      });
      input.addEventListener('input', debounce(function(){ renderSearchDropdown(); }, 120));

      icon.addEventListener('mousedown', function(e){
        if(icon.getAttribute('data-mode')==='filter'){ e.preventDefault(); openFilterModal(); closeSearchDropdown(); }
      });

      document.addEventListener('click', function(e){ if(!wrap.contains(e.target)){ closeSearchDropdown(); setIconMode(); } });
      input.addEventListener('blur', function(){ setTimeout(setIconMode,80); });

      // Filters modal wiring
      var filtOverlay=document.querySelector('[data-close="filter"]'); if(filtOverlay){ filtOverlay.addEventListener('click', closeFilterModal); }
      var filtClose=$('#filterClose'); if(filtClose){ filtClose.addEventListener('click', closeFilterModal); }
      $all('#filterType .chip-btn').forEach(function(btn){ btn.addEventListener('click', function(){ $all('#filterType .chip-btn').forEach(function(b){ b.setAttribute('data-selected','false'); }); btn.setAttribute('data-selected','true'); }); });
      var filtClear=$('#filterClear'); if(filtClear){ filtClear.addEventListener('click', function(){ tokenKind=null; tokenTheme=''; tokenIndustry=''; $('#filterTheme').value=''; $('#filterIndustry').value=''; ACTIVE_THEME=''; setThemeParam(''); renderTokens(); buildThemeChips(); /* do not apply yet */ }); }
      var filtApply=$('#filterApply'); if(filtApply){ filtApply.addEventListener('click', function(){
        var typeBtn=$('#filterType .chip-btn[data-selected="true"]'); var typeVal=typeBtn?typeBtn.getAttribute('data-value'):null;
        if(typeVal==='global'){ tokenKind=null; } else if(typeVal){ tokenKind=typeVal; }
        tokenTheme=$('#filterTheme').value||''; tokenIndustry=$('#filterIndustry').value||'';
        ACTIVE_THEME=tokenTheme||''; setThemeParam(ACTIVE_THEME);
        renderTokens(); buildThemeChips(); applyFilters(); renderSearchDropdown(); closeFilterModal();
      }); }

      // Brand root click
      var brandLink=document.getElementById('brandLink');
      if(brandLink){ brandLink.addEventListener('click', function(e){ e.preventDefault(); var url=new URL(location.href); url.searchParams.delete('org'); history.pushState({},'',url); showDirectory(); renderDirectory(VIEW.length?VIEW:RAW); }); }
      var backDir=$('#backToDirectory');
      if(backDir){ backDir.addEventListener('click', function(e){ e.preventDefault(); var url=new URL(location.href); url.searchParams.delete('org'); history.pushState({},'',url); showDirectory(); renderDirectory(VIEW.length?VIEW:RAW); }); }
      window.addEventListener('popstate', routeFromURL);

      // Share modal
      var shareClose=$('#shareClose'); if(shareClose){ shareClose.addEventListener('click', closeShareModal); }
      var shareOverlay=document.querySelector('[data-close="share"]'); if(shareOverlay){ shareOverlay.addEventListener('click', closeShareModal); }
      var shareCopyBtn=$('#shareCopy'); if(shareCopyBtn){ shareCopyBtn.addEventListener('click', function(){ var toCopy=location.href; if(navigator.clipboard && navigator.clipboard.writeText){ navigator.clipboard.writeText(toCopy).then(function(){ var msg=$('#shareCopied'); msg.classList.remove('hidden'); setTimeout(function(){ msg.classList.add('hidden'); }, 1200); }); } }); }

      // Get App modal
      var getAppBtn=$('#getAppBtn'); if(getAppBtn){ getAppBtn.addEventListener('click', function(e){ e.preventDefault(); openAppModal(); }); }
      var appClose=$('#appClose'); if(appClose){ appClose.addEventListener('click', closeAppModal); }
      var appOverlay=document.querySelector('[data-close="app"]'); if(appOverlay){ appOverlay.addEventListener('click', closeAppModal); }
      var appForm=$('#appWaitlistForm'); if(appForm){ appForm.addEventListener('submit', function(e){ e.preventDefault(); var emailEl=$('#appEmail'); var email=(emailEl.value||'').trim(); var ok=/^\S+@\S+\.\S+$/.test(email); if(!ok){ emailEl.focus(); emailEl.classList.add('ring-2','ring-rose-500'); setTimeout(function(){ emailEl.classList.remove('ring-2','ring-rose-500'); },900); return; } saveEmailToWaitlist(email); appForm.classList.add('hidden'); $('#appSuccess').classList.remove('hidden'); }); }

      initSortMenu(); initSidebar(); loadData();
    });

  })();
  </script>

<!-- Keyboard-nav highlight styles (injected) -->
<style>
  .kbd-active { outline: 2px solid rgba(59,130,246,.5); background: rgba(59,130,246,.08); }
  .dark .kbd-active { outline-color: rgba(96,165,250,.5); background: rgba(96,165,250,.1); }
</style>

<!-- Search keyboard navigation (injected) -->
<script>
(function(){
  var input  = document.getElementById('searchInput');
  var dd     = document.getElementById('searchDropdown');
  var inner  = document.getElementById('searchDropdownInner');
  if(!input || !dd || !inner) return;

  // --- Ctrl/Cmd + K to focus the search
  window.addEventListener('keydown', function(e){
    var mod = (navigator.platform || '').toLowerCase().includes('mac') ? e.metaKey : e.ctrlKey;
    if(mod && e.key.toLowerCase() === 'k'){
      e.preventDefault();
      input.focus();
    }
  });

  // --- Helpers
  function isOpen(){ return !dd.classList.contains('hidden'); }
  function items(){ return Array.prototype.slice.call(inner.querySelectorAll('.opt-club')); }

  // ARIA wiring (combobox + listbox)
  function syncAria(){
    input.setAttribute('role','combobox');
    input.setAttribute('aria-controls','searchDropdownInner');
    input.setAttribute('aria-expanded', String(isOpen()));
    dd.setAttribute('role','listbox');
    items().forEach(function(el, i){
      el.setAttribute('role','option');
      if(!el.id){
        var slug = el.getAttribute('data-slug') || ('row-'+i);
        el.id = 'opt-' + slug;
      }
      el.setAttribute('tabindex','-1');
    });
  }

  // Active row handling
  var activeIndex = -1;
  function highlight(i){
    var list = items();
    list.forEach(function(el, idx){
      var on = idx === i;
      el.classList.toggle('kbd-active', on);
      el.setAttribute('aria-selected', on ? 'true' : 'false');
      if(on){
        input.setAttribute('aria-activedescendant', el.id);
        try{ el.scrollIntoView({block:'nearest'}); }catch(e){}
      }
    });
    if(i < 0) input.removeAttribute('aria-activedescendant');
    activeIndex = i;
  }

  function resetAndEnhance(){
    activeIndex = -1;
    syncAria();
    highlight(-1);
  }

  // Watch the dropdown content
  var mo = new MutationObserver(function(){ resetAndEnhance(); });
  mo.observe(inner, { childList:true, subtree:true });

  // Keep aria-expanded synced
  var mo2 = new MutationObserver(function(){ input.setAttribute('aria-expanded', String(isOpen())); });
  mo2.observe(dd, { attributes:true, attributeFilter:['class'] });

  // Keyboard navigation on the input
  input.addEventListener('keydown', function(e){
    if(!isOpen()) return;
    var list = items();
    if(!list.length) return;

    if(e.key === 'ArrowDown'){
      e.preventDefault(); e.stopImmediatePropagation();
      var next = (activeIndex + 1) % list.length;
      highlight(next);
    }else if(e.key === 'ArrowUp'){
      e.preventDefault(); e.stopImmediatePropagation();
      var next = (activeIndex <= 0 ? list.length - 1 : activeIndex - 1);
      highlight(next);
    }else if(e.key === 'Enter' && activeIndex >= 0){
      e.preventDefault(); e.stopImmediatePropagation();
      var el = list[activeIndex];
      el.dispatchEvent(new KeyboardEvent('keydown', { key:'Enter', bubbles:true }));
    }else if(e.key === 'Escape'){
      highlight(-1);
      dd.classList.add('hidden');
      input.setAttribute('aria-expanded','false');
    }
  }, true);

  // Enhance after type/open
  input.addEventListener('input', function(){ /* observer will sync */ });
  input.addEventListener('focus', function(){ setTimeout(resetAndEnhance, 0); });

  // Initial sync
  resetAndEnhance();
})();
</script>


<script id="sideNavDelegatedHandler">
(function(){
  if (window.__SIDE_NAV_DELEGATED__) return;
  window.__SIDE_NAV_DELEGATED__ = true;

  function byId(id){ return document.getElementById(id); }
  var sideNav = byId('sideNav');
  if (!sideNav) return;

  sideNav.addEventListener('click', function(e){
    var btn = e.target.closest('.side-link');
    if (!btn || !sideNav.contains(btn)) return;
    var kind = btn.getAttribute('data-kind');
    if (!kind) return;

    var isDuplicateOrgs = btn.classList.contains('side-link-duplicate') && kind === 'organizations';
    window.IS_DUP_ORGS = isDuplicateOrgs;
    window.EVENT_LIST_MODE = isDuplicateOrgs;  // renders event-style cards
    window.NON_CLICK_LISTINGS = isDuplicateOrgs; // disables [data-nav] clicks
    try { window.KIND = kind; } catch(e){}

    sideNav.querySelectorAll('.side-link').forEach(function(el){ el.dataset.active = 'false'; });
    btn.dataset.active = 'true';

    if (typeof window.setKindParam === 'function') {
      try { window.setKindParam(kind); } catch(e){}
    }

    if (typeof window.applyFilters === 'function') {
      try { window.applyFilters(); } catch(e){}
    } else if (typeof window.renderDirectory === 'function' && typeof window.sortView === 'function' && Array.isArray(window.VIEW)) {
      try { window.renderDirectory(window.sortView(window.VIEW)); } catch(e){}
    }
  });
})();
</script>



<!-- Auto-injected patch to enforce 'Events' non-clickable mode -->
<script>
(function(){
  function onReady(fn){ if(document.readyState!=='loading'){ fn(); } else { document.addEventListener('DOMContentLoaded', fn); } }

  onReady(function(){
    // Helper to toggle grid non-clickable UI
    function syncNonClickUI(){
      var grid = document.getElementById('grid');
      if(grid){ grid.classList.toggle('non-clickable', !!window.NON_CLICK_LISTINGS); }
    }

    // 1) Wire first Organizations (clickable) vs second "Events" (non-click, event-styled)
    var firstOrgBtn = document.querySelector('button.side-link[data-kind="organizations"]');
    var dupBtn = document.querySelector('button.side-link-duplicate');

    if (dupBtn){
      // Rename at runtime too (belt & suspenders)
      try {
        // Replace text "Organizations" -> "Events" within the button
        dupBtn.querySelectorAll('*').forEach(function(n){
          if(n.childNodes && n.childNodes.length){
            n.childNodes.forEach(function(c){
              if(c.nodeType===3){ c.nodeValue = c.nodeValue.replace(/Organizations/ig, 'Events'); }
            });
          }
        });
        if(dupBtn.textContent.trim().match(/Organizations/i)){
          dupBtn.textContent = 'Events';
        }
        dupBtn.setAttribute('aria-label', 'Events');
      } catch(e){ /* noop */ }

      dupBtn.addEventListener('click', function(){
        window.EVENT_LIST_MODE = true;       // switch renderer to event-style
        window.NON_CLICK_LISTINGS = true;    // disable navigation on cards
        try { if (typeof setKindParam === 'function') setKindParam('organizations'); } catch(e){}
        try { if (typeof applyFilters === 'function') applyFilters(); else if (typeof renderDirectory === 'function') renderDirectory(); } catch(e){}
        syncNonClickUI();
      });
    }

    if (firstOrgBtn){
      firstOrgBtn.addEventListener('click', function(){
        window.EVENT_LIST_MODE = false;      
        window.NON_CLICK_LISTINGS = false;   
        try { if (typeof setKindParam === 'function') setKindParam('organizations'); } catch(e){}
        try { if (typeof applyFilters === 'function') applyFilters(); else if (typeof renderDirectory === 'function') renderDirectory(); } catch(e){}
        syncNonClickUI();
      });
    }

    // 2) Global click guard: block navigation when NON_CLICK_LISTINGS is true
    document.addEventListener('click', function(e){
      if (window.NON_CLICK_LISTINGS){
        var target = e.target.closest('[data-nav]');
        if (target){
          e.preventDefault();
          e.stopPropagation();
          return false;
        }
      }
    }, true); // capture phase to beat other handlers

    // 3) Also patch any binding routine that might add click handlers after render
    // Provide a safe wrapper to (re)bind card handlers only if clickable
    window.__bindCardClicksSafely = function(){
      try {
        var nodes = document.querySelectorAll('#grid [data-nav]');
        nodes.forEach(function(a){
          // Remove any previously bound inline onclick to be safe in non-click mode
          if (window.NON_CLICK_LISTINGS){
            a.onclick = null;
          } else {
            a.addEventListener('click', function(ev){
              ev.preventDefault();
              var slug = a.getAttribute('data-nav');
              if (typeof navigateToDetail === 'function') navigateToDetail(slug);
            }, { once: true });
          }
        });
      } catch(e){ /* noop */ }
    };

    // Run once on load
    syncNonClickUI();
  });
})();
</script>
<style>
  /* Ensure visual non-click state if class is present */
  #grid.non-clickable [data-nav] { pointer-events: none; cursor: default; }
</style>



<script id="ah-events-core">
(function(){
  // Helper: HTML escape
  if (typeof window.escapeHtml !== 'function'){
    window.escapeHtml = function(str){
      if (str == null) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    };
  }

  // Build a single event-style card
  window.eventCardFromOrg = function(org){
    org = org || {};
    var name = window.escapeHtml(org.org_name || org.name || 'Organization');
    var logo = org.logo_url || org.logo || '';
    var range = (window.SJU_SEMESTER_START && window.SJU_SEMESTER_END)
      ? 'from ' + window.escapeHtml(window.SJU_SEMESTER_START) + ' to ' + window.escapeHtml(window.SJU_SEMESTER_END)
      : 'from the beginning to the end of the St. John‚Äôs semester';
    var logoHTML = logo
      ? '<img class="ah-event-logo" src="'+ window.escapeHtml(logo) +'" alt="Logo">'
      : '<div class="ah-event-logo" style="display:grid;place-items:center;font-weight:600;">'+ name.charAt(0) +'</div>';

    return '' +
      '<div class="ah-event-card">' +
        '<div class="ah-event-left">' +
          logoHTML +
          '<div class="min-w-0">' +
            '<div class="ah-event-title">'+ name +'</div>' +
            '<div class="ah-event-subtle"><i class="fa-regular fa-clock" aria-hidden="true"></i> Mondays & Thursdays at 1:50 PM</div>' +
            '<div class="ah-event-subtle"><i class="fa-regular fa-calendar-days" aria-hidden="true"></i> Weekly recurring meeting ' + range + '</div>' +
          '</div>' +
        '</div>' +
        '<div class="ah-event-right"></div>' +
      '</div>';
  };

  function buildHTMLFromList(list){
    return (list || []).map(window.eventCardFromOrg).join('');
  }

  window.transformGridToEventListings = function(list){
    var grid = document.getElementById('grid');
    if (!grid) return;
    var html = buildHTMLFromList(list);
    if (!html){
      // Fallback: derive from current DOM
      var nodes = Array.from(grid.children);
      html = nodes.map(function(node){
        var img = node.querySelector('img'); var src = img ? img.getAttribute('src') : '';
        var nameEl = node.querySelector('[data-org-name], .org-name, h3, h4, .title, .name');
        var nm = nameEl ? nameEl.textContent.trim() : (node.textContent||'').trim().split('\\n').map(function(s){return s.trim();}).filter(Boolean)[0] || 'Organization';
        return window.eventCardFromOrg({ org_name: nm, logo_url: src });
      }).join('');
    }
    grid.innerHTML = html;
    grid.classList.add('non-clickable');
  };

  // Hook re-renderers if present so Events mode always transforms
  var _apply = window.applyFilters;
  if (typeof _apply === 'function'){
    window.applyFilters = function(){
      _apply.apply(this, arguments);
      if (window.EVENT_LIST_MODE) window.transformGridToEventListings(window.__LAST_DIRECTORY_LIST);
    };
  }
  var _render = window.renderDirectory;
  if (typeof _render === 'function'){
    window.renderDirectory = function(){
      _render.apply(this, arguments);
      if (window.EVENT_LIST_MODE) window.transformGridToEventListings(window.__LAST_DIRECTORY_LIST);
    };
  }
})();
</script>

<script>
(function(){
  function handleSideNavClicks(e){
    var btn = e.target.closest('#sideNav .side-link');
    if (!btn) return;
    var kind = btn.getAttribute('data-kind');
    if (!kind) return;
    // Toggle Events mode only when the duplicate orgs (Events) button is clicked
    var isDupe = btn.classList.contains('side-link-duplicate');
    window.KIND = kind; // keep underlying kind filter
    window.EVENT_LIST_MODE = isDupe; // true for Events, false for normal Organizations
    window.NON_CLICK_LISTINGS = isDupe; // non-clickable in Events mode
    try{ updateSideActive(); }catch(e){}
    // re-render
    try{
      if (typeof renderDirectory==='function'){
        renderDirectory(window.VIEW && window.VIEW.length ? window.VIEW : window.RAW);
      }
      if (typeof applyFilters==='function'){ applyFilters(); }
    }catch(e){ /* noop */ }
    // Token pill refresh
    try{ if (typeof renderTokens==='function') renderTokens(); }catch(e){}
  }
  document.addEventListener('click', handleSideNavClicks);
})();
</script>


<script>
(function () {
  function qs(sel, root=document){ return root.querySelector(sel); }
  function qsa(sel, root=document){ return Array.from(root.querySelectorAll(sel)); }

  var sideNav = qs('#sideNav') || qs('[data-role="side-nav"]') || qs('.ah-side-nav');
  var grid = qs('#grid') || qs('[data-role="grid"]') || qs('.ah-grid');

  // Global flags (normalize)
  window.EVENT_LIST_MODE = !!window.EVENT_LIST_MODE;
  window.NON_CLICK_LISTINGS = !!window.NON_CLICK_LISTINGS;
  window.UI_KIND_LABEL = window.UI_KIND_LABEL || '';

  // --- 1) Skip skeleton when navigating to detail view ---
  function markSkipSkeletonForNextNavigation(){
    try { sessionStorage.setItem('ah_skip_skeleton_once','1'); } catch(e){}
  }
  function shouldSkipSkeleton(){
    try { if (sessionStorage.getItem('ah_skip_skeleton_once') === '1') return true; } catch(e){}
    return /[?&#](org|id|slug|view)=/i.test(location.search + location.hash);
  }

  document.addEventListener('click', function (e) {
    var a = e.target.closest('a');
    if (!a) return;
    if (window.NON_CLICK_LISTINGS) { e.preventDefault(); return; }
    if (a.matches('a.card-link, .org-card a, a[data-nav="detail"], a[href*="org="], a[href*="id="], a[href*="slug="]')) {
      markSkipSkeletonForNextNavigation();
    }
  }, true);

  if (!window.__ah_showSkeleton_wrapped && typeof window.showSkeleton === 'function') {
    window.__ah_showSkeleton_wrapped = true;
    var _show = window.showSkeleton;
    window.showSkeleton = function(){
      if (shouldSkipSkeleton()){
        try { sessionStorage.removeItem('ah_skip_skeleton_once'); } catch(e){}
        return;
      }
      return _show.apply(this, arguments);
    };
  } else {
    if (shouldSkipSkeleton()){
      try {
        var skel = qs('#skeleton, .ah-skeleton');
        if (skel) skel.style.display = 'none';
        sessionStorage.removeItem('ah_skip_skeleton_once');
      } catch(e){}
    }
  }

  // --- 2) Auto-select "Organizations" on first load ---
  function selectDefaultKindIfNone(){
    if (!sideNav) return;
    var active = sideNav.querySelector('.side-link[data-active="true"]');
    if (!active){
      var orgBtn = sideNav.querySelector('.side-link[data-kind="organizations"]:not(.side-link-duplicate)')
                || sideNav.querySelector('.side-link[data-kind="organizations"]')
                || sideNav.querySelector('.side-link');
      if (orgBtn) orgBtn.setAttribute('data-active','true');
    }
    try {
      if (typeof setKindParam === 'function') setKindParam('organizations');
      else window.KIND = 'organizations';
    } catch(e){}
    window.EVENT_LIST_MODE = false;
    window.NON_CLICK_LISTINGS = false;
    if (grid && grid.classList) grid.classList.remove('non-clickable');
    try {
      if (typeof applyFilters === 'function') applyFilters();
      else if (typeof renderDirectory === 'function') renderDirectory();
      if (typeof renderTokens === 'function') renderTokens();
    } catch(e){}
    try { sessionStorage.removeItem('ah_skip_skeleton_once'); } catch(e){}
  }
  window.addEventListener('DOMContentLoaded', selectDefaultKindIfNone);

  // --- 3) Properly switch away from Events duplicate mode ---
  function setEventsDuplicateMode(on){
    window.EVENT_LIST_MODE = !!on;
    window.NON_CLICK_LISTINGS = !!on;
    window.UI_KIND_LABEL = on ? 'Events' : '';
    if (grid && grid.classList) grid.classList.toggle('non-clickable', !!on);
  }

  if (sideNav){
    sideNav.addEventListener('click', function(e){
      var btn = e.target.closest('.side-link');
      if (!btn) return;
      qsa('.side-link', sideNav).forEach(b => b.setAttribute('data-active','false'));
      btn.setAttribute('data-active','true');

      var isEventsDup = btn.classList.contains('side-link-duplicate') ||
                        btn.getAttribute('data-mode') === 'events-duplicate' ||
                        (btn.textContent||'').trim().toLowerCase() === 'events' && (btn.getAttribute('data-kind')||'').toLowerCase() === 'organizations';

      if (isEventsDup){
        setEventsDuplicateMode(true);
        try { (typeof setKindParam === 'function') ? setKindParam('organizations') : (window.KIND='organizations'); } catch(e){}
      } else {
        setEventsDuplicateMode(false);
        var k = btn.getAttribute('data-kind') || 'organizations';
        try { (typeof setKindParam === 'function') ? setKindParam(k) : (window.KIND = k); } catch(e){}
      }

      try {
        if (typeof applyFilters === 'function') applyFilters();
        else if (typeof renderDirectory === 'function') renderDirectory();
        if (typeof renderTokens === 'function') renderTokens();
      } catch(err){}
    });
  }

  // --- 4) Ensure anchors reflect clickability ---
  function decorateListingAnchor(a){
    if (!a) return;
    if (!a.hasAttribute('data-href') && a.hasAttribute('href')) {
      a.setAttribute('data-href', a.getAttribute('href'));
    }
    if (window.NON_CLICK_LISTINGS){
      a.removeAttribute('href');
      a.setAttribute('tabindex','-1');
      a.classList.add('pointer-events-none','cursor-default');
    } else {
      var href = a.getAttribute('data-href');
      if (href) a.setAttribute('href', href);
      a.removeAttribute('tabindex');
      a.classList.remove('pointer-events-none','cursor-default');
    }
  }
  function refreshAnchors(){
    if (!grid) return;
    qsa('a', grid).forEach(decorateListingAnchor);
  }
  if (grid && window.MutationObserver){
    var mo = new MutationObserver(function(){ refreshAnchors(); });
    mo.observe(grid, {childList:true, subtree:true});
    refreshAnchors();
  }

  // --- 5) Token label helper so Events shows "Events", not "Orgs" ---
  window.getKindTokenLabel = window.getKindTokenLabel || function(kindKey){
    var map = {organizations:'Orgs', businesses:'Businesses', projects:'Projects'};
    return window.UI_KIND_LABEL || map[kindKey] || 'Orgs';
  };
})();
</script>


<script>
(function(){
  function qs(s,r){return (r||document).querySelector(s);}
  function qsa(s,r){return Array.from((r||document).querySelectorAll(s));}
  var grid = qs('#grid') || qs('[data-role="grid"]') || qs('.ah-grid') || document.body;

  function markDetailNavInProgress(){
    try { sessionStorage.setItem('ah_skip_skeleton_once','1'); } catch(e){}
    document.body.classList.add('ah-skip-skeleton');
    // If a global showSkeleton exists, ensure it's no-op while class is present
    if (typeof window.showSkeleton === 'function' && !window.__ah_showSkeleton_safelock){
      window.__ah_showSkeleton_safelock = true;
      var _show = window.showSkeleton;
      window.showSkeleton = function(){
        if (document.body.classList.contains('ah-skip-skeleton')) return;
        return _show.apply(this, arguments);
      };
    }
  }

  // Fire earlier than 'click'
  ['pointerdown','mousedown','touchstart'].forEach(function(type){
    document.addEventListener(type, function(e){
      var a = e.target && e.target.closest && e.target.closest('a');
      if (!a) return;
      // ignore if in non-clickable mode
      if (window.NON_CLICK_LISTINGS) { e.preventDefault(); return; }
      if (a.matches('a.card-link, .org-card a, a[data-nav="detail"], a[href*="org="], a[href*="id="], a[href*="slug="]')) {
        markDetailNavInProgress();
      }
    }, true);
  });

  // After the new page is ready, remove skip class (if it persisted due to SPA)
  window.addEventListener('pageshow', function(){
    document.body.classList.remove('ah-skip-skeleton');
    try { sessionStorage.removeItem('ah_skip_skeleton_once'); } catch(e){}
  });

  // --------- Ensure clickable layout when leaving Events duplicate ---------
  function restoreClickableLayoutNow(){
    // reset global flags defensively
    window.EVENT_LIST_MODE = false;
    window.NON_CLICK_LISTINGS = false;
    window.UI_KIND_LABEL = '';
    // remove any "non-clickable" class on probable containers
    qsa('.non-clickable').forEach(function(el){ el.classList.remove('non-clickable'); });
    // restore anchors anywhere under grid/cards
    function restoreAnchor(a){
      if (!a) return;
      var href = a.getAttribute('data-href');
      if (href && !a.getAttribute('href')) a.setAttribute('href', href);
      a.removeAttribute('tabindex');
      a.classList.remove('pointer-events-none','cursor-default');
    }
    var grid = document.querySelector('#grid') || document.querySelector('[data-role="grid"]') || document.querySelector('.ah-grid') || document.body;
    qsa('a', grid).forEach(restoreAnchor);
  }
  window.AH_restoreClickableLayoutNow = restoreClickableLayoutNow;

  // Listen for nav clicks late in the bubbling phase to ensure we run even if other handlers fire
  var sideNav = qs('#sideNav') || qs('[data-role="side-nav"]') || qs('.ah-side-nav');
  if (sideNav){
    sideNav.addEventListener('click', function(e){
      var btn = e.target.closest('.side-link');
      if (!btn) return;
      var isEventsDup = btn.classList.contains('side-link-duplicate') ||
                        btn.getAttribute('data-mode') === 'events-duplicate' ||
                        ((btn.textContent||'').trim().toLowerCase() === 'events' &&
                         (btn.getAttribute('data-kind')||'').toLowerCase() === 'organizations');
      if (!isEventsDup){
        // Switching away from Events: immediately restore layout & links
        restoreClickableLayoutNow();
        var gridEl=document.getElementById('grid'); if(gridEl){ gridEl.classList.remove('non-clickable'); }
        // Try a re-render if available so the markup matches the chosen kind's template
        try {
          if (typeof applyFilters === 'function') applyFilters();
          else if (typeof renderDirectory === 'function') renderDirectory();
        } catch(e){}
      }
    }, false);
  }

  // Also restore layout on history changes or programmatic kind switches
  window.addEventListener('popstate', function(){
    if (!window.EVENT_LIST_MODE) restoreClickableLayoutNow();
        var gridEl=document.getElementById('grid'); if(gridEl){ gridEl.classList.remove('non-clickable'); }
  });

  // Observe the whole document, so even if the grid id/class changes, we re-enable anchors
  if (window.MutationObserver){
    var mo = new MutationObserver(function(){
      if (!window.EVENT_LIST_MODE) {
        restoreClickableLayoutNow();
        var gridEl=document.getElementById('grid'); if(gridEl){ gridEl.classList.remove('non-clickable'); }
      }
    });
    mo.observe(document.body, {childList:true, subtree:true});
  }
})();
</script>


<!-- BEGIN: Immediate reset when leaving Events mode -->
<script>
(function () {
  const $ = (s, r = document) => r.querySelector(s);
  const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));

  function leaveEventsModeNow() {
    try {
      // 1) Reset global toggles used by the Events-only view
      window.EVENT_LIST_MODE = false;
      window.NON_CLICK_LISTINGS = false;
      window.UI_KIND_LABEL = null; // let token pill fall back to normal labels

      // 2) Remove any classes that force non-click behavior / Events styling
      document.documentElement.classList.remove('ah-events-mode', 'ah-non-click');
      document.body.classList.remove('ah-events-mode', 'ah-non-click', 'non-clickable');

      // 3) Restore anchors that were disabled in Events mode
      $$('#results a[data-original-href], #resultsGrid a[data-original-href], #grid a[data-original-href], .listing-card a[data-original-href]')
        .forEach(a => {
          const orig = a.getAttribute('data-original-href');
          if (orig && !a.hasAttribute('href')) a.setAttribute('href', orig);
          a.removeAttribute('data-original-href');
          a.removeAttribute('aria-disabled');
          a.removeAttribute('tabindex');
          a.classList.remove('no-pointer', 'disabled', 'non-click');
        });

      // 4) Clear any pointer-blocking classes that might linger on cards/rows
      $$('#results .listing, #resultsGrid .listing, #grid .listing, .listing-card, .card')
        .forEach(el => el.classList.remove('pointer-events-none', 'non-click', 'eventified'));
    } catch (err) {
      // Don't break the app; just log
      console.warn('[leaveEventsModeNow] failed:', err);
    }
  }

  // Run BEFORE existing browse handlers so UI is reset immediately
  document.addEventListener('click', function (e) {
    const btn = e.target.closest('#sideNav .side-link, [data-kind], [data-mode]');
    if (!btn) return;

    // Detect Events buttons (duplicate Orgs acting as Events, or dedicated Events)
    const isEvents =
      btn.matches('[data-events="true"], [data-kind="events"], [data-mode="events"], [data-kind="organizations-events"]') ||
      /events/i.test(btn.getAttribute('aria-label') || '') ||
      /events/i.test(btn.textContent || '');

    if (!isEvents) {
      // Leaving Events: reset immediately so the next render paints the correct, clickable layout
      leaveEventsModeNow();
    }
  }, true); // capture=true to run before delegated handlers

  // Extra safety: wrap renderDirectory so it enforces clickable state when not in Events
  if (typeof window.renderDirectory === 'function' && !window.__PATCHED_RD__) {
    const _renderDirectory = window.renderDirectory;
    window.renderDirectory = function () {
      if (!window.EVENT_LIST_MODE) leaveEventsModeNow();
      return _renderDirectory.apply(this, arguments);
    };
    window.__PATCHED_RD__ = true;
  }

  // Optional: if you have a central "selectKind" or router, call leaveEventsModeNow()
  // whenever nextKind !== 'events'.
})();
</script>
<!-- END: Immediate reset when leaving Events mode -->

<!-- Mobile grid fix: ensure loaded listings follow skeleton responsiveness -->
<style>
/* On small screens, force single-column grid to match skeleton loader */
@media (max-width: 640px){
  #grid.cards-grid{ grid-template-columns: 1fr !important; }
  /* Prevent overflow that can force a second column */
  .ah-event-card, .ah-event-left, .ah-event-right,
  .org-card, .org-card * { min-width: 0; }
}
/* Slightly relax min width at ~380px to avoid overflow on very narrow phones */
@media (max-width: 380px){
  #grid.cards-grid{ grid-template-columns: 1fr !important; }
}
</style>
<script>
// Runtime guard: enforce single column on narrow widths even if other CSS wins specificity
(function(){
  function enforceResponsiveGrid(){
    try{
      var g = document.getElementById('grid');
      if(!g) return;
      var vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
      if (vw <= 640){
        g.style.gridTemplateColumns = '1fr';
      } else {
        g.style.gridTemplateColumns = '';
      }
    }catch(e){}
  }
  // Run on load + resize + after directory renders if available
  document.addEventListener('DOMContentLoaded', enforceResponsiveGrid);
  window.addEventListener('resize', enforceResponsiveGrid);
  if (typeof window.renderDirectory === 'function' && !window.__gridFixWrapped){
    var _rd = window.renderDirectory;
    window.renderDirectory = function(){
      var r = _rd.apply(this, arguments);
      enforceResponsiveGrid();
      return r;
    };
    window.__gridFixWrapped = true;
  }
  // Observe grid size changes
  try{
    if (window.ResizeObserver){
      var ro = new ResizeObserver(enforceResponsiveGrid);
      var g = document.getElementById('grid');
      if (g) ro.observe(g);
    }
  }catch(e){}
})();
</script>

</body>
</html>

<!-- Events pill label + two-way format switching hard fix -->
<script>
(function(){
  function onReady(fn){ if(document.readyState!=='loading'){ fn(); } else { document.addEventListener('DOMContentLoaded', fn); } }

  // Safely update the "kind" token pill label based on Events mode
  function updateKindPillLabel(){
    try {
      var pill = document.querySelector('.token-pill[data-token="kind"] span:first-child');
      if (!pill) return;
      if (window.EVENT_LIST_MODE === true) {
        pill.textContent = 'Events';
      } else {
        // Fall back to Organizations (or existing KIND_LABEL if available)
        var orgLabel = (window.KIND_LABEL && window.KIND_LABEL.organizations) ? window.KIND_LABEL.organizations : 'Organizations';
        pill.textContent = orgLabel;
      }
    } catch(e){ /* noop */ }
  }

  // Monkey-patch renderTokens to always enforce the label after token render
  function patchRenderTokens() {
    if (typeof window.renderTokens === 'function' && !window.renderTokens.__eventsPatched) {
      var orig = window.renderTokens;
      window.renderTokens = function(){
        var r = orig.apply(this, arguments);
        try { updateKindPillLabel(); } catch(_){}
        return r;
      };
      window.renderTokens.__eventsPatched = true;
    }
  }

  // Force-toggle helpers
  function forceEventMode(enabled){
    window.EVENT_LIST_MODE = !!enabled;
    window.NON_CLICK_LISTINGS = !!enabled;
    // Keep a UI label in case the app reads it
    window.UI_KIND_LABEL = enabled ? 'Events' : null;
  }

  // Re-render directory using the freshest available list
  function rerenderDirectory(){
    try {
      if (typeof window.applyFilters === 'function') {
        window.applyFilters();
        return;
      }
    } catch(_){}
    try {
      var base = (window.VIEW && window.VIEW.length) ? window.VIEW : (window.RAW || []);
      if (typeof window.renderDirectory === 'function') window.renderDirectory(base);
    } catch(_){}
  }

  // Apply or remove the event-style transform
  function applyGridModeAccordingToFlag(){
    try {
      var list = (window.VIEW && window.VIEW.length) ? window.VIEW :
                 (Array.isArray(window.__LAST_DIRECTORY_LIST) ? window.__LAST_DIRECTORY_LIST :
                 (window.RAW || []));
      if (window.EVENT_LIST_MODE && typeof window.transformGridToEventListings === 'function') {
        window.transformGridToEventListings(list);
      }
      // If not in events mode, simply re-render ensures org-style cards (clickable)
      // (Already handled by rerenderDirectory before calling this)
    } catch(_){}
  }

  // Keep URL kind consistent (we don't force a special mode param here)
  function setKindToOrganizationsInState(){
    try {
      if (typeof window.setKindParam === 'function') {
        window.setKindParam('organizations');
      } else {
        window.KIND = 'organizations';
        // best-effort URL update
        var u = new URL(location.href);
        u.searchParams.set('kind','organizations');
        history.replaceState(null,'',u);
      }
    } catch(_){}
  }

  onReady(function(){
    // Ensure token label stays correct whenever tokens are rendered
    patchRenderTokens();

    // Initial post-load label sanity
    setTimeout(updateKindPillLabel, 0);

    // One unified capture listener to handle both directions
    var side = document.getElementById('sideNav') || document.querySelector('[data-role="side-nav"]') || document.querySelector('.ah-side-nav') || document.body;
    side.addEventListener('click', function(e){
      var btn = e.target && e.target.closest ? e.target.closest('.side-link, [data-kind], [data-mode]') : null;
      if (!btn) return;

      var dataKind = (btn.getAttribute('data-kind')||'').toLowerCase();
      var dataMode = (btn.getAttribute('data-mode')||'').toLowerCase();
      var txt = (btn.textContent||'').trim().toLowerCase();

      // Heuristic: duplicate Events under Organizations (your "Events" path)
      var isEventsDup = btn.classList.contains('side-link-duplicate') ||
                        dataMode === 'events-duplicate' ||
                        (txt.indexOf('events') > -1 && dataKind === 'organizations');

      // Heuristic: plain Organizations (normal orgs view)
      var isOrgs = (dataKind === 'organizations' && !isEventsDup) ||
                   (txt.indexOf('organizations') > -1 && !isEventsDup);

      if (isEventsDup) {
        // Switch to Events view (immediately, first click included)
        forceEventMode(true);
        setKindToOrganizationsInState();     // Events is a sub-view of orgs
        rerenderDirectory();
        applyGridModeAccordingToFlag();
        try { if (typeof window.renderTokens === 'function') window.renderTokens(); } catch(_){}
        try { updateKindPillLabel(); } catch(_){}
        return;
      }

      if (isOrgs) {
        // Switch back to Organizations view (ensure format updates immediately)
        forceEventMode(false);
        setKindToOrganizationsInState();
        rerenderDirectory();                 // rebuild grid as org cards
        // No transform ‚Äî leaving Events mode should remove event styling
        try { if (typeof window.renderTokens === 'function') window.renderTokens(); } catch(_){}
        try { updateKindPillLabel(); } catch(_){}
        return;
      }
    }, true); // capture so we run before other handlers
  });
})();
</script>
